<!DOCTYPE html>
<html lang="zh">
<head>

        <title>Yii源码阅读笔记 - 错误/异常处理</title>
        <meta charset="utf-8" />
        <link href="http://youngsterxyf.github.io/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="黑·白 Full Atom Feed" />
        <link href="http://youngsterxyf.github.io/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="黑·白 Full RSS Feed" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="../../../../theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="../../../../theme/style.css" />
        <link rel="stylesheet" type="text/css" href="../../../../theme/pygment.css" />
        <link rel="stylesheet" type="text/css" href="../../../../theme/SentyZHAO/SentyZHAO.css" />

        <script src="../../../../theme/js/libs/jquery-1.9.1.min.js"></script>
        <script src="../../../../theme/js/libs/modernizr-2.6.2.min.js"></script>
            <script>
              var _hmt = _hmt || [];
              (function() {
                var hm = document.createElement("script");
                hm.src = "//hm.baidu.com/hm.js?5c5d8c3fe75afeff117777b9236b96ec";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
              })();
            </script>
</head>

<body id="index" class="home">
    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1 style='font-family: "SentyZHAO";'><a href="../../../..">黑·白 <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>

              <ul class="columns" style='font-family: "SentyZHAO";'>
                <li><a href="../../../..">主 页</a></li>

                <li><a href="/archives.html">归 档</a></li>
                <li><a href="/tags.html">标 签</a></li>
                <li><a href="/pages/tools.html">工具集</a></li>
                <li><a href="/pages/links.html">链 接</a></li>
                <li><a href="/pages/tech-share.html">技术分享</a></li>
                <li><a href="/pages/aboutme.html">关于我</a></li>
                <li><a href="/feeds/rss.xml">RSS</a></li>

              </ul>
            </div>

<section id="content" class="body">
   <div class="row">
        <div class="columns">
            <header>
              <h2 class="entry-title">
                <a href="../../../../2015/09/14/read-yii-code-10/" rel="bookmark" title="Permalink to Yii源码阅读笔记 - 错误/异常处理">Yii源码阅读笔记 - 错误/异常处理</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2015-09-14T00:00:00+08:00">
                2015-09-14 一
              </abbr>
              <address class="vcard author">
                By <a class="url fn" href="../../../../author/youngsterxyf.html">youngsterxyf</a>
              </address>
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <h3>概述</h3>
<p>PHP区分“错误”（Error）和“异常”（Exception）。“错误”通常是由PHP内部函数抛出，表示运行时问题，当然也可以通过函数trigger_error或user_error抛出一个用户级别的error/warning/notice信息。但在引入面向对象之后，相比使用trigger_error抛出错误，使用throw抛出异常更常用。</p>
<p>对于“错误”，PHP允许配置报告哪些级别/类型错误、是否（向用户）展示错误、是否对错误记录日志、错误日志记到哪，分别对应php.ini中的配置项：error_reporting、display_errors、log_errors、error_log。详细信息见<a href="http://php.net/manual/zh/language.errors.basics.php">这里</a>。</p>
<p>对于应用程序内层调用抛出的“异常”，一般可以在外层中使用try...catch来捕获并自定义处理过程。但对于“错误”（PHP运行时抛出或者应用程序使用trigger_error抛出的）或者对于-无法使用try...catch来捕获可能的异常/为了做到即使忘记捕获的异常也能得到自定义处理-的情况，该怎么办？对此，PHP提供了函数<code>set_error_handler</code>和<code>set_exception_handler</code>来注册错误/异常自定义处理过程。如果在程序的执行流中先后多次调用了<code>set_error_handler</code>或<code>set_exception_handler</code>，后一次注册的处理过程会覆盖前一次的，但可以通过函数<code>restore_error_handler</code>或<code>restore_exception_handler</code>来恢复前一次注册的异常处理过程。</p>
<p><em>之所以写这篇文章，是因为最近在工作中犯了一个低级错误：应用程序中有个API对于不合法的请求参数直接抛出异常（<code>throw new Exception("xxx")</code>），却忘了try...catch捕捉，导致异常被Yii框架（我们的应用基于Yii开发）通过set_exception_handler注册的方法处理 - 响应500，之后这个API被一个扫描器拼命扫，导致出现500多的响应，触发了告警。</em></p>
<h3>分析</h3>
<p>我们来看看Yii框架在哪个地方注册错误/异常处理过程？处理过程是什么样的？</p>
<p>Yii框架在请求处理初始化过程中，在<code>CApplication</code>类（见文件<code>base/CApplication.php</code>）的构造方法中调用了：</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">initSystemHandlers</span><span class="p">();</span>
</pre></div>


<p><code>initSystemHandlers</code>的实现如下：</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * Initializes the class autoloader and error handlers.</span>
<span class="sd"> */</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">initSystemHandlers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// 注：如果不想使用Yii框架注册的handleException，可以在初始化应用实例之前，定义常量YII_ENABLE_EXCEPTION_HANDLER值为false</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">YII_ENABLE_EXCEPTION_HANDLER</span><span class="p">)</span>
        <span class="nb">set_exception_handler</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span><span class="s1">&#39;handleException&#39;</span><span class="p">));</span>
    <span class="c1">// 注：YII_ENABLE_ERROR_HANDLER也是如此</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">YII_ENABLE_ERROR_HANDLER</span><span class="p">)</span>
        <span class="nb">set_error_handler</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span><span class="s1">&#39;handleError&#39;</span><span class="p">),</span><span class="nb">error_reporting</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>


<p>其中注册的方法<code>handleException</code>和<code>handleError</code>实现分别如下：</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">handleException</span><span class="p">(</span><span class="nv">$exception</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// disable error capturing to avoid recursive errors</span>
    <span class="c1">// 这句注释是啥意思？</span>
    <span class="nb">restore_error_handler</span><span class="p">();</span>
    <span class="nb">restore_exception_handler</span><span class="p">();</span>

    <span class="c1">// 生成并记录日志信息</span>
    <span class="nv">$category</span><span class="o">=</span><span class="s1">&#39;exception.&#39;</span><span class="o">.</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$exception</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$exception</span> <span class="nx">instanceof</span> <span class="nx">CHttpException</span><span class="p">)</span>
        <span class="nv">$category</span><span class="o">.=</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">statusCode</span><span class="p">;</span>
    <span class="c1">// php &lt;5.2 doesn&#39;t support string conversion auto-magically</span>
    <span class="nv">$message</span><span class="o">=</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">__toString</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">]))</span>
        <span class="nv">$message</span><span class="o">.=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">REQUEST_URI=&quot;</span><span class="o">.</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_REFERER&#39;</span><span class="p">]))</span>
        <span class="nv">$message</span><span class="o">.=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">HTTP_REFERER=&quot;</span><span class="o">.</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_REFERER&#39;</span><span class="p">];</span>
    <span class="nv">$message</span><span class="o">.=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---&quot;</span><span class="p">;</span>
    <span class="nx">Yii</span><span class="o">::</span><span class="na">log</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span><span class="nx">CLogger</span><span class="o">::</span><span class="na">LEVEL_ERROR</span><span class="p">,</span><span class="nv">$category</span><span class="p">);</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="c1">// 将异常封装成事件，并触发事件，从而触发监听该事件的处理过程</span>
        <span class="nv">$event</span><span class="o">=</span><span class="k">new</span> <span class="nx">CExceptionEvent</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span><span class="nv">$exception</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">onException</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
        <span class="c1">// 如果事件并没有被处理（即没有监听该事件的处理过程）或者所有处理过程都没有将事件的handled属性置为true，则还得自己处理一下</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">handled</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// try an error handler</span>
            <span class="k">if</span><span class="p">((</span><span class="nv">$handler</span><span class="o">=</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getErrorHandler</span><span class="p">())</span><span class="o">!==</span><span class="k">null</span><span class="p">)</span>
                <span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">displayException</span><span class="p">(</span><span class="nv">$exception</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">displayException</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="c1">// 尝试触发onEndRequest事件</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">end</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// use the most primitive way to log error</span>
        <span class="nv">$msg</span> <span class="o">=</span> <span class="nb">get_class</span><span class="p">(</span><span class="nv">$e</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;: &#39;</span><span class="o">.</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39; (&#39;</span><span class="o">.</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getFile</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getLine</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="nv">$msg</span> <span class="o">.=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getTraceAsString</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="nv">$msg</span> <span class="o">.=</span> <span class="s2">&quot;Previous exception:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="nv">$msg</span> <span class="o">.=</span> <span class="nb">get_class</span><span class="p">(</span><span class="nv">$exception</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;: &#39;</span><span class="o">.</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39; (&#39;</span><span class="o">.</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getFile</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getLine</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="nv">$msg</span> <span class="o">.=</span> <span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getTraceAsString</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="nv">$msg</span> <span class="o">.=</span> <span class="s1">&#39;$_SERVER=&#39;</span><span class="o">.</span><span class="nb">var_export</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">,</span><span class="k">true</span><span class="p">);</span>
        <span class="nb">error_log</span><span class="p">(</span><span class="nv">$msg</span><span class="p">);</span>
        <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">handleError</span><span class="p">(</span><span class="nv">$code</span><span class="p">,</span><span class="nv">$message</span><span class="p">,</span><span class="nv">$file</span><span class="p">,</span><span class="nv">$line</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$code</span> <span class="o">&amp;</span> <span class="nb">error_reporting</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="c1">// disable error capturing to avoid recursive errors</span>
        <span class="nb">restore_error_handler</span><span class="p">();</span>
        <span class="nb">restore_exception_handler</span><span class="p">();</span>

        <span class="c1">// 生成并记录日志信息</span>
        <span class="nv">$log</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">$message</span><span class="s2"> (</span><span class="si">$file</span><span class="s2">:</span><span class="si">$line</span><span class="s2">)</span><span class="se">\n</span><span class="s2">Stack trace:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

        <span class="c1">// debug_backtrace() 产生一条 PHP 的回溯跟踪</span>
        <span class="nv">$trace</span><span class="o">=</span><span class="nb">debug_backtrace</span><span class="p">();</span>
        <span class="c1">// skip the first 3 stacks as they do not tell the error position</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$trace</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">)</span>
            <span class="nv">$trace</span><span class="o">=</span><span class="nb">array_slice</span><span class="p">(</span><span class="nv">$trace</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
        <span class="k">foreach</span><span class="p">(</span><span class="nv">$trace</span> <span class="k">as</span> <span class="nv">$i</span><span class="o">=&gt;</span><span class="nv">$t</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]))</span>
                <span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]))</span>
                <span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]))</span>
                <span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">;</span>
            <span class="nv">$log</span><span class="o">.=</span><span class="s2">&quot;#</span><span class="si">$i</span><span class="s2"> </span><span class="si">{</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): &quot;</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_object</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">]))</span>
                <span class="nv">$log</span><span class="o">.=</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])</span><span class="o">.</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">;</span>
            <span class="nv">$log</span><span class="o">.=</span><span class="s2">&quot;</span><span class="si">{</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">]))</span>
            <span class="nv">$log</span><span class="o">.=</span><span class="s1">&#39;REQUEST_URI=&#39;</span><span class="o">.</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">];</span>
        <span class="nx">Yii</span><span class="o">::</span><span class="na">log</span><span class="p">(</span><span class="nv">$log</span><span class="p">,</span><span class="nx">CLogger</span><span class="o">::</span><span class="na">LEVEL_ERROR</span><span class="p">,</span><span class="s1">&#39;php&#39;</span><span class="p">);</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="c1">// 将错误封装成事件，并触发</span>
            <span class="nx">Yii</span><span class="o">::</span><span class="na">import</span><span class="p">(</span><span class="s1">&#39;CErrorEvent&#39;</span><span class="p">,</span><span class="k">true</span><span class="p">);</span>
            <span class="nv">$event</span><span class="o">=</span><span class="k">new</span> <span class="nx">CErrorEvent</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span><span class="nv">$code</span><span class="p">,</span><span class="nv">$message</span><span class="p">,</span><span class="nv">$file</span><span class="p">,</span><span class="nv">$line</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">onError</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
            <span class="c1">// 如果错误事件未被处理</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">handled</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// try an error handler</span>
                <span class="k">if</span><span class="p">((</span><span class="nv">$handler</span><span class="o">=</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getErrorHandler</span><span class="p">())</span><span class="o">!==</span><span class="k">null</span><span class="p">)</span>
                    <span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
                <span class="k">else</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">displayError</span><span class="p">(</span><span class="nv">$code</span><span class="p">,</span><span class="nv">$message</span><span class="p">,</span><span class="nv">$file</span><span class="p">,</span><span class="nv">$line</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">displayException</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="c1">// 尝试触发onEndRequest事件</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">end</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// use the most primitive way to log error</span>
            <span class="nv">$msg</span> <span class="o">=</span> <span class="nb">get_class</span><span class="p">(</span><span class="nv">$e</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;: &#39;</span><span class="o">.</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39; (&#39;</span><span class="o">.</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getFile</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getLine</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="nv">$msg</span> <span class="o">.=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getTraceAsString</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="nv">$msg</span> <span class="o">.=</span> <span class="s2">&quot;Previous error:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="nv">$msg</span> <span class="o">.=</span> <span class="nv">$log</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="nv">$msg</span> <span class="o">.=</span> <span class="s1">&#39;$_SERVER=&#39;</span><span class="o">.</span><span class="nb">var_export</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">,</span><span class="k">true</span><span class="p">);</span>
            <span class="nb">error_log</span><span class="p">(</span><span class="nv">$msg</span><span class="p">);</span>
            <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>从上面代码可以看到，方法<code>handleException</code>的关键部分为：</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// 将异常封装成事件，并触发事件，从而触发监听该事件的处理过程</span>
<span class="nv">$event</span><span class="o">=</span><span class="k">new</span> <span class="nx">CExceptionEvent</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span><span class="nv">$exception</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">onException</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
<span class="c1">// 如果事件并没有被处理（即没有监听该事件的处理过程）或者所有处理过程都没有将事件的handled属性置为true，则还得自己处理一下</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">handled</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// try an error handler</span>
    <span class="k">if</span><span class="p">((</span><span class="nv">$handler</span><span class="o">=</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getErrorHandler</span><span class="p">())</span><span class="o">!==</span><span class="k">null</span><span class="p">)</span>
        <span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">displayException</span><span class="p">(</span><span class="nv">$exception</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>其中方法<code>onException</code>的实现如下：</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">onException</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">raiseEvent</span><span class="p">(</span><span class="s1">&#39;onException&#39;</span><span class="p">,</span><span class="nv">$event</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p><code>raiseEvent</code>方法实现如下：</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">raiseEvent</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span><span class="nv">$event</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 根据事件名称，如onException，找到注册到该事件的处理过程，逐个触发调用。</span>
    <span class="c1">// 所有该事件注册的处理过程存放在$this-&gt;_e[$name]中</span>
    <span class="nv">$name</span><span class="o">=</span><span class="nb">strtolower</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_e</span><span class="p">[</span><span class="nv">$name</span><span class="p">]))</span>
    <span class="p">{</span>
        <span class="k">foreach</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_e</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$handler</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$handler</span><span class="p">))</span>
                <span class="nb">call_user_func</span><span class="p">(</span><span class="nv">$handler</span><span class="p">,</span><span class="nv">$event</span><span class="p">);</span>
            <span class="k">elseif</span><span class="p">(</span><span class="nb">is_callable</span><span class="p">(</span><span class="nv">$handler</span><span class="p">,</span><span class="k">true</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$handler</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="c1">// an array: 0 - object, 1 - method name</span>
                    <span class="k">list</span><span class="p">(</span><span class="nv">$object</span><span class="p">,</span><span class="nv">$method</span><span class="p">)</span><span class="o">=</span><span class="nv">$handler</span><span class="p">;</span>
                    <span class="k">if</span><span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$object</span><span class="p">))</span>  <span class="c1">// static method call</span>
                        <span class="nb">call_user_func</span><span class="p">(</span><span class="nv">$handler</span><span class="p">,</span><span class="nv">$event</span><span class="p">);</span>
                    <span class="k">elseif</span><span class="p">(</span><span class="nb">method_exists</span><span class="p">(</span><span class="nv">$object</span><span class="p">,</span><span class="nv">$method</span><span class="p">))</span>
                        <span class="nv">$object</span><span class="o">-&gt;</span><span class="nv">$method</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
                    <span class="k">else</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">CException</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;yii&#39;</span><span class="p">,</span><span class="s1">&#39;Event &quot;{class}.{event}&quot; is attached with an invalid handler &quot;{handler}&quot;.&#39;</span><span class="p">,</span>
                            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;{class}&#39;</span><span class="o">=&gt;</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$this</span><span class="p">),</span> <span class="s1">&#39;{event}&#39;</span><span class="o">=&gt;</span><span class="nv">$name</span><span class="p">,</span> <span class="s1">&#39;{handler}&#39;</span><span class="o">=&gt;</span><span class="nv">$handler</span><span class="p">[</span><span class="mi">1</span><span class="p">])));</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="c1">// PHP 5.3: anonymous function</span>
                    <span class="nb">call_user_func</span><span class="p">(</span><span class="nv">$handler</span><span class="p">,</span><span class="nv">$event</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">CException</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;yii&#39;</span><span class="p">,</span><span class="s1">&#39;Event &quot;{class}.{event}&quot; is attached with an invalid handler &quot;{handler}&quot;.&#39;</span><span class="p">,</span>
                    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;{class}&#39;</span><span class="o">=&gt;</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$this</span><span class="p">),</span> <span class="s1">&#39;{event}&#39;</span><span class="o">=&gt;</span><span class="nv">$name</span><span class="p">,</span> <span class="s1">&#39;{handler}&#39;</span><span class="o">=&gt;</span><span class="nb">gettype</span><span class="p">(</span><span class="nv">$handler</span><span class="p">))));</span>
            <span class="c1">// stop further handling if param.handled is set true</span>
            <span class="k">if</span><span class="p">((</span><span class="nv">$event</span> <span class="nx">instanceof</span> <span class="nx">CEvent</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">handled</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">elseif</span><span class="p">(</span><span class="nx">YII_DEBUG</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasEvent</span><span class="p">(</span><span class="nv">$name</span><span class="p">))</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">CException</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;yii&#39;</span><span class="p">,</span><span class="s1">&#39;Event &quot;{class}.{event}&quot; is not defined.&#39;</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;{class}&#39;</span><span class="o">=&gt;</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$this</span><span class="p">),</span> <span class="s1">&#39;{event}&#39;</span><span class="o">=&gt;</span><span class="nv">$name</span><span class="p">)));</span>
<span class="p">}</span>
</pre></div>


<p>那么是如何注册事件的处理过程的呢？</p>
<p>在类<code>CComponent</code>（见文件<code>base/CComponent.php</code>，<code>CApplication</code>类继承间接继承自该类）中定义了一对方法：<code>attachEventHandler</code>（将处理过程绑定到某事件）和<code>detachEventHandler</code>（将处理过程从事件解绑）。</p>
<p>方法<code>attachEventHandler</code>的实现如下：</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">attachEventHandler</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span><span class="nv">$handler</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEventHandlers</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$handler</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>其中<code>getEventHandlers</code>实现如下：</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">getEventHandlers</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 可以关注一下方法hasEvent</span>
    <span class="c1">// 检查是否存在$name对应的事件</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasEvent</span><span class="p">(</span><span class="nv">$name</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="nv">$name</span><span class="o">=</span><span class="nb">strtolower</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_e</span><span class="p">[</span><span class="nv">$name</span><span class="p">]))</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_e</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span><span class="o">=</span><span class="k">new</span> <span class="nx">CList</span><span class="p">;</span>
        <span class="c1">// 返回对应事件的处理过程列表</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_e</span><span class="p">[</span><span class="nv">$name</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">CException</span><span class="p">(</span><span class="nx">Yii</span><span class="o">::</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;yii&#39;</span><span class="p">,</span><span class="s1">&#39;Event &quot;{class}.{event}&quot; is not defined.&#39;</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;{class}&#39;</span><span class="o">=&gt;</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$this</span><span class="p">),</span> <span class="s1">&#39;{event}&#39;</span><span class="o">=&gt;</span><span class="nv">$name</span><span class="p">)));</span>
<span class="p">}</span>
</pre></div>


<p>回到“方法<code>handleException</code>的关键部分”，在事件的handled属性没有置为true的情况下，会调用方法<code>getErrorHandler</code>取到内置的一个处理过程，该方法实现如下：</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">getErrorHandler</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// 获取名为errorHandler的组件，该组件默认会在CApplication类的registerCoreComponents方法中注册，</span>
    <span class="c1">// 见http://blog.xiayf.cn/2014/11/13/read-yii-code-3/一文的说明</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getComponent</span><span class="p">(</span><span class="s1">&#39;errorHandler&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>名为errorHandler的组件默认为类<code>CErrorHandler</code>（见文件<code>base/CErrorHandler.php</code>），当然也可以配置覆盖默认行为。</p>
<p><code>CErrorHandler</code>类的<code>handle</code>方法实现如下：</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// set event as handled to prevent it from being handled by other event handlers</span>
    <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">handled</span><span class="o">=</span><span class="k">true</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">discardOutput</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$gzHandler</span><span class="o">=</span><span class="k">false</span><span class="p">;</span>
        <span class="k">foreach</span><span class="p">(</span><span class="nb">ob_list_handlers</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$h</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$h</span><span class="p">,</span><span class="s1">&#39;gzhandler&#39;</span><span class="p">)</span><span class="o">!==</span><span class="k">false</span><span class="p">)</span>
                <span class="nv">$gzHandler</span><span class="o">=</span><span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// the following manual level counting is to deal with zlib.output_compression set to On</span>
        <span class="c1">// for an output buffer created by zlib.output_compression set to On ob_end_clean will fail</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$level</span><span class="o">=</span><span class="nb">ob_get_level</span><span class="p">();</span><span class="nv">$level</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span><span class="o">--</span><span class="nv">$level</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!@</span><span class="nb">ob_end_clean</span><span class="p">())</span>
                <span class="nb">ob_clean</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">// reset headers in case there was an ob_start(&quot;ob_gzhandler&quot;) before</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$gzHandler</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">headers_sent</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nb">ob_list_handlers</span><span class="p">()</span><span class="o">===</span><span class="k">array</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">&#39;header_remove&#39;</span><span class="p">))</span> <span class="c1">// php &gt;= 5.3</span>
            <span class="p">{</span>
                <span class="nb">header_remove</span><span class="p">(</span><span class="s1">&#39;Vary&#39;</span><span class="p">);</span>
                <span class="nb">header_remove</span><span class="p">(</span><span class="s1">&#39;Content-Encoding&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="nb">header</span><span class="p">(</span><span class="s1">&#39;Vary:&#39;</span><span class="p">);</span>
                <span class="nb">header</span><span class="p">(</span><span class="s1">&#39;Content-Encoding:&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 异常和错误都可以调用handle方法</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$event</span> <span class="nx">instanceof</span> <span class="nx">CExceptionEvent</span><span class="p">)</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handleException</span><span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">exception</span><span class="p">);</span>
    <span class="k">else</span> <span class="c1">// CErrorEvent</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handleError</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>其中方法<code>handleException</code>和<code>handleError</code>实现分别如下：</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">handleException</span><span class="p">(</span><span class="nv">$exception</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$app</span><span class="o">=</span><span class="nx">Yii</span><span class="o">::</span><span class="na">app</span><span class="p">();</span>
    <span class="c1">// 如果是Web应用</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$app</span> <span class="nx">instanceof</span> <span class="nx">CWebApplication</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">((</span><span class="nv">$trace</span><span class="o">=</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getExactTrace</span><span class="p">(</span><span class="nv">$exception</span><span class="p">))</span><span class="o">===</span><span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$fileName</span><span class="o">=</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getFile</span><span class="p">();</span>
            <span class="nv">$errorLine</span><span class="o">=</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getLine</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="nv">$fileName</span><span class="o">=</span><span class="nv">$trace</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">];</span>
            <span class="nv">$errorLine</span><span class="o">=</span><span class="nv">$trace</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nv">$trace</span> <span class="o">=</span> <span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getTrace</span><span class="p">();</span>

        <span class="k">foreach</span><span class="p">(</span><span class="nv">$trace</span> <span class="k">as</span> <span class="nv">$i</span><span class="o">=&gt;</span><span class="nv">$t</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]))</span>
                <span class="nv">$trace</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]))</span>
                <span class="nv">$trace</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]))</span>
                <span class="nv">$trace</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;function&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">;</span>

            <span class="nb">unset</span><span class="p">(</span><span class="nv">$trace</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;object&#39;</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_error</span><span class="o">=</span><span class="nv">$data</span><span class="o">=</span><span class="k">array</span><span class="p">(</span>
            <span class="c1">// 如果抛出的异常是CHttpException类型，使用该异常自身的statusCode作为HTTP响应码，否则HTTP响应码为500</span>
            <span class="c1">// 所以在有意让Yii框架来处理抛出的异常时，需要明确指定异常的类型！</span>
            <span class="s1">&#39;code&#39;</span><span class="o">=&gt;</span><span class="p">(</span><span class="nv">$exception</span> <span class="nx">instanceof</span> <span class="nx">CHttpException</span><span class="p">)</span><span class="o">?</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">statusCode</span><span class="o">:</span><span class="mi">500</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="o">=&gt;</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$exception</span><span class="p">),</span>
            <span class="s1">&#39;errorCode&#39;</span><span class="o">=&gt;</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getCode</span><span class="p">(),</span>
            <span class="s1">&#39;message&#39;</span><span class="o">=&gt;</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span>
            <span class="s1">&#39;file&#39;</span><span class="o">=&gt;</span><span class="nv">$fileName</span><span class="p">,</span>
            <span class="s1">&#39;line&#39;</span><span class="o">=&gt;</span><span class="nv">$errorLine</span><span class="p">,</span>
            <span class="s1">&#39;trace&#39;</span><span class="o">=&gt;</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getTraceAsString</span><span class="p">(),</span>
            <span class="s1">&#39;traces&#39;</span><span class="o">=&gt;</span><span class="nv">$trace</span><span class="p">,</span>
        <span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">headers_sent</span><span class="p">())</span>
            <span class="nb">header</span><span class="p">(</span><span class="s2">&quot;HTTP/1.0 </span><span class="si">{</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getHttpHeader</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="nb">get_class</span><span class="p">(</span><span class="nv">$exception</span><span class="p">)));</span>

        <span class="c1">// 判断异常类型</span>
        <span class="c1">// 对于CHttpException，也按照error来处理</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$exception</span> <span class="nx">instanceof</span> <span class="nx">CHttpException</span> <span class="o">||</span> <span class="o">!</span><span class="nx">YII_DEBUG</span><span class="p">)</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="nv">$data</span><span class="p">);</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isAjaxRequest</span><span class="p">())</span>
                <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">displayException</span><span class="p">(</span><span class="nv">$exception</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;exception&#39;</span><span class="p">,</span><span class="nv">$data</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// 如果是终端应用（console application），则直接展示异常</span>
    <span class="k">else</span>
        <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">displayException</span><span class="p">(</span><span class="nv">$exception</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">handleError</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$trace</span><span class="o">=</span><span class="nb">debug_backtrace</span><span class="p">();</span>
    <span class="c1">// skip the first 3 stacks as they do not tell the error position</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$trace</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">)</span>
        <span class="nv">$trace</span><span class="o">=</span><span class="nb">array_slice</span><span class="p">(</span><span class="nv">$trace</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
    <span class="nv">$traceString</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$trace</span> <span class="k">as</span> <span class="nv">$i</span><span class="o">=&gt;</span><span class="nv">$t</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]))</span>
            <span class="nv">$trace</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]))</span>
            <span class="nv">$trace</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]))</span>
            <span class="nv">$trace</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;function&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">;</span>

        <span class="nv">$traceString</span><span class="o">.=</span><span class="s2">&quot;#</span><span class="si">$i</span><span class="s2"> </span><span class="si">{</span><span class="nv">$trace</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nv">$trace</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): &quot;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_object</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">]))</span>
            <span class="nv">$traceString</span><span class="o">.=</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])</span><span class="o">.</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">;</span>
        <span class="nv">$traceString</span><span class="o">.=</span><span class="s2">&quot;</span><span class="si">{</span><span class="nv">$trace</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;function&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

        <span class="nb">unset</span><span class="p">(</span><span class="nv">$trace</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;object&#39;</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="nv">$app</span><span class="o">=</span><span class="nx">Yii</span><span class="o">::</span><span class="na">app</span><span class="p">();</span>
    <span class="c1">// 如果是Web应用</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$app</span> <span class="nx">instanceof</span> <span class="nx">CWebApplication</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 判断错误类型</span>
        <span class="k">switch</span><span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">code</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="k">E_WARNING</span><span class="o">:</span>
                <span class="nv">$type</span> <span class="o">=</span> <span class="s1">&#39;PHP warning&#39;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">E_NOTICE</span><span class="o">:</span>
                <span class="nv">$type</span> <span class="o">=</span> <span class="s1">&#39;PHP notice&#39;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">E_USER_ERROR</span><span class="o">:</span>
                <span class="nv">$type</span> <span class="o">=</span> <span class="s1">&#39;User error&#39;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">E_USER_WARNING</span><span class="o">:</span>
                <span class="nv">$type</span> <span class="o">=</span> <span class="s1">&#39;User warning&#39;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">E_USER_NOTICE</span><span class="o">:</span>
                <span class="nv">$type</span> <span class="o">=</span> <span class="s1">&#39;User notice&#39;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">E_RECOVERABLE_ERROR</span><span class="o">:</span>
                <span class="nv">$type</span> <span class="o">=</span> <span class="s1">&#39;Recoverable error&#39;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="nv">$type</span> <span class="o">=</span> <span class="s1">&#39;PHP error&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// HTTP响应码为500</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_error</span><span class="o">=</span><span class="nv">$data</span><span class="o">=</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;code&#39;</span><span class="o">=&gt;</span><span class="mi">500</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="o">=&gt;</span><span class="nv">$type</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="o">=&gt;</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">,</span>
            <span class="s1">&#39;file&#39;</span><span class="o">=&gt;</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">,</span>
            <span class="s1">&#39;line&#39;</span><span class="o">=&gt;</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">line</span><span class="p">,</span>
            <span class="s1">&#39;trace&#39;</span><span class="o">=&gt;</span><span class="nv">$traceString</span><span class="p">,</span>
            <span class="s1">&#39;traces&#39;</span><span class="o">=&gt;</span><span class="nv">$trace</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">headers_sent</span><span class="p">())</span>
            <span class="nb">header</span><span class="p">(</span><span class="s2">&quot;HTTP/1.0 500 Internal Server Error&quot;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isAjaxRequest</span><span class="p">())</span>
            <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">displayError</span><span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">code</span><span class="p">,</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">,</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">,</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">line</span><span class="p">);</span>
        <span class="k">elseif</span><span class="p">(</span><span class="nx">YII_DEBUG</span><span class="p">)</span>
            <span class="c1">// 开了debug，则作为exception来处理</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;exception&#39;</span><span class="p">,</span><span class="nv">$data</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">displayError</span><span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">code</span><span class="p">,</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">,</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">,</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">line</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>上面的代码最终显示异常/错误信息，是通过方法<code>render</code>、以及应用实例的<code>displayError</code>和<code>displayException</code>方法来完成。</p>
<p><strong>render</strong></p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nv">$view</span><span class="p">,</span><span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 注意这个地方，如果配置了errorAction，则可以指定目标controller的某个action来处理错误</span>
    <span class="cm">/*</span>
<span class="cm">     * 配置方式：</span>
<span class="cm">     * &#39;components&#39; =&gt; array(</span>
<span class="cm">     *      &#39;errorHandler&#39; =&gt; array(</span>
<span class="cm">     *          &#39;errorAction&#39;=&gt;&#39;api/index/error&#39;,</span>
<span class="cm">     *     ),</span>
<span class="cm">     *     ...</span>
<span class="cm">     */</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$view</span><span class="o">===</span><span class="s1">&#39;error&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">errorAction</span><span class="o">!==</span><span class="k">null</span><span class="p">)</span>
        <span class="nx">Yii</span><span class="o">::</span><span class="na">app</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">runController</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">errorAction</span><span class="p">);</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">// additional information to be passed to view</span>
        <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="o">=</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getVersionInfo</span><span class="p">();</span>
        <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">time</span><span class="p">();</span>
        <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">]</span><span class="o">=</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">adminInfo</span><span class="p">;</span>

        <span class="c1">// 看看下面getViewFile的实现</span>
        <span class="k">include</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getViewFile</span><span class="p">(</span><span class="nv">$view</span><span class="p">,</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">getViewFile</span><span class="p">(</span><span class="nv">$view</span><span class="p">,</span><span class="nv">$code</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$viewPaths</span><span class="o">=</span><span class="k">array</span><span class="p">(</span>
        <span class="nx">Yii</span><span class="o">::</span><span class="na">app</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getTheme</span><span class="p">()</span><span class="o">===</span><span class="k">null</span> <span class="o">?</span> <span class="k">null</span> <span class="o">:</span>  <span class="nx">Yii</span><span class="o">::</span><span class="na">app</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getTheme</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getSystemViewPath</span><span class="p">(),</span>
        <span class="nx">Yii</span><span class="o">::</span><span class="na">app</span><span class="p">()</span> <span class="nx">instanceof</span> <span class="nx">CWebApplication</span> <span class="o">?</span> <span class="nx">Yii</span><span class="o">::</span><span class="na">app</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getSystemViewPath</span><span class="p">()</span> <span class="o">:</span> <span class="k">null</span><span class="p">,</span>
        <span class="nx">YII_PATH</span><span class="o">.</span><span class="nx">DIRECTORY_SEPARATOR</span><span class="o">.</span><span class="s1">&#39;views&#39;</span><span class="p">,</span>
    <span class="p">);</span>

    <span class="k">foreach</span><span class="p">(</span><span class="nv">$viewPaths</span> <span class="k">as</span> <span class="nv">$i</span><span class="o">=&gt;</span><span class="nv">$viewPath</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$viewPath</span><span class="o">!==</span><span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
             <span class="c1">// 看看下面getViewFileInternal的实现</span>
             <span class="nv">$viewFile</span><span class="o">=</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getViewFileInternal</span><span class="p">(</span><span class="nv">$viewPath</span><span class="p">,</span><span class="nv">$view</span><span class="p">,</span><span class="nv">$code</span><span class="p">,</span><span class="nv">$i</span><span class="o">===</span><span class="mi">2</span><span class="o">?</span><span class="s1">&#39;en_us&#39;</span><span class="o">:</span><span class="k">null</span><span class="p">);</span>
             <span class="k">if</span><span class="p">(</span><span class="nb">is_file</span><span class="p">(</span><span class="nv">$viewFile</span><span class="p">))</span>
                 <span class="k">return</span> <span class="nv">$viewFile</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">getViewFileInternal</span><span class="p">(</span><span class="nv">$viewPath</span><span class="p">,</span><span class="nv">$view</span><span class="p">,</span><span class="nv">$code</span><span class="p">,</span><span class="nv">$srcLanguage</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$app</span><span class="o">=</span><span class="nx">Yii</span><span class="o">::</span><span class="na">app</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$view</span><span class="o">===</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$viewFile</span><span class="o">=</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">findLocalizedFile</span><span class="p">(</span><span class="nv">$viewPath</span><span class="o">.</span><span class="nx">DIRECTORY_SEPARATOR</span><span class="o">.</span><span class="s2">&quot;error</span><span class="si">{</span><span class="nv">$code</span><span class="si">}</span><span class="s2">.php&quot;</span><span class="p">,</span><span class="nv">$srcLanguage</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">is_file</span><span class="p">(</span><span class="nv">$viewFile</span><span class="p">))</span>
            <span class="nv">$viewFile</span><span class="o">=</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">findLocalizedFile</span><span class="p">(</span><span class="nv">$viewPath</span><span class="o">.</span><span class="nx">DIRECTORY_SEPARATOR</span><span class="o">.</span><span class="s1">&#39;error.php&#39;</span><span class="p">,</span><span class="nv">$srcLanguage</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="nv">$viewFile</span><span class="o">=</span><span class="nv">$viewPath</span><span class="o">.</span><span class="nx">DIRECTORY_SEPARATOR</span><span class="o">.</span><span class="s2">&quot;exception.php&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$viewFile</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>上面代码的逻辑是 - 对于error类型的信息，Yii会依次在以下目录中寻找名为<code>error{$code}.php</code>文件来展示错误/异常信息：</p>
<ol>
<li>WebRoot/themes/ThemeName/views/system</li>
<li>WebRoot/protected/views/system</li>
<li>yii/framework/views</li>
</ol>
<p>如果没有找到，则以相同的次序在这些目录中查找<code>error.php</code>文件。</p>
<p>对于exception类型信息，则是查找<code>exception.php</code>文件。</p>
<p>所以如果应用开发过程需要定制4xx、5xx的错误页面，可以在<code>WebRoot/protected/views/system</code>或<code>WebRoot/themes/ThemeName/views/system</code>放置对应的错误模板页面。</p>
<p><strong>displayError</strong></p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">displayError</span><span class="p">(</span><span class="nv">$code</span><span class="p">,</span><span class="nv">$message</span><span class="p">,</span><span class="nv">$file</span><span class="p">,</span><span class="nv">$line</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">YII_DEBUG</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;&lt;h1&gt;PHP Error [</span><span class="si">$code</span><span class="s2">]&lt;/h1&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;</span><span class="si">$message</span><span class="s2"> (</span><span class="si">$file</span><span class="s2">:</span><span class="si">$line</span><span class="s2">)&lt;/p&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">&#39;&lt;pre&gt;&#39;</span><span class="p">;</span>

        <span class="nv">$trace</span><span class="o">=</span><span class="nb">debug_backtrace</span><span class="p">();</span>
        <span class="c1">// skip the first 3 stacks as they do not tell the error position</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$trace</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">)</span>
            <span class="nv">$trace</span><span class="o">=</span><span class="nb">array_slice</span><span class="p">(</span><span class="nv">$trace</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
        <span class="k">foreach</span><span class="p">(</span><span class="nv">$trace</span> <span class="k">as</span> <span class="nv">$i</span><span class="o">=&gt;</span><span class="nv">$t</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]))</span>
                <span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]))</span>
                <span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]))</span>
                <span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">;</span>
            <span class="k">echo</span> <span class="s2">&quot;#</span><span class="si">$i</span><span class="s2"> </span><span class="si">{</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): &quot;</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_object</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">]))</span>
                <span class="k">echo</span> <span class="nb">get_class</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])</span><span class="o">.</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">;</span>
            <span class="k">echo</span> <span class="s2">&quot;</span><span class="si">{</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">echo</span> <span class="s1">&#39;&lt;/pre&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;&lt;h1&gt;PHP Error [</span><span class="si">$code</span><span class="s2">]&lt;/h1&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;</span><span class="si">$message</span><span class="s2">&lt;/p&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><strong>displayException</strong></p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">displayException</span><span class="p">(</span><span class="nv">$exception</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">YII_DEBUG</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">&#39;&lt;h1&gt;&#39;</span><span class="o">.</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$exception</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;&lt;/h1&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">&#39;&lt;p&gt;&#39;</span><span class="o">.</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39; (&#39;</span><span class="o">.</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getFile</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getLine</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;)&lt;/p&gt;&#39;</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">&#39;&lt;pre&gt;&#39;</span><span class="o">.</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getTraceAsString</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;&lt;/pre&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">&#39;&lt;h1&gt;&#39;</span><span class="o">.</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$exception</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;&lt;/h1&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">&#39;&lt;p&gt;&#39;</span><span class="o">.</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3>总结</h3>
<p>由上述分析可知，基于Yii框架开发应用时，有以下几点注意事项：</p>
<ul>
<li>可以通过配置组件<code>errorHandler</code>的<code>errorAction</code>属性来定制异常/错误处理过程</li>
<li>可以通过在<code>WebRoot/themes/ThemeName/views/system</code>或<code>WebRoot/protected/views/system</code>放置模板（名为<code>error{$code}.php</code>）来定制错误/异常展示方式</li>
<li>在有意抛出异常由Yii框架捕获时，需明确异常的类型是否应为<code>CHttpException</code>，只有<code>CHttpException</code>实例初始化时指定的code才能成为HTTP响应码</li>
<li>可以对事件<code>onError</code>、<code>onException</code>绑定事件处理过程，进行额外的处理，比如记录错误/异常、触发告警等</li>
</ul>
<h3>参考资料</h3>
<ul>
<li><a href="http://php.net/manual/zh/book.errorfunc.php">PHP手册 - 错误处理和日志记录</a></li>
<li><a href="http://www.yiiframework.com/doc/guide/1.1/en/topics.error">Error Handling</a></li>
<li><a href="/assets/uploads/files/PHP-Debug-Manual-public.pdf">PHP调试技术手册</a></li>
</ul>
            </div><!-- /.entry-content -->
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "2015/09/14/read-yii-code-10/";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://xiayfblackwhite.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>
        </div><!-- /.twelve.columns -->
 </div><!-- /.row -->
</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">


        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">

                <li><div class="btn primary"><a href="http://github.com/youngsterxyf" target="_blank">Github</a></div></li>

                <li><div class="btn twitter"><a href="https://twitter.com/youngsterxyf" target="_blank">Twitter</a></div></li>

                <li><div class="btn warning"><a href="http://weibo.com/u/1855563263" target="_blank">Weibo</a></div></li>

                <li><div class="btn douban"><a href="http://www.douban.com/people/youngster21/" target="_blank">Douban</a></div></li>



              </ul>
            </div>
          </div>
        </footer>

    </div>


<script type="text/javascript">
    var disqus_shortname = 'xiayfblackwhite';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="../../../../theme/js/libs/gumby.min.js"></script>
  <script src="../../../../theme/js/plugins.js"></script>
  <script src="../../../../theme/js/main.js"></script>
</body>
</html>