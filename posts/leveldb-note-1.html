<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta property="og:title" content="BitPacking">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://bit.xiayf.cn/">
    <meta property="og:site_name" content="BitPacking">
    <meta property="og:description" content="精进，求诸己身">

    <title>BitPacking</title>
    <meta name="description" content="精进，求诸己身">
    <link rel="stylesheet" href="/static/main.css">
    <link rel="canonical" href="https://bit.xiayf.cn/">
    
    <link crossorigin="" rel="shortcut icon" type="image/x-icon" href="/assets/bits_small.ico">
    
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    
    <style>
@import url("https://fontsapi.zeoseven.com/7/main/result.css");
body {
    font-family: equity_text_a, "Zhuque Fangsong (technical preview)";
    font-weight: normal;
}
</style>
    
    
</head>

<body>
<header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">BitPacking</a>
        <nav class="site-nav">
            <a href="#" class="menu-icon">
                <svg viewBox="0 0 18 15">
                    <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
                    <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
                    <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
                </svg>
            </a>
            <div class="trigger">
                
                <a class="page-link" href="/pages/about.html">关于我</a>
                
                <a class="page-link" href="/pages/works.html">作品</a>
                
                <a class="page-link" href="/pages/linlang.html">琳琅</a>
                
                <a class="page-link" href="/rss.xml">RSS</a>
                
            </div>
        </nav>
    </div>
</header>
<div class="page-content">
    <div class="wrapper">
        
<div class="post">
    <header class="post-header">
        <h1 class="post-title">读码：LevelDB - 接口定义与数据写入</h1>
        <p class="post-meta">2024-11-10</p>
    </header>
    <article class="post-content">
        <h2>0、设计概要&接口定义</h2>
<img src='https://s2.loli.net/2025/08/06/EPeWyYTC6VUwgrM.png' title='lsm' alt='lsm' width='800'/>
<img src='../plantuml-images/10988454778988851872.svg' title='10988454778988851872' alt='10988454778988851872'/>
<p class="text-align-justify">基于 DB 类的静态方法 Open 来打开/初始化一个数据库，Open 会实例化一个 DBImpl 对象，调用其私有方法 Recover 来恢复/初始化状态，并将 DBImpl 对象指针赋值给 dbptr 返回给调用方，调用方通过 dbptr 调用 Put/Write/Delete/Get/NewIterator 进行读写操作。</p>
<h2>1、WriteBatch</h2>
<p class="text-align-justify">Put 和 Delete 是针对单个 key 进行操作，在底层会将键值操作包装成 WriteBatch 对象，然后调用 Write 接口执行实际的操作流程。</p>
<p class="text-align-justify">也可以在调用侧实例化 WriteBatch 对象，将一批增删操作都先填充到 WriteBatch 对象，然后直接调用 Write 接口执行一批操作，这样写吞吐应该会更高一点。这批操作是<u>原子的</u>（一起写成功或者失败）。</p>
<img src='../plantuml-images/11051565628098698760.svg' title='11051565628098698760' alt='11051565628098698760'/>
<pre class="language-cpp"><code>//
typedef uint64_t SequenceNumber; // 虽然序列号使用了的 uint64_t 类型，但是实际只会使用 56 比特，即最大值为 ((0x1ull << 56) - 1)
// We leave eight bits empty at the bottom so a type and sequence#  
// can be packed together into 64-bits.  
static const SequenceNumber kMaxSequenceNumber = ((0x1ull << 56) - 1);
//
typedef SkipList<const char*, KeyComparator> Table;</code></pre>
<p class="text-align-justify"><strong>rep_ 存储结构</strong></p>
<pre class="language-text"><code>// WriteBatch::rep_ :=  
//    sequence: fixed64  
//    count: fixed32  
//    data: record[count]  
// record :=  
//    kTypeValue varstring varstring         |  
//    kTypeDeletion varstring  
// varstring :=  
//    len: varint32  
//    data: uint8[len]</code></pre>
<img src='https://s2.loli.net/2025/08/06/CUoWvHwjdMSs6a2.png' title='write-batch' alt='write-batch' width='800'/>
<p class="text-align-justify"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="14.55ex" height="2.034ex" role="img" focusable="false" viewBox="0 -705 6431 899" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-2-NCM-I-1D446" d="M133 157C133 181 136 201 141 217C141 227 136 232 125 232C120 232 116 230 114 228C109 223 52 8 52-8C52-17 57-22 67-22C72-22 79-17 88-6L133 47C168 1 224-22 300-22C366-22 424 5 476 58C528 111 554 170 554 236C554 283 538 323 505 355C490 368 470 379 445 388C422 393 400 399 378 405L312 423C279 432 254 469 254 509C254 552 271 589 306 621C341 653 380 669 423 669C515 669 561 619 561 520C561 502 557 482 557 465L557 462C560 455 565 451 573 451C582 451 588 459 592 474L645 691C645 700 640 705 630 705C625 705 618 700 609 689L566 637C538 682 491 705 424 705C361 705 304 681 254 634C202 586 176 531 176 468C176 396 223 339 282 323L387 296C441 281 475 262 475 195C475 149 457 108 422 72C387 36 347 17 302 17C204 17 133 60 133 157Z"></path><path id="MJX-2-NCM-I-1D452" d="M124 129C124 153 129 186 139 227L188 227C253 227 303 235 339 250C372 264 394 284 405 309C412 326 415 342 415 355C415 410 363 442 307 442C268 442 229 432 190 412C113 372 46 281 46 171C46 69 105-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 124 72 124 129M375 355C375 289 311 256 182 256L147 256C166 322 194 366 232 387C262 404 287 413 307 413C343 413 375 391 375 355Z"></path><path id="MJX-2-NCM-I-1D45E" d="M372 377C352 420 321 442 280 442C215 442 158 409 109 342C63 280 40 216 40 149C40 62 90-13 173-13C209-13 245 4 282 38L241-126C238-141 229-150 215-153C210-154 197-155 174-155C168-156 164-156 162-156C153-157 148-165 148-179L148-183C151-190 157-194 165-194C184-194 244-191 263-191C282-191 345-194 364-194C378-194 385-186 385-170C385-160 375-155 356-155C338-155 313-156 313-144C313-140 314-133 317-123L452 427C452 436 447 441 438 441C420 441 382 391 372 377M340 373C349 352 354 338 354 329C354 328 353 322 351 313L327 216C308 144 299 107 298 105C279 70 224 16 176 16C137 16 117 46 117 105C117 151 148 263 162 300C181 347 225 412 280 412C307 412 327 399 340 373Z"></path><path id="MJX-2-NCM-I-1D462" d="M543 144C543 153 538 158 527 158C518 158 513 151 510 137C505 118 500 99 493 80C480 39 462 18 440 18C422 18 413 32 413 60C413 77 420 111 433 161L460 267C469 303 477 328 483 359L489 386C491 393 492 398 492 401C492 421 481 431 459 431C437 431 423 419 417 394L343 98C342 95 338 88 330 76C314 50 275 18 235 18C197 18 178 44 178 95C178 136 196 202 231 294C242 324 248 345 248 357C248 407 213 442 163 442C118 442 83 417 58 367C39 328 29 301 29 287C29 278 34 273 45 273C58 273 60 279 64 293C87 373 119 413 160 413C174 413 181 403 181 384C181 369 175 348 164 319C126 218 107 148 107 111C107 34 155-11 232-11C275-11 314 9 347 50C361 9 391-11 437-11C506-11 527 70 543 144Z"></path><path id="MJX-2-NCM-I-1D45B" d="M537 137C514 58 481 18 440 18C427 18 420 28 420 47C420 61 426 84 438 115C478 224 498 296 498 333C498 403 451 442 381 442C322 442 271 416 230 363C222 407 187 442 136 442C80 442 58 390 44 345C34 313 29 294 29 287C29 278 34 273 45 273C50 273 53 274 56 276C61 285 64 292 65 299C83 375 106 413 133 413C151 413 160 399 160 371C160 358 155 331 144 290L87 63C84 50 78 24 78 19C78-1 89-11 111-11C130-11 144-1 151 19C153 24 159 49 170 92L191 181L221 295C232 318 249 341 270 365C299 397 335 413 378 413C411 413 427 391 427 348C427 310 406 234 363 120C356 102 353 87 353 74C353 25 390-11 438-11C482-11 517 14 542 64C561 104 571 131 571 144C571 153 566 158 555 158C552 158 537 149 537 137Z"></path><path id="MJX-2-NCM-I-1D450" d="M328 325C328 300 341 287 368 287C404 287 427 318 427 354C427 410 368 442 308 442C239 442 176 412 122 353C68 294 41 229 41 159C41 61 106-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 121 53 121 122C121 184 150 274 174 317C198 361 249 413 308 413C346 413 372 402 386 381C355 378 328 358 328 325Z"></path><path id="MJX-2-NCM-I-1D441" d="M864 683C845 683 783 680 764 680C745 680 682 683 663 683C648 683 641 675 641 659C641 650 648 645 663 644C705 644 726 631 726 605C726 599 725 592 724 585L616 157L401 662C393 681 391 683 366 683L233 683C209 683 200 681 200 659C200 649 211 644 232 644C274 644 295 643 296 640L163 110C154 71 131 49 95 42C69 39 39 43 39 15C39 5 45 0 56 0C74 0 136 3 155 3C174 3 238 0 257 0C272 0 279 8 279 24C279 33 271 38 255 39C214 40 194 53 194 78C194 83 195 90 197 100L326 611L576 21C582 7 590 0 599 0C608 0 614 8 618 24L757 574C770 625 798 643 860 644C874 645 881 653 881 669C878 678 877 683 864 683Z"></path><path id="MJX-2-NCM-I-1D45A" d="M657 442C596 442 543 412 498 353C489 412 451 442 383 442C324 442 273 416 231 363C223 407 188 442 137 442C96 442 66 409 45 344C34 312 29 293 29 287C29 278 34 273 45 273C50 273 53 274 56 276C61 285 64 292 66 299C84 375 107 413 134 413C152 413 161 399 161 371C161 358 156 331 145 290L88 63C84 51 79 25 79 19C79-1 90-11 111-11C131-11 145-1 152 19C153 24 160 49 171 92L192 181L222 295C233 318 250 341 272 365C301 397 337 413 380 413C413 413 429 391 429 348C429 335 424 308 414 267L387 153C380 124 364 64 356 32C355 25 354 21 354 19C354-1 365-11 387-11C398-11 406-8 413-1C428 14 429 21 435 48L494 285C497 298 511 321 535 353C565 393 605 413 654 413C687 413 703 391 703 348C703 309 683 236 642 129C633 106 629 87 629 74C629 25 666-11 714-11C759-11 793 14 818 64C838 104 848 131 848 144C848 153 843 158 832 158C825 157 818 148 813 137C791 58 759 18 716 18C703 18 696 28 696 47C696 62 702 84 714 115C755 222 775 295 775 333C775 404 728 442 657 442Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="SequenceNum"><g data-mml-node="mi" data-latex="S"><use data-c="1D446" xlink:href="#MJX-2-NCM-I-1D446"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(645,0)"><use data-c="1D452" xlink:href="#MJX-2-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="q" transform="translate(1111,0)"><use data-c="1D45E" xlink:href="#MJX-2-NCM-I-1D45E"></use></g><g data-mml-node="mi" data-latex="u" transform="translate(1563,0)"><use data-c="1D462" xlink:href="#MJX-2-NCM-I-1D462"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(2135,0)"><use data-c="1D452" xlink:href="#MJX-2-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="n" transform="translate(2601,0)"><use data-c="1D45B" xlink:href="#MJX-2-NCM-I-1D45B"></use></g><g data-mml-node="mi" data-latex="c" transform="translate(3201,0)"><use data-c="1D450" xlink:href="#MJX-2-NCM-I-1D450"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(3634,0)"><use data-c="1D452" xlink:href="#MJX-2-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="N" transform="translate(4100,0)"><use data-c="1D441" xlink:href="#MJX-2-NCM-I-1D441"></use></g><g data-mml-node="mi" data-latex="u" transform="translate(4981,0)"><use data-c="1D462" xlink:href="#MJX-2-NCM-I-1D462"></use></g><g data-mml-node="mi" data-latex="m" transform="translate(5553,0)"><use data-c="1D45A" xlink:href="#MJX-2-NCM-I-1D45A"></use></g></g></g></svg> 是当前 WriteBatch 所有操作的基准序列号，即 WriteBatch 中第一个操作的序列号为 <svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="18.447ex" height="2.034ex" role="img" focusable="false" viewBox="0 -705 8153.4 899" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-3-NCM-I-1D446" d="M133 157C133 181 136 201 141 217C141 227 136 232 125 232C120 232 116 230 114 228C109 223 52 8 52-8C52-17 57-22 67-22C72-22 79-17 88-6L133 47C168 1 224-22 300-22C366-22 424 5 476 58C528 111 554 170 554 236C554 283 538 323 505 355C490 368 470 379 445 388C422 393 400 399 378 405L312 423C279 432 254 469 254 509C254 552 271 589 306 621C341 653 380 669 423 669C515 669 561 619 561 520C561 502 557 482 557 465L557 462C560 455 565 451 573 451C582 451 588 459 592 474L645 691C645 700 640 705 630 705C625 705 618 700 609 689L566 637C538 682 491 705 424 705C361 705 304 681 254 634C202 586 176 531 176 468C176 396 223 339 282 323L387 296C441 281 475 262 475 195C475 149 457 108 422 72C387 36 347 17 302 17C204 17 133 60 133 157Z"></path><path id="MJX-3-NCM-I-1D452" d="M124 129C124 153 129 186 139 227L188 227C253 227 303 235 339 250C372 264 394 284 405 309C412 326 415 342 415 355C415 410 363 442 307 442C268 442 229 432 190 412C113 372 46 281 46 171C46 69 105-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 124 72 124 129M375 355C375 289 311 256 182 256L147 256C166 322 194 366 232 387C262 404 287 413 307 413C343 413 375 391 375 355Z"></path><path id="MJX-3-NCM-I-1D45E" d="M372 377C352 420 321 442 280 442C215 442 158 409 109 342C63 280 40 216 40 149C40 62 90-13 173-13C209-13 245 4 282 38L241-126C238-141 229-150 215-153C210-154 197-155 174-155C168-156 164-156 162-156C153-157 148-165 148-179L148-183C151-190 157-194 165-194C184-194 244-191 263-191C282-191 345-194 364-194C378-194 385-186 385-170C385-160 375-155 356-155C338-155 313-156 313-144C313-140 314-133 317-123L452 427C452 436 447 441 438 441C420 441 382 391 372 377M340 373C349 352 354 338 354 329C354 328 353 322 351 313L327 216C308 144 299 107 298 105C279 70 224 16 176 16C137 16 117 46 117 105C117 151 148 263 162 300C181 347 225 412 280 412C307 412 327 399 340 373Z"></path><path id="MJX-3-NCM-I-1D462" d="M543 144C543 153 538 158 527 158C518 158 513 151 510 137C505 118 500 99 493 80C480 39 462 18 440 18C422 18 413 32 413 60C413 77 420 111 433 161L460 267C469 303 477 328 483 359L489 386C491 393 492 398 492 401C492 421 481 431 459 431C437 431 423 419 417 394L343 98C342 95 338 88 330 76C314 50 275 18 235 18C197 18 178 44 178 95C178 136 196 202 231 294C242 324 248 345 248 357C248 407 213 442 163 442C118 442 83 417 58 367C39 328 29 301 29 287C29 278 34 273 45 273C58 273 60 279 64 293C87 373 119 413 160 413C174 413 181 403 181 384C181 369 175 348 164 319C126 218 107 148 107 111C107 34 155-11 232-11C275-11 314 9 347 50C361 9 391-11 437-11C506-11 527 70 543 144Z"></path><path id="MJX-3-NCM-I-1D45B" d="M537 137C514 58 481 18 440 18C427 18 420 28 420 47C420 61 426 84 438 115C478 224 498 296 498 333C498 403 451 442 381 442C322 442 271 416 230 363C222 407 187 442 136 442C80 442 58 390 44 345C34 313 29 294 29 287C29 278 34 273 45 273C50 273 53 274 56 276C61 285 64 292 65 299C83 375 106 413 133 413C151 413 160 399 160 371C160 358 155 331 144 290L87 63C84 50 78 24 78 19C78-1 89-11 111-11C130-11 144-1 151 19C153 24 159 49 170 92L191 181L221 295C232 318 249 341 270 365C299 397 335 413 378 413C411 413 427 391 427 348C427 310 406 234 363 120C356 102 353 87 353 74C353 25 390-11 438-11C482-11 517 14 542 64C561 104 571 131 571 144C571 153 566 158 555 158C552 158 537 149 537 137Z"></path><path id="MJX-3-NCM-I-1D450" d="M328 325C328 300 341 287 368 287C404 287 427 318 427 354C427 410 368 442 308 442C239 442 176 412 122 353C68 294 41 229 41 159C41 61 106-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 121 53 121 122C121 184 150 274 174 317C198 361 249 413 308 413C346 413 372 402 386 381C355 378 328 358 328 325Z"></path><path id="MJX-3-NCM-I-1D441" d="M864 683C845 683 783 680 764 680C745 680 682 683 663 683C648 683 641 675 641 659C641 650 648 645 663 644C705 644 726 631 726 605C726 599 725 592 724 585L616 157L401 662C393 681 391 683 366 683L233 683C209 683 200 681 200 659C200 649 211 644 232 644C274 644 295 643 296 640L163 110C154 71 131 49 95 42C69 39 39 43 39 15C39 5 45 0 56 0C74 0 136 3 155 3C174 3 238 0 257 0C272 0 279 8 279 24C279 33 271 38 255 39C214 40 194 53 194 78C194 83 195 90 197 100L326 611L576 21C582 7 590 0 599 0C608 0 614 8 618 24L757 574C770 625 798 643 860 644C874 645 881 653 881 669C878 678 877 683 864 683Z"></path><path id="MJX-3-NCM-I-1D45A" d="M657 442C596 442 543 412 498 353C489 412 451 442 383 442C324 442 273 416 231 363C223 407 188 442 137 442C96 442 66 409 45 344C34 312 29 293 29 287C29 278 34 273 45 273C50 273 53 274 56 276C61 285 64 292 66 299C84 375 107 413 134 413C152 413 161 399 161 371C161 358 156 331 145 290L88 63C84 51 79 25 79 19C79-1 90-11 111-11C131-11 145-1 152 19C153 24 160 49 171 92L192 181L222 295C233 318 250 341 272 365C301 397 337 413 380 413C413 413 429 391 429 348C429 335 424 308 414 267L387 153C380 124 364 64 356 32C355 25 354 21 354 19C354-1 365-11 387-11C398-11 406-8 413-1C428 14 429 21 435 48L494 285C497 298 511 321 535 353C565 393 605 413 654 413C687 413 703 391 703 348C703 309 683 236 642 129C633 106 629 87 629 74C629 25 666-11 714-11C759-11 793 14 818 64C838 104 848 131 848 144C848 153 843 158 832 158C825 157 818 148 813 137C791 58 759 18 716 18C703 18 696 28 696 47C696 62 702 84 714 115C755 222 775 295 775 333C775 404 728 442 657 442Z"></path><path id="MJX-3-NCM-N-2B" d="M698 274L413 274L413 559C413 575 405 583 389 583C373 583 365 575 365 559L365 274L80 274C64 274 56 266 56 250C56 234 64 226 80 226L365 226L365-59C365-75 373-83 389-83C405-83 413-75 413-59L413 226L698 226C714 226 722 234 722 250C722 263 711 274 698 274Z"></path><path id="MJX-3-NCM-N-30" d="M249-22C390-22 460 92 460 320C460 473 428 575 365 625C330 652 291 666 250 666C109 666 39 551 39 320C39 136 88-22 249-22M361 524C368 489 371 425 371 332C371 240 367 172 360 128C347 48 310 8 249 8C226 8 203 17 182 34C155 57 139 104 132 176C129 201 128 253 128 332C128 419 131 480 136 513C145 568 163 603 191 618C213 630 232 636 249 636C314 636 350 583 361 524Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="SequenceNum + 0"><g data-mml-node="mi" data-latex="S"><use data-c="1D446" xlink:href="#MJX-3-NCM-I-1D446"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(645,0)"><use data-c="1D452" xlink:href="#MJX-3-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="q" transform="translate(1111,0)"><use data-c="1D45E" xlink:href="#MJX-3-NCM-I-1D45E"></use></g><g data-mml-node="mi" data-latex="u" transform="translate(1563,0)"><use data-c="1D462" xlink:href="#MJX-3-NCM-I-1D462"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(2135,0)"><use data-c="1D452" xlink:href="#MJX-3-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="n" transform="translate(2601,0)"><use data-c="1D45B" xlink:href="#MJX-3-NCM-I-1D45B"></use></g><g data-mml-node="mi" data-latex="c" transform="translate(3201,0)"><use data-c="1D450" xlink:href="#MJX-3-NCM-I-1D450"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(3634,0)"><use data-c="1D452" xlink:href="#MJX-3-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="N" transform="translate(4100,0)"><use data-c="1D441" xlink:href="#MJX-3-NCM-I-1D441"></use></g><g data-mml-node="mi" data-latex="u" transform="translate(4981,0)"><use data-c="1D462" xlink:href="#MJX-3-NCM-I-1D462"></use></g><g data-mml-node="mi" data-latex="m" transform="translate(5553,0)"><use data-c="1D45A" xlink:href="#MJX-3-NCM-I-1D45A"></use></g><g data-mml-node="mo" data-latex="+" transform="translate(6653.2,0)"><use data-c="2B" xlink:href="#MJX-3-NCM-N-2B"></use></g><g data-mml-node="mn" data-latex="0" transform="translate(7653.4,0)"><use data-c="30" xlink:href="#MJX-3-NCM-N-30"></use></g></g></g></svg> ，第二个操作的序列号为 <svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="18.447ex" height="2.034ex" role="img" focusable="false" viewBox="0 -705 8153.4 899" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-4-NCM-I-1D446" d="M133 157C133 181 136 201 141 217C141 227 136 232 125 232C120 232 116 230 114 228C109 223 52 8 52-8C52-17 57-22 67-22C72-22 79-17 88-6L133 47C168 1 224-22 300-22C366-22 424 5 476 58C528 111 554 170 554 236C554 283 538 323 505 355C490 368 470 379 445 388C422 393 400 399 378 405L312 423C279 432 254 469 254 509C254 552 271 589 306 621C341 653 380 669 423 669C515 669 561 619 561 520C561 502 557 482 557 465L557 462C560 455 565 451 573 451C582 451 588 459 592 474L645 691C645 700 640 705 630 705C625 705 618 700 609 689L566 637C538 682 491 705 424 705C361 705 304 681 254 634C202 586 176 531 176 468C176 396 223 339 282 323L387 296C441 281 475 262 475 195C475 149 457 108 422 72C387 36 347 17 302 17C204 17 133 60 133 157Z"></path><path id="MJX-4-NCM-I-1D452" d="M124 129C124 153 129 186 139 227L188 227C253 227 303 235 339 250C372 264 394 284 405 309C412 326 415 342 415 355C415 410 363 442 307 442C268 442 229 432 190 412C113 372 46 281 46 171C46 69 105-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 124 72 124 129M375 355C375 289 311 256 182 256L147 256C166 322 194 366 232 387C262 404 287 413 307 413C343 413 375 391 375 355Z"></path><path id="MJX-4-NCM-I-1D45E" d="M372 377C352 420 321 442 280 442C215 442 158 409 109 342C63 280 40 216 40 149C40 62 90-13 173-13C209-13 245 4 282 38L241-126C238-141 229-150 215-153C210-154 197-155 174-155C168-156 164-156 162-156C153-157 148-165 148-179L148-183C151-190 157-194 165-194C184-194 244-191 263-191C282-191 345-194 364-194C378-194 385-186 385-170C385-160 375-155 356-155C338-155 313-156 313-144C313-140 314-133 317-123L452 427C452 436 447 441 438 441C420 441 382 391 372 377M340 373C349 352 354 338 354 329C354 328 353 322 351 313L327 216C308 144 299 107 298 105C279 70 224 16 176 16C137 16 117 46 117 105C117 151 148 263 162 300C181 347 225 412 280 412C307 412 327 399 340 373Z"></path><path id="MJX-4-NCM-I-1D462" d="M543 144C543 153 538 158 527 158C518 158 513 151 510 137C505 118 500 99 493 80C480 39 462 18 440 18C422 18 413 32 413 60C413 77 420 111 433 161L460 267C469 303 477 328 483 359L489 386C491 393 492 398 492 401C492 421 481 431 459 431C437 431 423 419 417 394L343 98C342 95 338 88 330 76C314 50 275 18 235 18C197 18 178 44 178 95C178 136 196 202 231 294C242 324 248 345 248 357C248 407 213 442 163 442C118 442 83 417 58 367C39 328 29 301 29 287C29 278 34 273 45 273C58 273 60 279 64 293C87 373 119 413 160 413C174 413 181 403 181 384C181 369 175 348 164 319C126 218 107 148 107 111C107 34 155-11 232-11C275-11 314 9 347 50C361 9 391-11 437-11C506-11 527 70 543 144Z"></path><path id="MJX-4-NCM-I-1D45B" d="M537 137C514 58 481 18 440 18C427 18 420 28 420 47C420 61 426 84 438 115C478 224 498 296 498 333C498 403 451 442 381 442C322 442 271 416 230 363C222 407 187 442 136 442C80 442 58 390 44 345C34 313 29 294 29 287C29 278 34 273 45 273C50 273 53 274 56 276C61 285 64 292 65 299C83 375 106 413 133 413C151 413 160 399 160 371C160 358 155 331 144 290L87 63C84 50 78 24 78 19C78-1 89-11 111-11C130-11 144-1 151 19C153 24 159 49 170 92L191 181L221 295C232 318 249 341 270 365C299 397 335 413 378 413C411 413 427 391 427 348C427 310 406 234 363 120C356 102 353 87 353 74C353 25 390-11 438-11C482-11 517 14 542 64C561 104 571 131 571 144C571 153 566 158 555 158C552 158 537 149 537 137Z"></path><path id="MJX-4-NCM-I-1D450" d="M328 325C328 300 341 287 368 287C404 287 427 318 427 354C427 410 368 442 308 442C239 442 176 412 122 353C68 294 41 229 41 159C41 61 106-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 121 53 121 122C121 184 150 274 174 317C198 361 249 413 308 413C346 413 372 402 386 381C355 378 328 358 328 325Z"></path><path id="MJX-4-NCM-I-1D441" d="M864 683C845 683 783 680 764 680C745 680 682 683 663 683C648 683 641 675 641 659C641 650 648 645 663 644C705 644 726 631 726 605C726 599 725 592 724 585L616 157L401 662C393 681 391 683 366 683L233 683C209 683 200 681 200 659C200 649 211 644 232 644C274 644 295 643 296 640L163 110C154 71 131 49 95 42C69 39 39 43 39 15C39 5 45 0 56 0C74 0 136 3 155 3C174 3 238 0 257 0C272 0 279 8 279 24C279 33 271 38 255 39C214 40 194 53 194 78C194 83 195 90 197 100L326 611L576 21C582 7 590 0 599 0C608 0 614 8 618 24L757 574C770 625 798 643 860 644C874 645 881 653 881 669C878 678 877 683 864 683Z"></path><path id="MJX-4-NCM-I-1D45A" d="M657 442C596 442 543 412 498 353C489 412 451 442 383 442C324 442 273 416 231 363C223 407 188 442 137 442C96 442 66 409 45 344C34 312 29 293 29 287C29 278 34 273 45 273C50 273 53 274 56 276C61 285 64 292 66 299C84 375 107 413 134 413C152 413 161 399 161 371C161 358 156 331 145 290L88 63C84 51 79 25 79 19C79-1 90-11 111-11C131-11 145-1 152 19C153 24 160 49 171 92L192 181L222 295C233 318 250 341 272 365C301 397 337 413 380 413C413 413 429 391 429 348C429 335 424 308 414 267L387 153C380 124 364 64 356 32C355 25 354 21 354 19C354-1 365-11 387-11C398-11 406-8 413-1C428 14 429 21 435 48L494 285C497 298 511 321 535 353C565 393 605 413 654 413C687 413 703 391 703 348C703 309 683 236 642 129C633 106 629 87 629 74C629 25 666-11 714-11C759-11 793 14 818 64C838 104 848 131 848 144C848 153 843 158 832 158C825 157 818 148 813 137C791 58 759 18 716 18C703 18 696 28 696 47C696 62 702 84 714 115C755 222 775 295 775 333C775 404 728 442 657 442Z"></path><path id="MJX-4-NCM-N-2B" d="M698 274L413 274L413 559C413 575 405 583 389 583C373 583 365 575 365 559L365 274L80 274C64 274 56 266 56 250C56 234 64 226 80 226L365 226L365-59C365-75 373-83 389-83C405-83 413-75 413-59L413 226L698 226C714 226 722 234 722 250C722 263 711 274 698 274Z"></path><path id="MJX-4-NCM-N-31" d="M269 666C228 624 168 603 89 603L89 564C141 564 184 572 217 588L217 82C217 64 213 52 204 47C195 42 170 39 130 39L95 39L95 0C120 2 174 3 257 3C340 3 394 2 419 0L419 39L384 39C343 39 318 42 310 47C302 52 297 64 297 82L297 636C297 660 295 666 269 666Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="SequenceNum + 1"><g data-mml-node="mi" data-latex="S"><use data-c="1D446" xlink:href="#MJX-4-NCM-I-1D446"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(645,0)"><use data-c="1D452" xlink:href="#MJX-4-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="q" transform="translate(1111,0)"><use data-c="1D45E" xlink:href="#MJX-4-NCM-I-1D45E"></use></g><g data-mml-node="mi" data-latex="u" transform="translate(1563,0)"><use data-c="1D462" xlink:href="#MJX-4-NCM-I-1D462"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(2135,0)"><use data-c="1D452" xlink:href="#MJX-4-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="n" transform="translate(2601,0)"><use data-c="1D45B" xlink:href="#MJX-4-NCM-I-1D45B"></use></g><g data-mml-node="mi" data-latex="c" transform="translate(3201,0)"><use data-c="1D450" xlink:href="#MJX-4-NCM-I-1D450"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(3634,0)"><use data-c="1D452" xlink:href="#MJX-4-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="N" transform="translate(4100,0)"><use data-c="1D441" xlink:href="#MJX-4-NCM-I-1D441"></use></g><g data-mml-node="mi" data-latex="u" transform="translate(4981,0)"><use data-c="1D462" xlink:href="#MJX-4-NCM-I-1D462"></use></g><g data-mml-node="mi" data-latex="m" transform="translate(5553,0)"><use data-c="1D45A" xlink:href="#MJX-4-NCM-I-1D45A"></use></g><g data-mml-node="mo" data-latex="+" transform="translate(6653.2,0)"><use data-c="2B" xlink:href="#MJX-4-NCM-N-2B"></use></g><g data-mml-node="mn" data-latex="1" transform="translate(7653.4,0)"><use data-c="31" xlink:href="#MJX-4-NCM-N-31"></use></g></g></g></svg>，依次类推。为每次操作分配一个唯一的序列号，是为了方便实现快照能力。后面再解释。</p>
<h2>2、写入缓冲与攒批</h2>
<img src='../plantuml-images/12524554170754623315.svg' title='12524554170754623315' alt='12524554170754623315'/>
<p class="text-align-justify">leveldb 的 write 写入过程基于 Writer （双端）队列实现缓冲和可能的攒批（合并多个 WriteBatch），提升写入的吞吐性能。攒批的性能空间来自 - 如果写入时发现 level0 文件过多（compaction 未完成，影响读/检索性能），则认为需要对写入进行限速，将写入先在 Write 队列中缓冲，攒 1ms 左右，合并成一个大的 WriteBatch 然后写入 memtable。</p>
<img src='https://s2.loli.net/2025/08/06/u1IYKbz4exfp823.png' title='write-deque' alt='write-deque' width='450'/>
<p class="text-align-justify">如果本次写入的 Writer 为队列头部，则说明当前写入压力应该不大，可以直接进行写入操作 -</p>
<ul><li>1、先确认写入条件是否满足：
<ul><li>(1) level0 文件数是否超过阈值（8），如果超过，说明写入压力有点大（都来不及 minor compaction 啦），则释放互斥锁，当前线程休眠 1ms（攒批的性能空间在这！）</li>
<li>（2） 如果当前 memtable 空间已满（默认大小 4MB，可配置），并且前一个 memtable（当前已不可变）还没有被 compaction 落盘或者 level0 文件数操作更大的一个阈值（12），则等待后台 compaction 完成</li>
<li>（3） 如果当前 memtable 空间已满，但是前一个 memtable 已被 compaction 且 level0 文件数也不多，则将当前 memtable 切换为不可变 memtable，并申请一个新的 memtable，同时清理掉当前的 WAL log 文件，准备个新的 WAL log 文件。</li></ul></li>
<li>2、遍历 Writer 队列，直到队尾或者遇到一个非异步写入操作或者达到攒批大小阈值，将遍历到的 Writer 中的 WriteBatch 合并成一个 WriteBatch</li>
<li>3、将合并后的 WriteBatch 的 <code>rep_</code> 先写入 WAL log 文件</li>
<li>4、然后将 WriteBatch 中的操作按序解析出来，写入 memtable (Put 或 Delete)。</li></ul>
<p class="text-align-justify">如果本次写入的 Writer 非队列的头部，等待之前写入队列的线程攒批处理，以及最后被唤醒。</p>
<p class="text-align-justify">如果不考虑等待 compaction，整个写入过程最慢的步骤是写 WAL 日志，所以 WriteBatch 设计是为 WAL 日志写入优化的，对于 memtable 写入反而多了一点解析的性能开销。</p>
<h2>3、WAL log 文件</h2>
<pre class="language-cpp"><code>static const int kBlockSize = 32768;

// Header is checksum (4 bytes), length (2 bytes), type (1 byte).  
static const int kHeaderSize = 4 + 2 + 1;</code></pre>
<img src='https://s2.loli.net/2025/08/06/SD7BfQIMl2GZaTj.png' title='wal-log-format' alt='wal-log-format' width='800'/>
<p class="text-align-justify">leveldb 会将 WriteBatch 的 <code>rep_</code> 当作字节序列写入 log 文件中。不过 log 文件存储的单元结构为块（block），块大小为 32768 字节。一个 WriteBatch 的 <code>rep_</code> 的大小可能大于/等于/小于一个块大小，也就是写入一个 <code>rep_</code> 可能填不满一个块或者正好填满一个块或者跨多个块。</p>
<p class="text-align-justify">如果一次写入后，当前 block 剩余的空间不足以填充下一次写入的头部，则直接将剩余空间以 <code>\x00</code> 填满。</p>
<p class="text-align-justify">这样编码的好处？- 读取解析时，按块大小进行读取，速度更快，顺序解析也方便。</p>
<p class="text-align-justify">“WAL log” 的核心作用：写入 memtable 的键值对数据，并没有落盘到 ldb 数据库文件中，如果在 minor compaction 成 <svg style="vertical-align: -0.375ex;" xmlns="http://www.w3.org/2000/svg" width="5.542ex" height="1.945ex" role="img" focusable="false" viewBox="0 -694 2449.6 859.6" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-5-NCM-I-1D459" d="M173 632L49 119C46 105 44 93 44 84C44 31 83-11 136-11C185-11 220 41 241 145C241 154 236 159 225 159C217 159 211 152 208 138C188 59 165 19 138 19C121 19 113 33 113 60C113 75 115 91 119 107L258 679L258 683C255 690 249 694 242 694C210 694 136 685 124 684C109 682 102 674 102 659C102 650 111 645 130 645C147 645 173 645 173 632Z"></path><path id="MJX-5-NCM-I-1D452" d="M124 129C124 153 129 186 139 227L188 227C253 227 303 235 339 250C372 264 394 284 405 309C412 326 415 342 415 355C415 410 363 442 307 442C268 442 229 432 190 412C113 372 46 281 46 171C46 69 105-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 124 72 124 129M375 355C375 289 311 256 182 256L147 256C166 322 194 366 232 387C262 404 287 413 307 413C343 413 375 391 375 355Z"></path><path id="MJX-5-NCM-I-1D463" d="M369 391C369 383 378 370 394 350C410 330 418 307 418 281C418 252 404 203 375 134C354 86 306 18 247 18C201 18 178 45 178 100C178 139 197 208 235 307C243 328 247 345 247 357C247 407 213 442 163 442C119 442 84 417 59 367C39 326 29 300 29 287C29 278 34 273 45 273C58 273 60 279 64 293C87 373 119 413 160 413C173 413 180 404 180 385C180 369 175 347 164 318C127 219 108 152 108 115C108 64 125 29 159 10C186-4 214-11 243-11C332-11 394 85 420 162C452 256 468 325 468 369C468 418 452 442 421 442C396 442 369 416 369 391Z"></path><path id="MJX-5-NCM-N-30" d="M249-22C390-22 460 92 460 320C460 473 428 575 365 625C330 652 291 666 250 666C109 666 39 551 39 320C39 136 88-22 249-22M361 524C368 489 371 425 371 332C371 240 367 172 360 128C347 48 310 8 249 8C226 8 203 17 182 34C155 57 139 104 132 176C129 201 128 253 128 332C128 419 131 480 136 513C145 568 163 603 191 618C213 630 232 636 249 636C314 636 350 583 361 524Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="level_0"><g data-mml-node="mi" data-latex="l"><use data-c="1D459" xlink:href="#MJX-5-NCM-I-1D459"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(298,0)"><use data-c="1D452" xlink:href="#MJX-5-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="v" transform="translate(764,0)"><use data-c="1D463" xlink:href="#MJX-5-NCM-I-1D463"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(1249,0)"><use data-c="1D452" xlink:href="#MJX-5-NCM-I-1D452"></use></g><g data-mml-node="msub" data-latex="l_0" transform="translate(1715,0)"><g data-mml-node="mi" data-latex="l"><use data-c="1D459" xlink:href="#MJX-5-NCM-I-1D459"></use></g><g data-mml-node="mn" transform="translate(331,-150) scale(0.707)" data-latex="0"><use data-c="30" xlink:href="#MJX-5-NCM-N-30"></use></g></g></g></g></svg> 文件之前，机器节点故障，导致 memtable 以及不可变 memtable 中的数据丢失，还可以通过“WAL log” 文件内容来恢复。</p>
<p class="text-align-justify">那也意味着，如果一旦不可变 memtable 数据 compaction 到 <svg style="vertical-align: -0.375ex;" xmlns="http://www.w3.org/2000/svg" width="5.542ex" height="1.945ex" role="img" focusable="false" viewBox="0 -694 2449.6 859.6" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-6-NCM-I-1D459" d="M173 632L49 119C46 105 44 93 44 84C44 31 83-11 136-11C185-11 220 41 241 145C241 154 236 159 225 159C217 159 211 152 208 138C188 59 165 19 138 19C121 19 113 33 113 60C113 75 115 91 119 107L258 679L258 683C255 690 249 694 242 694C210 694 136 685 124 684C109 682 102 674 102 659C102 650 111 645 130 645C147 645 173 645 173 632Z"></path><path id="MJX-6-NCM-I-1D452" d="M124 129C124 153 129 186 139 227L188 227C253 227 303 235 339 250C372 264 394 284 405 309C412 326 415 342 415 355C415 410 363 442 307 442C268 442 229 432 190 412C113 372 46 281 46 171C46 69 105-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 124 72 124 129M375 355C375 289 311 256 182 256L147 256C166 322 194 366 232 387C262 404 287 413 307 413C343 413 375 391 375 355Z"></path><path id="MJX-6-NCM-I-1D463" d="M369 391C369 383 378 370 394 350C410 330 418 307 418 281C418 252 404 203 375 134C354 86 306 18 247 18C201 18 178 45 178 100C178 139 197 208 235 307C243 328 247 345 247 357C247 407 213 442 163 442C119 442 84 417 59 367C39 326 29 300 29 287C29 278 34 273 45 273C58 273 60 279 64 293C87 373 119 413 160 413C173 413 180 404 180 385C180 369 175 347 164 318C127 219 108 152 108 115C108 64 125 29 159 10C186-4 214-11 243-11C332-11 394 85 420 162C452 256 468 325 468 369C468 418 452 442 421 442C396 442 369 416 369 391Z"></path><path id="MJX-6-NCM-N-30" d="M249-22C390-22 460 92 460 320C460 473 428 575 365 625C330 652 291 666 250 666C109 666 39 551 39 320C39 136 88-22 249-22M361 524C368 489 371 425 371 332C371 240 367 172 360 128C347 48 310 8 249 8C226 8 203 17 182 34C155 57 139 104 132 176C129 201 128 253 128 332C128 419 131 480 136 513C145 568 163 603 191 618C213 630 232 636 249 636C314 636 350 583 361 524Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="level_0"><g data-mml-node="mi" data-latex="l"><use data-c="1D459" xlink:href="#MJX-6-NCM-I-1D459"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(298,0)"><use data-c="1D452" xlink:href="#MJX-6-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="v" transform="translate(764,0)"><use data-c="1D463" xlink:href="#MJX-6-NCM-I-1D463"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(1249,0)"><use data-c="1D452" xlink:href="#MJX-6-NCM-I-1D452"></use></g><g data-mml-node="msub" data-latex="l_0" transform="translate(1715,0)"><g data-mml-node="mi" data-latex="l"><use data-c="1D459" xlink:href="#MJX-6-NCM-I-1D459"></use></g><g data-mml-node="mn" transform="translate(331,-150) scale(0.707)" data-latex="0"><use data-c="30" xlink:href="#MJX-6-NCM-N-30"></use></g></g></g></g></svg> 文件后，这些数据状态对应的“WAL log” 内容就没没有实际用处了，可以及时清理掉。</p>
<p class="text-align-justify">leveldb 写入数据时，如果发现 memtable 占用内存已达到阈值，并且不可变 memtable 数据已被 minor compaction 成 <svg style="vertical-align: -0.375ex;" xmlns="http://www.w3.org/2000/svg" width="5.542ex" height="1.945ex" role="img" focusable="false" viewBox="0 -694 2449.6 859.6" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-7-NCM-I-1D459" d="M173 632L49 119C46 105 44 93 44 84C44 31 83-11 136-11C185-11 220 41 241 145C241 154 236 159 225 159C217 159 211 152 208 138C188 59 165 19 138 19C121 19 113 33 113 60C113 75 115 91 119 107L258 679L258 683C255 690 249 694 242 694C210 694 136 685 124 684C109 682 102 674 102 659C102 650 111 645 130 645C147 645 173 645 173 632Z"></path><path id="MJX-7-NCM-I-1D452" d="M124 129C124 153 129 186 139 227L188 227C253 227 303 235 339 250C372 264 394 284 405 309C412 326 415 342 415 355C415 410 363 442 307 442C268 442 229 432 190 412C113 372 46 281 46 171C46 69 105-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 124 72 124 129M375 355C375 289 311 256 182 256L147 256C166 322 194 366 232 387C262 404 287 413 307 413C343 413 375 391 375 355Z"></path><path id="MJX-7-NCM-I-1D463" d="M369 391C369 383 378 370 394 350C410 330 418 307 418 281C418 252 404 203 375 134C354 86 306 18 247 18C201 18 178 45 178 100C178 139 197 208 235 307C243 328 247 345 247 357C247 407 213 442 163 442C119 442 84 417 59 367C39 326 29 300 29 287C29 278 34 273 45 273C58 273 60 279 64 293C87 373 119 413 160 413C173 413 180 404 180 385C180 369 175 347 164 318C127 219 108 152 108 115C108 64 125 29 159 10C186-4 214-11 243-11C332-11 394 85 420 162C452 256 468 325 468 369C468 418 452 442 421 442C396 442 369 416 369 391Z"></path><path id="MJX-7-NCM-N-30" d="M249-22C390-22 460 92 460 320C460 473 428 575 365 625C330 652 291 666 250 666C109 666 39 551 39 320C39 136 88-22 249-22M361 524C368 489 371 425 371 332C371 240 367 172 360 128C347 48 310 8 249 8C226 8 203 17 182 34C155 57 139 104 132 176C129 201 128 253 128 332C128 419 131 480 136 513C145 568 163 603 191 618C213 630 232 636 249 636C314 636 350 583 361 524Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="level_0"><g data-mml-node="mi" data-latex="l"><use data-c="1D459" xlink:href="#MJX-7-NCM-I-1D459"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(298,0)"><use data-c="1D452" xlink:href="#MJX-7-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="v" transform="translate(764,0)"><use data-c="1D463" xlink:href="#MJX-7-NCM-I-1D463"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(1249,0)"><use data-c="1D452" xlink:href="#MJX-7-NCM-I-1D452"></use></g><g data-mml-node="msub" data-latex="l_0" transform="translate(1715,0)"><g data-mml-node="mi" data-latex="l"><use data-c="1D459" xlink:href="#MJX-7-NCM-I-1D459"></use></g><g data-mml-node="mn" transform="translate(331,-150) scale(0.707)" data-latex="0"><use data-c="30" xlink:href="#MJX-7-NCM-N-30"></use></g></g></g></g></svg> 文件，则会将 memtable 切换成不可变 memtable，同时创建一个新的“WAL log”，并申请一个新的 memtable。不过此时新的不可变 memtable 还没被 minor compaction 成 <svg style="vertical-align: -0.375ex;" xmlns="http://www.w3.org/2000/svg" width="5.542ex" height="1.945ex" role="img" focusable="false" viewBox="0 -694 2449.6 859.6" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-8-NCM-I-1D459" d="M173 632L49 119C46 105 44 93 44 84C44 31 83-11 136-11C185-11 220 41 241 145C241 154 236 159 225 159C217 159 211 152 208 138C188 59 165 19 138 19C121 19 113 33 113 60C113 75 115 91 119 107L258 679L258 683C255 690 249 694 242 694C210 694 136 685 124 684C109 682 102 674 102 659C102 650 111 645 130 645C147 645 173 645 173 632Z"></path><path id="MJX-8-NCM-I-1D452" d="M124 129C124 153 129 186 139 227L188 227C253 227 303 235 339 250C372 264 394 284 405 309C412 326 415 342 415 355C415 410 363 442 307 442C268 442 229 432 190 412C113 372 46 281 46 171C46 69 105-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 124 72 124 129M375 355C375 289 311 256 182 256L147 256C166 322 194 366 232 387C262 404 287 413 307 413C343 413 375 391 375 355Z"></path><path id="MJX-8-NCM-I-1D463" d="M369 391C369 383 378 370 394 350C410 330 418 307 418 281C418 252 404 203 375 134C354 86 306 18 247 18C201 18 178 45 178 100C178 139 197 208 235 307C243 328 247 345 247 357C247 407 213 442 163 442C119 442 84 417 59 367C39 326 29 300 29 287C29 278 34 273 45 273C58 273 60 279 64 293C87 373 119 413 160 413C173 413 180 404 180 385C180 369 175 347 164 318C127 219 108 152 108 115C108 64 125 29 159 10C186-4 214-11 243-11C332-11 394 85 420 162C452 256 468 325 468 369C468 418 452 442 421 442C396 442 369 416 369 391Z"></path><path id="MJX-8-NCM-N-30" d="M249-22C390-22 460 92 460 320C460 473 428 575 365 625C330 652 291 666 250 666C109 666 39 551 39 320C39 136 88-22 249-22M361 524C368 489 371 425 371 332C371 240 367 172 360 128C347 48 310 8 249 8C226 8 203 17 182 34C155 57 139 104 132 176C129 201 128 253 128 332C128 419 131 480 136 513C145 568 163 603 191 618C213 630 232 636 249 636C314 636 350 583 361 524Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="level_0"><g data-mml-node="mi" data-latex="l"><use data-c="1D459" xlink:href="#MJX-8-NCM-I-1D459"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(298,0)"><use data-c="1D452" xlink:href="#MJX-8-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="v" transform="translate(764,0)"><use data-c="1D463" xlink:href="#MJX-8-NCM-I-1D463"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(1249,0)"><use data-c="1D452" xlink:href="#MJX-8-NCM-I-1D452"></use></g><g data-mml-node="msub" data-latex="l_0" transform="translate(1715,0)"><g data-mml-node="mi" data-latex="l"><use data-c="1D459" xlink:href="#MJX-8-NCM-I-1D459"></use></g><g data-mml-node="mn" transform="translate(331,-150) scale(0.707)" data-latex="0"><use data-c="30" xlink:href="#MJX-8-NCM-N-30"></use></g></g></g></g></svg> 文件，所以前一个“WAL log”文件也还要保留，不能删除。</p>
<h2>4、MemTable</h2>
<img src='../plantuml-images/12787296856683968814.svg' title='12787296856683968814' alt='12787296856683968814'/>
<pre class="language-cpp"><code>typedef SkipList<const char*, KeyComparator> Table;</code></pre>
<p class="text-align-justify">MemTable 是对应一个“WAL log” 文件的内存存储结构。<u>单个 MemTable 内存占用阈值为 4MB(<code>write_buffer_size</code>)</u>，当可变 MemTable 的内存占用达到阈值时，就尝试切换成不可变 MemTable，并创建一个新的 WAL log 文件以及对应的可变 MemTable 来承接写入，而不可变 MemTable 的内容等待被 minor compaction 刷成一个 <svg style="vertical-align: -0.375ex;" xmlns="http://www.w3.org/2000/svg" width="5.542ex" height="1.945ex" role="img" focusable="false" viewBox="0 -694 2449.6 859.6" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-9-NCM-I-1D459" d="M173 632L49 119C46 105 44 93 44 84C44 31 83-11 136-11C185-11 220 41 241 145C241 154 236 159 225 159C217 159 211 152 208 138C188 59 165 19 138 19C121 19 113 33 113 60C113 75 115 91 119 107L258 679L258 683C255 690 249 694 242 694C210 694 136 685 124 684C109 682 102 674 102 659C102 650 111 645 130 645C147 645 173 645 173 632Z"></path><path id="MJX-9-NCM-I-1D452" d="M124 129C124 153 129 186 139 227L188 227C253 227 303 235 339 250C372 264 394 284 405 309C412 326 415 342 415 355C415 410 363 442 307 442C268 442 229 432 190 412C113 372 46 281 46 171C46 69 105-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 124 72 124 129M375 355C375 289 311 256 182 256L147 256C166 322 194 366 232 387C262 404 287 413 307 413C343 413 375 391 375 355Z"></path><path id="MJX-9-NCM-I-1D463" d="M369 391C369 383 378 370 394 350C410 330 418 307 418 281C418 252 404 203 375 134C354 86 306 18 247 18C201 18 178 45 178 100C178 139 197 208 235 307C243 328 247 345 247 357C247 407 213 442 163 442C119 442 84 417 59 367C39 326 29 300 29 287C29 278 34 273 45 273C58 273 60 279 64 293C87 373 119 413 160 413C173 413 180 404 180 385C180 369 175 347 164 318C127 219 108 152 108 115C108 64 125 29 159 10C186-4 214-11 243-11C332-11 394 85 420 162C452 256 468 325 468 369C468 418 452 442 421 442C396 442 369 416 369 391Z"></path><path id="MJX-9-NCM-N-30" d="M249-22C390-22 460 92 460 320C460 473 428 575 365 625C330 652 291 666 250 666C109 666 39 551 39 320C39 136 88-22 249-22M361 524C368 489 371 425 371 332C371 240 367 172 360 128C347 48 310 8 249 8C226 8 203 17 182 34C155 57 139 104 132 176C129 201 128 253 128 332C128 419 131 480 136 513C145 568 163 603 191 618C213 630 232 636 249 636C314 636 350 583 361 524Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="level_0"><g data-mml-node="mi" data-latex="l"><use data-c="1D459" xlink:href="#MJX-9-NCM-I-1D459"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(298,0)"><use data-c="1D452" xlink:href="#MJX-9-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="v" transform="translate(764,0)"><use data-c="1D463" xlink:href="#MJX-9-NCM-I-1D463"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(1249,0)"><use data-c="1D452" xlink:href="#MJX-9-NCM-I-1D452"></use></g><g data-mml-node="msub" data-latex="l_0" transform="translate(1715,0)"><g data-mml-node="mi" data-latex="l"><use data-c="1D459" xlink:href="#MJX-9-NCM-I-1D459"></use></g><g data-mml-node="mn" transform="translate(331,-150) scale(0.707)" data-latex="0"><use data-c="30" xlink:href="#MJX-9-NCM-N-30"></use></g></g></g></g></svg> ldb 数据文件。</p>
<pre class="language-cpp"><code>// Amount of data to build up in memory (backed by an unsorted log  
// on disk) before converting to a sorted on-disk file.  
//  
// Larger values increase performance, especially during bulk loads.  
// Up to two write buffers may be held in memory at the same time,  
// so you may wish to adjust this parameter to control memory usage.  
// Also, a larger write buffer will result in a longer recovery time  
// the next time the database is opened.  
size_t write_buffer_size = 4 * 1024 * 1024;</code></pre>
<h3>4.1 Arena</h3>
<p class="text-align-justify">Arena 的特点是整块内存申请，整块内存一次性释放，从而优化内存的申请释放开销。</p>
<p class="text-align-justify">leveldb 里 Arena 的生命周期与 MemTable 对象保持一致，MemTable 对象的所有 Add 操作涉及的内存分配都在同一 Arena 对象上进行， MemTable 对象切换成不可变状态并存储为 level0 ldb 文件后，Arena 对象的所有内存块随着 MemTable 对象析构而一次性释放。</p>
<pre class="language-cpp"><code>static const int kBlockSize = 4096;</code></pre>
<img src='https://s2.loli.net/2025/08/06/iVjaX9OwJbPMStU.png' title='memtable-arena' alt='memtable-arena' width='800'/>
<p class="text-align-justify">从 Arena 申请内存空间时，如果最新一个可用块的剩余内存大小（<code>alloc_bytes_remaining_</code>）小于当前申请的内存大小 bytes，则先申请一个新的内存块，然后从新内存块上分配内存空间 - 如果当前申请的内存大小大于整块大小的 1/4，则单独占用一个内存块。</p>
<p class="text-align-justify">所以 Arena 内存块大小必须大于实际一次申请的最大内存，并且为减少内存碎片，应该要根据代码中实际的内存分配情况来确定 Arena 内存块大小。</p>
<p class="text-align-justify">MemTable 的 Arena 内存块大小只有一种。有些项目中内存分配情况比较复杂的话，其 Arena 设计通常会使用多种内存块大小 ，以此提高灵活性，减少内存碎片浪费。</p>
<h3>4.2 Table - 跳表</h3>
<p class="text-align-justify">跳表可以兼顾有序链表的快速查找、快速插入/删除、遍历，算法复杂度 <svg style="vertical-align: -0.561ex;" xmlns="http://www.w3.org/2000/svg" width="8.33ex" height="2.253ex" role="img" focusable="false" viewBox="0 -748 3682 996" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-10-NCM-I-1D442" d="M702 263C727 320 740 377 740 435C740 513 717 577 670 628C623 679 561 705 484 705C431 705 378 692 325 666C217 613 138 529 87 415C62 359 49 303 49 246C49 167 72 103 119 53C166 3 228-22 306-22C358-22 410-9 463 16C572 69 651 152 702 263M644 474C644 341 584 208 520 129C476 74 400 12 312 12C205 12 149 105 149 218C149 253 156 300 169 357C196 475 264 579 353 633C396 659 438 672 478 672C586 672 644 586 644 474Z"></path><path id="MJX-10-NCM-N-28" d="M318-248C327-248 332-243 332-234C332-231 330-227 327-223C275-183 233-117 202-26C175 53 161 131 161 208L161 292C161 369 175 447 202 526C233 617 275 683 327 723C330 726 332 730 332 734C332 743 327 748 318 748C317 748 314 747 311 745C251 699 201 631 160 540C121 453 101 371 101 292L101 208C101 129 121 47 160-40C201-131 251-199 311-245C314-247 317-248 318-248Z"></path><path id="MJX-10-NCM-I-1D459" d="M173 632L49 119C46 105 44 93 44 84C44 31 83-11 136-11C185-11 220 41 241 145C241 154 236 159 225 159C217 159 211 152 208 138C188 59 165 19 138 19C121 19 113 33 113 60C113 75 115 91 119 107L258 679L258 683C255 690 249 694 242 694C210 694 136 685 124 684C109 682 102 674 102 659C102 650 111 645 130 645C147 645 173 645 173 632Z"></path><path id="MJX-10-NCM-I-1D45C" d="M308 442C239 442 176 412 122 353C68 294 41 229 41 159C41 63 106-11 202-11C272-11 334 19 388 78C442 137 469 201 469 272C469 369 405 442 308 442M389 310C389 287 384 255 374 213C353 130 319 73 272 42C248 26 225 18 203 18C149 18 121 65 121 122C121 180 155 288 178 324C216 383 259 413 307 413C361 413 389 367 389 310Z"></path><path id="MJX-10-NCM-I-1D454" d="M15-141C15-184 60-205 150-205C197-205 241-193 280-170C324-144 351-109 362-66L471 373C473 383 474 389 474 392C474 412 463 422 442 422C420 422 406 410 399 387C377 424 347 442 310 442C246 442 189 410 140 346C95 286 72 223 72 158C72 71 123-3 207-3C246-3 282 14 315 47L285-71C256-140 211-175 148-175C122-175 100-173 82-169C103-158 113-141 113-118C113-93 99-80 72-80C40-80 15-109 15-141M356 392C376 371 386 351 386 331C386 330 385 325 383 318L336 129C330 106 313 82 286 60C259 38 233 27 210 27C170 27 150 56 150 114C150 169 184 291 204 327C235 384 270 412 311 412C329 412 344 405 356 392Z"></path><path id="MJX-10-NCM-I-1D441" d="M864 683C845 683 783 680 764 680C745 680 682 683 663 683C648 683 641 675 641 659C641 650 648 645 663 644C705 644 726 631 726 605C726 599 725 592 724 585L616 157L401 662C393 681 391 683 366 683L233 683C209 683 200 681 200 659C200 649 211 644 232 644C274 644 295 643 296 640L163 110C154 71 131 49 95 42C69 39 39 43 39 15C39 5 45 0 56 0C74 0 136 3 155 3C174 3 238 0 257 0C272 0 279 8 279 24C279 33 271 38 255 39C214 40 194 53 194 78C194 83 195 90 197 100L326 611L576 21C582 7 590 0 599 0C608 0 614 8 618 24L757 574C770 625 798 643 860 644C874 645 881 653 881 669C878 678 877 683 864 683Z"></path><path id="MJX-10-NCM-N-29" d="M78-245C138-199 188-131 229-40C268 47 288 129 288 208L288 292C288 371 268 453 229 540C188 631 138 699 78 745C75 747 72 748 71 748C62 748 57 743 57 734C57 730 59 726 62 723C114 683 156 617 187 526C214 447 228 369 228 292L228 208C228 131 214 53 187-26C156-117 114-183 62-223C59-227 57-231 57-234C57-243 62-248 71-248C72-248 75-247 78-245Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="O(logN)"><g data-mml-node="mi" data-latex="O"><use data-c="1D442" xlink:href="#MJX-10-NCM-I-1D442"></use></g><g data-mml-node="mo" data-latex="(" transform="translate(763,0)"><use data-c="28" xlink:href="#MJX-10-NCM-N-28"></use></g><g data-mml-node="mi" data-latex="l" transform="translate(1152,0)"><use data-c="1D459" xlink:href="#MJX-10-NCM-I-1D459"></use></g><g data-mml-node="mi" data-latex="o" transform="translate(1450,0)"><use data-c="1D45C" xlink:href="#MJX-10-NCM-I-1D45C"></use></g><g data-mml-node="mi" data-latex="g" transform="translate(1935,0)"><use data-c="1D454" xlink:href="#MJX-10-NCM-I-1D454"></use></g><g data-mml-node="mi" data-latex="N" transform="translate(2412,0)"><use data-c="1D441" xlink:href="#MJX-10-NCM-I-1D441"></use></g><g data-mml-node="mo" data-latex=")" transform="translate(3293,0)"><use data-c="29" xlink:href="#MJX-10-NCM-N-29"></use></g></g></g></svg>，实现简单。</p>
<blockquote><p class="text-align-justify"><a href='https://opendatastructures.org/newhtml/ods/latex-saved-html/skiplists.html'>Open Data Structures - Skiplists</a></p></blockquote>
<p class="text-align-justify"><strong>查找过程示意图</strong></p>
<img src='../assets/leveldb/skiplist-searchpath.svg' title='skiplist-search-path' alt='skiplist-search-path' width='800'/>
<p class="text-align-justify"><strong>插入过程示意图</strong></p>
<img src='../assets/leveldb/skiplist-add.svg' title='skiplist-add' alt='skiplist-add' width='800'/>
<p class="text-align-justify"><strong>跳表定义</strong></p>
<pre class="language-cpp"><code>template <typename Key, class Comparator>  
class SkipList {
public:
  explicit SkipList(Comparator cmp, Arena* arena);
  void Insert(const Key& key);
  bool Contains(const Key& key) const;
private:
  Comparator const compare_;  
  Arena* const arena_;  // Arena used for allocations of nodes  
  Node* const head_;
  // Modified only by Insert().  Read racily by readers, but stale  
  // values are ok.  
  std::atomic<int> max_height_;  // Height of the entire list  
  // Read/written only by Insert().  
  Random rnd_;
}</code></pre>
<p class="text-align-justify"><strong>跳表节点定义</strong></p>
<pre class="language-cpp"><code>template <typename Key, class Comparator>  
struct SkipList<Key, Comparator>::Node {
  explicit Node(const Key& k) : key(k) {}
  Key const key;

private:
  // Array of length equal to the node height.  next_[0] is lowest level link.
  std::atomic<Node*> next_[1];
}</code></pre>
<ul><li><code>key</code> 存储节点实际的值</li>
<li><code>next_</code> 数组中每个指针指向横向的邻居节点</li></ul>
<p class="text-align-justify">memtable 对跳表模板实际使用的实际类型为：</p>
<pre class="language-cpp"><code>typedef SkipList<const char*, KeyComparator> Table;</code></pre>
<p class="text-align-justify">对 Key - <code>char*</code> 的实际编码方式：</p>
<pre class="language-cpp"><code>class MemTableInserter : public WriteBatch::Handler {  
 public:  
  SequenceNumber sequence_;  
  MemTable* mem_;  
  
  void Put(const Slice& key, const Slice& value) override {  
    mem_->Add(sequence_, kTypeValue, key, value);  // 插入
    sequence_++;  
  }  
  void Delete(const Slice& key) override {  
    mem_->Add(sequence_, kTypeDeletion, key, Slice());  // 删除
    sequence_++;  
  }  
};

void MemTable::Add(SequenceNumber s, ValueType type, const Slice& key,  
                   const Slice& value) {  
  // Format of an entry is concatenation of:  
  //  key_size     : varint32 of internal_key.size()
  //  key bytes    : char[internal_key.size()]
  //  tag          : uint64((sequence << 8) | type)
  //  value_size   : varint32 of value.size()
  //  value bytes  : char[value.size()]
  size_t key_size = key.size();  
  size_t val_size = value.size();  
  size_t internal_key_size = key_size + 8;  // 另外8字节存储 Tag
  const size_t encoded_len = VarintLength(internal_key_size) +  
                             internal_key_size + VarintLength(val_size) +  
                             val_size;  
  char* buf = arena_.Allocate(encoded_len);  
  char* p = EncodeVarint32(buf, internal_key_size);  
  std::memcpy(p, key.data(), key_size);  
  p += key_size;  
  EncodeFixed64(p, (s << 8) | type);  
  p += 8;  
  p = EncodeVarint32(p, val_size);  
  std::memcpy(p, value.data(), val_size);  
  assert(p + val_size == buf + encoded_len);  
  table_.Insert(buf);  
}</code></pre>
<img src='https://s2.loli.net/2025/08/06/H6YxZwdyVXujsJo.png' title='skiplist-node-key' alt='skiplist-node-key' width='800'/>
<ul><li>整数变长编码：“key 长度” 和 “value 长度”正常是32bit（4字节）整数，但 key 和 value 实际可能是比较短的字节序列（比如：长度小于128时，只要1个字节就能存储长度，而不是4字节）。</li>
<li>序列号仅使用尾部7个字节：序列号大小不会超过7个字节？确认一下哪里有约束</li>
<li>操作/值类型：
<ul><li><code>kTypeValue = 0x1</code> 表示当前操作为 插入，有对应的值</li>
<li><code>kTypeDeletion = 0x0</code> 表示当前操作为 删除，无对应的值（或者说值为空）。<u>正常来说，后面无需再编码“value 长度” 和 “value 值”，不过代码实现中似乎还是占用了1个字节来存储“value 长度” 0，可以优化？</u>。</li></ul></li></ul>
<p class="text-align-justify"><code>KeyComparator</code> 的定义：</p>
<pre class="language-cpp"><code>struct KeyComparator {  
  const InternalKeyComparator comparator;  
  explicit KeyComparator(const InternalKeyComparator& c) : comparator(c) {}  
  int operator()(const char* a, const char* b) const;  //
};

int MemTable::KeyComparator::operator()(const char* aptr,  
                                        const char* bptr) const {  
  // Internal keys are encoded as length-prefixed strings.  
  Slice a = GetLengthPrefixedSlice(aptr);  // 取出 internal key（包含 tag）
  Slice b = GetLengthPrefixedSlice(bptr);  
  return comparator.Compare(a, b);  
}

class InternalKeyComparator : public Comparator {  
 private:  
  const Comparator* user_comparator_; // 用户可配置自定义的 key 比较器，默认为 BytewiseComparator - 逐个字节比较
  
 public:  
  explicit InternalKeyComparator(const Comparator* c) : user_comparator_(c) {}  
  const char* Name() const override;  
  int Compare(const Slice& a, const Slice& b) const override;  
  void FindShortestSeparator(std::string* start,  
                             const Slice& limit) const override;  
  void FindShortSuccessor(std::string* key) const override;  
  
  const Comparator* user_comparator() const { return user_comparator_; }  
  
  int Compare(const InternalKey& a, const InternalKey& b) const;  
};

int InternalKeyComparator::Compare(const Slice& akey, const Slice& bkey) const {  
  // Order by:  
  //    increasing user key (according to user-supplied comparator)
  //    decreasing sequence number
  //    decreasing type (though sequence# should be enough to disambiguate)
  int r = user_comparator_->Compare(ExtractUserKey(akey), ExtractUserKey(bkey));  // ExtractUserKey 会忽略 Tag，比较原始 key
  if (r == 0) {  
    const uint64_t anum = DecodeFixed64(akey.data() + akey.size() - 8);  // 取出 Tag
    const uint64_t bnum = DecodeFixed64(bkey.data() + bkey.size() - 8);  // 取出 Tag
    if (anum > bnum) {  // 比较 Tag（序列号 + 操作类型）
      r = -1;  
    } else if (anum < bnum) {  
      r = +1;  
    }  
  }  
  return r;  
}</code></pre>
<p class="text-align-justify">实际的比较逻辑为：</p>
<ul><li>1、先比较原始的 key，小的排在前面</li>
<li>2、如果原始 key 相等，则比较序列号，<u>序列号大的排在前面（<strong>有点奇怪？这个逻辑很关键！点查/有序遍历/compaction 同 key 记录去重等依赖这个逻辑</strong>）</u></li></ul>
<h3>4.3 引用计数</h3>
<p class="text-align-justify">MemTable 使用的 引用计数 变量 <code>int refs_</code>，不是原子变量，所以计数增减都需要加互斥锁。并且因为计数减到小于等于0时， memtable 还需要析构自己，所以必须加锁。</p>
<pre class="language-cpp"><code>// Drop reference count.  Delete if no more references exist.  
void Unref() {  
  --refs_;  
  assert(refs_ >= 0);  
  if (refs_ <= 0) {  
    delete this;  
  }  
}</code></pre>
    </article>
</div>


<div class="comment">
     <script src="https://giscus.app/client.js"
        data-repo="kitelife/kitelife.github.com"
        data-repo-id="MDEwOlJlcG9zaXRvcnk4NTg1Njcx"
        data-category="giscus"
        data-category-id="DIC_kwDOAIMBx84Ctgkx"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
      </script>
    </div>



    </div>
</div>
<footer class="site-footer">
    <div class="wrapper">
        <div class="footer-col-wrapper">
            <div class="footer-col footer-col-1">
                <ul class="social-media-list">
                    <li>
                        <a href="https://github.com/kitelife" target="_blank">
                            <span class="icon icon--github">
                                <svg viewBox="0 0 16 16">
                                    <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                                </svg>
                            </span>
                            <span class="username">kitelife</span>
                        </a>
                    </li>
                    <li>
                        <a href="https://maimai.cn/profile/detail?dstu=39580141" target="_blank">
                            <span class="icon icon--maimai">
                                <img src="https://maimai.cn/favicon.ico" width="16"/>
                            </span>
                            <span class="username">Xiayf</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="footer-col footer-col-2"></div>
            <div class="footer-col footer-col-3"></div>
            <div class="footer-col footer-col-4">
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank">
                    <img alt="Creative Commons License" src="https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg">
                </a>
            </div>
        </div>
    </div>
</footer>


<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>


</body>
</html>