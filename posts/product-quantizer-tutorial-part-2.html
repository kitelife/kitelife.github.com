<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta property="og:title" content="BitPacking">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://bit.xiayf.cn/">
    <meta property="og:site_name" content="BitPacking">
    <meta property="og:description" content="精进，求诸己身">

    <title>BitPacking</title>
    <meta name="description" content="精进，求诸己身">
    <link rel="stylesheet" href="/static/main.css">
    <link rel="canonical" href="https://bit.xiayf.cn/">
    
    <link crossorigin="" rel="shortcut icon" type="image/x-icon" href="/assets/bits_small.ico">
    
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    
    
</head>

<body>
<header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">BitPacking</a>
        <nav class="site-nav">
            <a href="#" class="menu-icon">
                <svg viewBox="0 0 18 15">
                    <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
                    <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
                    <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
                </svg>
            </a>
            <div class="trigger">
                
                <a class="page-link" href="/pages/about.html">关于我</a>
                
                <a class="page-link" href="/pages/works.html">作品</a>
                
                <a class="page-link" href="/pages/linlang.html">琳琅</a>
                
                <a class="page-link" href="/rss.xml">RSS</a>
                
            </div>
        </nav>
    </div>
</header>
<div class="page-content">
    <div class="wrapper">
        
<div class="post">
    <header class="post-header">
        <h1 class="post-title">译文：k-NN 乘积量化器教程-第2部分</h1>
        <p class="post-meta">2025-01-10</p>
    </header>
    <article class="post-content">
        <p class="text-align-justify"><a href='http://mccormickml.com/2017/10/13/product-quantizer-tutorial-part-1/'>本教程的第1部分</a> 讲解了乘积量化器的最基础形式。本文将讲解 <a href='https://github.com/facebookresearch/faiss/wiki/Getting-started-tutorial'>FAISS 库的 IndexIVFPQ 索引</a>，该索引类型使用一个乘积量化器以及 <a href='https://lear.inrialpes.fr/pubs/2011/JDS11/jegou_searching_with_quantization.pdf'>2011 年发表的这篇论文</a>介绍的一些额外的技术。</p>
<p class="text-align-justify">下面先简要介绍一下该索引引入的两个特性，之后会再详细解释。</p>
<p class="text-align-justify"><em>倒排文件索引（IVF）</em>  - IVF 就是一种数据集预过滤的技术，避免对所有向量进行穷举搜索。它的原理相当直观 - 使用 k-means 聚类算法提前将数据集聚类成一定数量的数据集分区，然后在检索时，先将查询向量与每个分区的质心做比较，找到最近的若干个聚类，然后只在这些聚类分区内做向量搜索。</p>
<p class="text-align-justify"><em>残差编码</em> - 这是对乘积量化器基础形式的一种增强方式 - 加入 IVF 步骤的一些信息。对于每个数据库向量，不再使用 PQ 编码原始的数据库向量，而是对向量相对于所属分区的质心的偏移量（offset）进行编码。后续章节会解释其原理和收益。</p>
<h2>倒排文件索引（Inverted File Index）</h2>
<p class="text-align-justify">计算机科学领域，特别是信息检索领域，一个“倒排索引”是指将词汇表中的每个单词映射到数据库中所有文档中该单词出现的所有位置，它非常类似于课本中后面的索引表 - 将单词或概念映射到页号，所以大家将这种数据结构称为“倒排索引”让我有些困扰（因为于我而言它就是一种普通的索引！）。</p>
<p class="text-align-justify">不管怎样，在当前上下文中，这个技术实际就是使用 k-means 聚类对数据集做分割，这样就可以仅对部分分区做搜索而忽略其余的。</p>
<p class="text-align-justify">构建索引时，使用 k-means 聚类算法将数据集聚类成一定数量的分区。数据集中每个向量仅会被归属到一个聚类/分区中。每个分区包含归属于它的一组向量（也就是 FAISS 作者说的“倒排文件列表”）。也由此得到所有分区的质心组成的一个矩阵，用于计算应该对哪些分区进行搜索。</p>
<p class="text-align-justify">按照这种方式对数据集进行分割，并不完美，因为如果一个查询向量实际位于最近聚类的边缘位置，那么查询向量的最近邻居可能实际位于多个附近的聚类中。这个问题的解决方案是简单地多搜索几个分区。搜索多个附近的分区显然会占用更多的检索时间，但是准确性也会更好。</p>
<p class="text-align-justify">搜索的时候，将查询向量与所有分区的质心做比较，找到最近的若干个分区质心，实际的数量可以配置。一旦找到了最近的若干个分区质心，就可以仅对这些分区的数据库向量使用乘积量化器做 k-NN 搜索。</p>
<p class="text-align-justify">注意该索引类型中使用的如下术语：</p>
<ul><li>“probe（搜寻）” 这个动词，在当前上下文中，是指选定待搜索的目标分区。因此在代码中你会看到索引参数“nprobe” - 意思就是“待搜寻的分区数量”。</li>
<li>FAISS 的作者们喜欢使用“Voronoi 单元（cells）”这个词语，而不是我在本文中使用的“数据集分区（dataset partitions）”。一个 Voronoi 单元就是属于一个聚类的空间区域，也就是，这个空间区域涵盖了对应聚类的所有点，这些点的向量与这个聚类的质心的距离，比其他聚类的质心都要近。</li></ul>
<h2>残差编码（Encoding Residuals）</h2>
<p class="text-align-justify">这个特性也是相对比较直观的，不过如果你没有理解的话可能会觉得有点奇怪。其想法是将 IVF 阶段的一些信息加入到乘积量化器中，借此提升准确性（因此这个概念是建立在数据集分区技术之上的）。</p>
<p class="text-align-justify">先定义一下什么是“残差”向量。暂时抛开乘积量化器不谈（因为它会增大理解的困难，后面我们再把它加回来）。假设我们要做标准的暴力 k-NN 搜索，不过是用数据集分区技术来削减待搜索向量的数量。</p>
<p class="text-align-justify">假设我们是用 k-means 将数据集聚类成 100 个聚类（或者叫“数据集分区”）。给定数据集中的一个向量，其残差即是它相对于所属分区的质心的偏移（offset）。也就是，将数据集中的这个向量与其所属聚类的质心的向量相减。质心即是聚类的均值，那么对一组点均减去它们的均值会发生什么？现在这些点就围绕着 0 点了。如下是一个简单的二维示例：</p>
<img src='https://s2.loli.net/2025/08/06/Q1YX6c2DpNW3agl.png' title='residuals_one_partition.png' alt='residuals_one_partition.png' width='800'/>
<p class="text-align-justify">开始有趣起来了。假设将一个数据集分区中的所有向量都替换为各自的残差向量，怎么从这个数据集分区中找到查询向量的最近邻？先计算查询向量的残差（相对于分区质心的偏移），然后对这个数据集分区的所有残差向量做最近邻搜索，得到的结果与使用原始向量做搜索是一样的！</p>
<p class="text-align-justify">基于上面的图示，凭直觉可能就能理解，不过还是再看看下面的等式加深理解。'x' 和 'y' 这两个向量的长度为 'n'，它们的 L2 距离计算公式为：</p>
<p><mjx-container class="MathJax" jax="SVG" overflow="overflow" display="true"><svg style="vertical-align: -2.714ex;" xmlns="http://www.w3.org/2000/svg" width="29.823ex" height="6.923ex" role="img" focusable="false" viewBox="0 -1860.4 13181.6 3060" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-92-NCM-I-1D451" d="M429 632L370 389C349 426 320 445 281 445C216 445 159 412 109 345C63 283 40 218 40 151C40 63 91-11 175-11C218-11 260 12 300 59C311 21 345-11 392-11C461-11 483 71 498 145C498 154 493 159 483 159C474 159 468 152 465 138C445 59 421 19 394 19C377 19 368 33 368 60C368 75 370 91 374 107L516 679L516 683C513 690 507 694 499 694C476 694 434 690 374 683C363 682 357 674 357 660C357 650 366 645 384 645C403 645 429 646 429 632M341 376C351 355 356 341 356 332C355 328 354 323 353 316L304 122C301 111 294 99 285 87C248 42 212 19 177 19C138 19 118 49 118 108C118 132 124 168 136 216C157 301 187 359 224 390C244 407 263 415 282 415C309 415 329 402 341 376Z"></path><path id="MJX-92-NCM-I-1D456" d="M284 621C284 648 271 661 244 661C216 661 188 633 188 605C188 578 202 565 229 565C257 565 284 593 284 621M259 138C237 59 205 19 164 19C151 19 144 28 144 47C144 64 173 150 232 306C240 329 244 347 244 360C244 409 210 445 161 445C118 445 84 420 59 369C39 328 29 301 29 288C29 279 34 275 45 275C58 275 60 281 64 295C87 375 118 415 158 415C171 415 178 406 178 387C178 373 175 357 168 338C145 275 121 208 101 155C86 115 78 88 78 74C78 25 114-11 162-11C205-11 239 14 264 64C283 103 293 130 293 145C293 154 288 159 277 159C274 159 259 150 259 138Z"></path><path id="MJX-92-NCM-I-1D460" d="M420 354C420 411 362 442 300 442C237 442 192 423 165 385C142 352 130 322 130 295C130 242 165 208 234 193C263 188 285 181 302 173C323 164 333 147 333 123C333 105 325 85 308 62C287 33 250 18 197 18C143 18 108 33 92 62C124 61 151 87 151 119C151 144 138 157 111 157C75 157 52 124 52 88C52 22 124-11 196-11C271-11 325 11 357 56C384 93 397 126 397 156C397 199 376 231 335 252C304 263 280 270 265 273C230 282 194 285 194 328C194 381 244 413 300 413C342 413 369 400 382 375C360 371 337 352 337 327C337 306 348 295 371 295C402 295 420 323 420 354Z"></path><path id="MJX-92-NCM-I-1D461" d="M330 419C330 428 320 433 299 433L218 433C244 537 257 591 257 595C257 616 246 626 225 626C202 626 188 613 182 587L145 433L56 433C34 433 23 432 23 411C23 400 33 395 54 395L135 395C86 200 62 97 62 84C62 28 100-11 156-11C194-11 227 6 256 41C280 70 297 98 308 125C312 136 314 142 314 145C314 154 309 159 299 159C291 159 285 154 281 143C247 60 206 19 157 19C140 19 131 33 131 60C131 75 133 91 137 107L208 395L297 395C323 395 330 397 330 419Z"></path><path id="MJX-92-NCM-I-1D43F" d="M520 667C520 678 513 683 500 683L354 680L223 683C208 684 200 676 200 659C200 652 203 647 209 646C218 645 226 644 231 644C262 643 279 641 284 640C289 639 292 636 292 631C292 629 291 623 288 613L156 82C150 60 140 47 125 42C119 40 101 39 70 39C49 39 39 31 39 15C39 5 49 0 70 0L527 0C552 0 554 0 561 19L639 233C642 240 643 245 643 248C643 258 638 263 627 263C617 263 612 254 607 240C588 191 570 154 555 131C518 75 455 39 363 39L270 39C259 39 252 39 249 40C242 40 239 42 239 45C239 47 241 54 244 67L377 601C383 624 396 637 415 642C421 643 442 644 478 644C506 644 520 644 520 667Z"></path><path id="MJX-92-NCM-N-32" d="M237 666C186 666 143 648 106 612C69 576 50 534 50 483C50 449 75 424 106 424C136 424 161 450 161 480C161 513 137 536 105 536C102 536 100 536 98 535C117 584 161 627 224 627C306 627 352 556 352 470C352 403 318 331 250 255L62 43C49 28 50 29 50 0L421 0L450 180L417 180C409 129 402 100 396 91C391 86 361 84 306 84L139 84L236 179C304 243 390 312 419 365C439 400 449 435 449 470C449 588 357 666 237 666Z"></path><path id="MJX-92-NCM-N-28" d="M318-248C327-248 332-243 332-234C332-231 330-227 327-223C275-183 233-117 202-26C175 53 161 131 161 208L161 292C161 369 175 447 202 526C233 617 275 683 327 723C330 726 332 730 332 734C332 743 327 748 318 748C317 748 314 747 311 745C251 699 201 631 160 540C121 453 101 371 101 292L101 208C101 129 121 47 160-40C201-131 251-199 311-245C314-247 317-248 318-248Z"></path><path id="MJX-92-NCM-I-1D465" d="M527 373C527 419 482 442 432 442C389 442 355 419 329 373C308 419 273 442 222 442C173 442 133 419 101 374C74 335 60 306 60 287C60 278 65 273 75 273C84 273 90 278 92 287C111 345 153 413 220 413C253 413 269 392 269 351C269 330 251 252 216 118C199 51 169 18 126 18C112 18 99 21 88 26C114 36 127 54 127 80C127 106 114 119 87 119C54 119 29 91 29 58C29 12 76-11 125-11C167-11 201 12 228 58C247 12 283-11 335-11C383-11 423 12 455 57C482 96 496 125 496 144C496 153 491 158 481 158C472 158 467 153 464 144C447 87 402 18 337 18C304 18 287 38 287 79C287 92 292 120 303 165L337 300C356 375 387 413 431 413C445 413 458 410 469 405C442 396 429 378 429 351C429 325 443 312 470 312C502 312 527 341 527 373Z"></path><path id="MJX-92-NCM-N-2C" d="M139 106C107 106 86 82 86 50C86 20 109-5 139-5C153-5 165-1 174 8L175 0C175-63 154-117 112-160C105-168 101-174 101-178C101-188 105-193 114-193C123-193 135-181 152-158C186-110 203-57 203 0C203 53 185 106 139 106Z"></path><path id="MJX-92-NCM-I-1D466" d="M163 442C118 442 83 417 58 367C39 328 29 301 29 286C29 277 34 272 45 272C59 272 60 278 64 293C87 372 119 412 160 412C173 412 180 403 180 385C180 369 175 346 164 317C126 214 107 145 107 108C107 32 154-13 231-13C264-13 295-1 323 23C288-109 233-175 158-175C124-175 101-164 89-142C129-140 149-121 149-85C149-60 136-47 109-47C72-47 50-78 50-115C50-170 100-205 158-205C273-205 367-99 392-1L486 377C489 388 490 396 490 401C490 421 479 431 458 431C442 431 429 423 420 408C414 387 409 369 406 354L342 97C332 61 279 16 234 16C196 16 177 41 177 92C177 134 194 198 227 284C240 319 247 343 247 357C247 406 212 442 163 442Z"></path><path id="MJX-92-NCM-N-29" d="M78-245C138-199 188-131 229-40C268 47 288 129 288 208L288 292C288 371 268 453 229 540C188 631 138 699 78 745C75 747 72 748 71 748C62 748 57 743 57 734C57 730 59 726 62 723C114 683 156 617 187 526C214 447 228 369 228 292L228 208C228 131 214 53 187-26C156-117 114-183 62-223C59-227 57-231 57-234C57-243 62-248 71-248C72-248 75-247 78-245Z"></path><path id="MJX-92-NCM-N-3D" d="M698 367L80 367C64 367 56 359 56 344C56 329 64 321 80 321L698 321C714 321 722 329 722 344C722 356 711 367 698 367M698 179L80 179C64 179 56 171 56 156C56 141 64 133 80 133L698 133C714 133 722 141 722 156C722 169 711 179 698 179Z"></path><path id="MJX-92-NCM-S4-221A" d="M467-982L254 263L117-8C114-14 112-19 111-22C111-26 117-34 130-45L194 81L422-1250C459-1250 465-1250 471-1221L1020 1726C1020 1742 1012 1750 996 1750C983 1750 975 1739 971 1717Z"></path><path id="MJX-92-NCM-LO-2211" d="M1265-450L1389-124L1355-124C1336-174 1304-216 1258-250C1145-334 1000-356 791-356L200-356L700 232C707 239 710 246 710 251L244 894L781 894C970 894 1127 870 1230 804C1290 766 1332 719 1356 663L1389 663L1265 950L88 950C70 950 60 947 57 941C56 938 56 926 56 905L581 187L68-415C61-423 57-430 57-435C57-445 67-450 88-450Z"></path><path id="MJX-92-NCM-I-1D45B" d="M537 137C514 58 481 18 440 18C427 18 420 28 420 47C420 61 426 84 438 115C478 224 498 296 498 333C498 403 451 442 381 442C322 442 271 416 230 363C222 407 187 442 136 442C80 442 58 390 44 345C34 313 29 294 29 287C29 278 34 273 45 273C50 273 53 274 56 276C61 285 64 292 65 299C83 375 106 413 133 413C151 413 160 399 160 371C160 358 155 331 144 290L87 63C84 50 78 24 78 19C78-1 89-11 111-11C130-11 144-1 151 19C153 24 159 49 170 92L191 181L221 295C232 318 249 341 270 365C299 397 335 413 378 413C411 413 427 391 427 348C427 310 406 234 363 120C356 102 353 87 353 74C353 25 390-11 438-11C482-11 517 14 542 64C561 104 571 131 571 144C571 153 566 158 555 158C552 158 537 149 537 137Z"></path><path id="MJX-92-NCM-N-2212" d="M698 270L80 270C64 270 56 263 56 250C56 237 64 230 80 230L698 230C714 230 722 237 722 250C722 262 710 270 698 270Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="dist_{L2}\left( x,y \right) =\sqrt{\sum_{i}^{n} \left( x_{i}-y_{i} \right)^{2}}"><g data-mml-node="mi" data-latex="d"><use data-c="1D451" xlink:href="#MJX-92-NCM-I-1D451"></use></g><g data-mml-node="mi" data-latex="i" transform="translate(520,0)"><use data-c="1D456" xlink:href="#MJX-92-NCM-I-1D456"></use></g><g data-mml-node="mi" data-latex="s" transform="translate(865,0)"><use data-c="1D460" xlink:href="#MJX-92-NCM-I-1D460"></use></g><g data-mml-node="msub" data-latex="t_{L2}" transform="translate(1334,0)"><g data-mml-node="mi" data-latex="t"><use data-c="1D461" xlink:href="#MJX-92-NCM-I-1D461"></use></g><g data-mml-node="TeXAtom" transform="translate(394,-150) scale(0.707)" data-latex="{L2}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="L"><use data-c="1D43F" xlink:href="#MJX-92-NCM-I-1D43F"></use></g><g data-mml-node="mn" data-latex="2" transform="translate(681,0)"><use data-c="32" xlink:href="#MJX-92-NCM-N-32"></use></g></g></g><g data-mml-node="mrow" data-latex-item="\left( x,y \right)" data-latex="\left( x,y \right)" transform="translate(2779.8,0)"><g data-mml-node="mo" data-latex-item="\left(" data-latex="\left("><use data-c="28" xlink:href="#MJX-92-NCM-N-28"></use></g><g data-mml-node="mi" data-latex="x" transform="translate(389,0)"><use data-c="1D465" xlink:href="#MJX-92-NCM-I-1D465"></use></g><g data-mml-node="mo" data-latex="," transform="translate(961,0)"><use data-c="2C" xlink:href="#MJX-92-NCM-N-2C"></use></g><g data-mml-node="mi" data-latex="y" transform="translate(1405.7,0)"><use data-c="1D466" xlink:href="#MJX-92-NCM-I-1D466"></use></g><g data-mml-node="mo" data-latex-item="\right)" data-latex="\right)" transform="translate(1895.7,0)"><use data-c="29" xlink:href="#MJX-92-NCM-N-29"></use></g></g><g data-mml-node="mo" data-latex="=" transform="translate(5342.2,0)"><use data-c="3D" xlink:href="#MJX-92-NCM-N-3D"></use></g><g data-mml-node="msqrt" data-latex="\sqrt{\sum_{i}^{n} \left( x_{i}-y_{i} \right)^{2}}" transform="translate(6398,0)"><g data-mml-node="mo" transform="translate(0,50.4)"><use data-c="221A" xlink:href="#MJX-92-NCM-S4-221A"></use></g><g transform="translate(1020,0)"><g data-mml-node="munderover" data-latex="\sum_{i}^{n}"><g data-mml-node="mo" data-latex="\sum"><use data-c="2211" xlink:href="#MJX-92-NCM-LO-2211"></use></g><g data-mml-node="TeXAtom" transform="translate(600,-1084.4) scale(0.707)" data-latex="{i}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="i"><use data-c="1D456" xlink:href="#MJX-92-NCM-I-1D456"></use></g></g><g data-mml-node="TeXAtom" transform="translate(509.9,1150) scale(0.707)" data-latex="{n}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="n"><use data-c="1D45B" xlink:href="#MJX-92-NCM-I-1D45B"></use></g></g></g><g data-mml-node="msup" data-latex="\left( x_{i}-y_{i} \right)^{2}" transform="translate(1610.7,0)"><g data-mml-node="mrow" data-latex-item="\left( x_{i}-y_{i} \right)" data-latex="\left( x_{i}-y_{i} \right)"><g data-mml-node="mo" data-latex-item="\left(" data-latex="\left("><use data-c="28" xlink:href="#MJX-92-NCM-N-28"></use></g><g data-mml-node="msub" data-latex="x_{i}" transform="translate(389,0)"><g data-mml-node="mi" data-latex="x"><use data-c="1D465" xlink:href="#MJX-92-NCM-I-1D465"></use></g><g data-mml-node="TeXAtom" transform="translate(605,-150) scale(0.707)" data-latex="{i}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="i"><use data-c="1D456" xlink:href="#MJX-92-NCM-I-1D456"></use></g></g></g><g data-mml-node="mo" data-latex="-" transform="translate(1510.2,0)"><use data-c="2212" xlink:href="#MJX-92-NCM-N-2212"></use></g><g data-mml-node="msub" data-latex="y_{i}" transform="translate(2510.4,0)"><g data-mml-node="mi" data-latex="y"><use data-c="1D466" xlink:href="#MJX-92-NCM-I-1D466"></use></g><g data-mml-node="TeXAtom" transform="translate(523,-150) scale(0.707)" data-latex="{i}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="i"><use data-c="1D456" xlink:href="#MJX-92-NCM-I-1D456"></use></g></g></g><g data-mml-node="mo" data-latex-item="\right)" data-latex="\right)" transform="translate(3327.3,0)"><use data-c="29" xlink:href="#MJX-92-NCM-N-29"></use></g></g><g data-mml-node="TeXAtom" transform="translate(3749.3,475.1) scale(0.707)" data-latex="{2}" data-mjx-texclass="ORD"><g data-mml-node="mn" data-latex="2"><use data-c="32" xlink:href="#MJX-92-NCM-N-32"></use></g></g></g></g><rect width="5763.6" height="60" x="1020" y="1740.4"></rect></g></g></g></svg></mjx-container></p>
<p class="text-align-justify">如果对 'x' 和 'y' 都减去质心向量 'c'，看起来是什么样的？</p>
<p><mjx-container class="MathJax" jax="SVG" overflow="overflow" display="true"><svg style="vertical-align: -2.714ex;" xmlns="http://www.w3.org/2000/svg" width="68.168ex" height="6.923ex" role="img" focusable="false" viewBox="0 -1860.4 30130.4 3060" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-93-NCM-I-1D451" d="M429 632L370 389C349 426 320 445 281 445C216 445 159 412 109 345C63 283 40 218 40 151C40 63 91-11 175-11C218-11 260 12 300 59C311 21 345-11 392-11C461-11 483 71 498 145C498 154 493 159 483 159C474 159 468 152 465 138C445 59 421 19 394 19C377 19 368 33 368 60C368 75 370 91 374 107L516 679L516 683C513 690 507 694 499 694C476 694 434 690 374 683C363 682 357 674 357 660C357 650 366 645 384 645C403 645 429 646 429 632M341 376C351 355 356 341 356 332C355 328 354 323 353 316L304 122C301 111 294 99 285 87C248 42 212 19 177 19C138 19 118 49 118 108C118 132 124 168 136 216C157 301 187 359 224 390C244 407 263 415 282 415C309 415 329 402 341 376Z"></path><path id="MJX-93-NCM-I-1D456" d="M284 621C284 648 271 661 244 661C216 661 188 633 188 605C188 578 202 565 229 565C257 565 284 593 284 621M259 138C237 59 205 19 164 19C151 19 144 28 144 47C144 64 173 150 232 306C240 329 244 347 244 360C244 409 210 445 161 445C118 445 84 420 59 369C39 328 29 301 29 288C29 279 34 275 45 275C58 275 60 281 64 295C87 375 118 415 158 415C171 415 178 406 178 387C178 373 175 357 168 338C145 275 121 208 101 155C86 115 78 88 78 74C78 25 114-11 162-11C205-11 239 14 264 64C283 103 293 130 293 145C293 154 288 159 277 159C274 159 259 150 259 138Z"></path><path id="MJX-93-NCM-I-1D460" d="M420 354C420 411 362 442 300 442C237 442 192 423 165 385C142 352 130 322 130 295C130 242 165 208 234 193C263 188 285 181 302 173C323 164 333 147 333 123C333 105 325 85 308 62C287 33 250 18 197 18C143 18 108 33 92 62C124 61 151 87 151 119C151 144 138 157 111 157C75 157 52 124 52 88C52 22 124-11 196-11C271-11 325 11 357 56C384 93 397 126 397 156C397 199 376 231 335 252C304 263 280 270 265 273C230 282 194 285 194 328C194 381 244 413 300 413C342 413 369 400 382 375C360 371 337 352 337 327C337 306 348 295 371 295C402 295 420 323 420 354Z"></path><path id="MJX-93-NCM-I-1D461" d="M330 419C330 428 320 433 299 433L218 433C244 537 257 591 257 595C257 616 246 626 225 626C202 626 188 613 182 587L145 433L56 433C34 433 23 432 23 411C23 400 33 395 54 395L135 395C86 200 62 97 62 84C62 28 100-11 156-11C194-11 227 6 256 41C280 70 297 98 308 125C312 136 314 142 314 145C314 154 309 159 299 159C291 159 285 154 281 143C247 60 206 19 157 19C140 19 131 33 131 60C131 75 133 91 137 107L208 395L297 395C323 395 330 397 330 419Z"></path><path id="MJX-93-NCM-I-1D43F" d="M520 667C520 678 513 683 500 683L354 680L223 683C208 684 200 676 200 659C200 652 203 647 209 646C218 645 226 644 231 644C262 643 279 641 284 640C289 639 292 636 292 631C292 629 291 623 288 613L156 82C150 60 140 47 125 42C119 40 101 39 70 39C49 39 39 31 39 15C39 5 49 0 70 0L527 0C552 0 554 0 561 19L639 233C642 240 643 245 643 248C643 258 638 263 627 263C617 263 612 254 607 240C588 191 570 154 555 131C518 75 455 39 363 39L270 39C259 39 252 39 249 40C242 40 239 42 239 45C239 47 241 54 244 67L377 601C383 624 396 637 415 642C421 643 442 644 478 644C506 644 520 644 520 667Z"></path><path id="MJX-93-NCM-N-32" d="M237 666C186 666 143 648 106 612C69 576 50 534 50 483C50 449 75 424 106 424C136 424 161 450 161 480C161 513 137 536 105 536C102 536 100 536 98 535C117 584 161 627 224 627C306 627 352 556 352 470C352 403 318 331 250 255L62 43C49 28 50 29 50 0L421 0L450 180L417 180C409 129 402 100 396 91C391 86 361 84 306 84L139 84L236 179C304 243 390 312 419 365C439 400 449 435 449 470C449 588 357 666 237 666Z"></path><path id="MJX-93-NCM-N-28" d="M318-248C327-248 332-243 332-234C332-231 330-227 327-223C275-183 233-117 202-26C175 53 161 131 161 208L161 292C161 369 175 447 202 526C233 617 275 683 327 723C330 726 332 730 332 734C332 743 327 748 318 748C317 748 314 747 311 745C251 699 201 631 160 540C121 453 101 371 101 292L101 208C101 129 121 47 160-40C201-131 251-199 311-245C314-247 317-248 318-248Z"></path><path id="MJX-93-NCM-I-1D465" d="M527 373C527 419 482 442 432 442C389 442 355 419 329 373C308 419 273 442 222 442C173 442 133 419 101 374C74 335 60 306 60 287C60 278 65 273 75 273C84 273 90 278 92 287C111 345 153 413 220 413C253 413 269 392 269 351C269 330 251 252 216 118C199 51 169 18 126 18C112 18 99 21 88 26C114 36 127 54 127 80C127 106 114 119 87 119C54 119 29 91 29 58C29 12 76-11 125-11C167-11 201 12 228 58C247 12 283-11 335-11C383-11 423 12 455 57C482 96 496 125 496 144C496 153 491 158 481 158C472 158 467 153 464 144C447 87 402 18 337 18C304 18 287 38 287 79C287 92 292 120 303 165L337 300C356 375 387 413 431 413C445 413 458 410 469 405C442 396 429 378 429 351C429 325 443 312 470 312C502 312 527 341 527 373Z"></path><path id="MJX-93-NCM-N-2212" d="M698 270L80 270C64 270 56 263 56 250C56 237 64 230 80 230L698 230C714 230 722 237 722 250C722 262 710 270 698 270Z"></path><path id="MJX-93-NCM-I-1D450" d="M328 325C328 300 341 287 368 287C404 287 427 318 427 354C427 410 368 442 308 442C239 442 176 412 122 353C68 294 41 229 41 159C41 61 106-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 121 53 121 122C121 184 150 274 174 317C198 361 249 413 308 413C346 413 372 402 386 381C355 378 328 358 328 325Z"></path><path id="MJX-93-NCM-N-2C" d="M139 106C107 106 86 82 86 50C86 20 109-5 139-5C153-5 165-1 174 8L175 0C175-63 154-117 112-160C105-168 101-174 101-178C101-188 105-193 114-193C123-193 135-181 152-158C186-110 203-57 203 0C203 53 185 106 139 106Z"></path><path id="MJX-93-NCM-I-1D466" d="M163 442C118 442 83 417 58 367C39 328 29 301 29 286C29 277 34 272 45 272C59 272 60 278 64 293C87 372 119 412 160 412C173 412 180 403 180 385C180 369 175 346 164 317C126 214 107 145 107 108C107 32 154-13 231-13C264-13 295-1 323 23C288-109 233-175 158-175C124-175 101-164 89-142C129-140 149-121 149-85C149-60 136-47 109-47C72-47 50-78 50-115C50-170 100-205 158-205C273-205 367-99 392-1L486 377C489 388 490 396 490 401C490 421 479 431 458 431C442 431 429 423 420 408C414 387 409 369 406 354L342 97C332 61 279 16 234 16C196 16 177 41 177 92C177 134 194 198 227 284C240 319 247 343 247 357C247 406 212 442 163 442Z"></path><path id="MJX-93-NCM-N-29" d="M78-245C138-199 188-131 229-40C268 47 288 129 288 208L288 292C288 371 268 453 229 540C188 631 138 699 78 745C75 747 72 748 71 748C62 748 57 743 57 734C57 730 59 726 62 723C114 683 156 617 187 526C214 447 228 369 228 292L228 208C228 131 214 53 187-26C156-117 114-183 62-223C59-227 57-231 57-234C57-243 62-248 71-248C72-248 75-247 78-245Z"></path><path id="MJX-93-NCM-N-3D" d="M698 367L80 367C64 367 56 359 56 344C56 329 64 321 80 321L698 321C714 321 722 329 722 344C722 356 711 367 698 367M698 179L80 179C64 179 56 171 56 156C56 141 64 133 80 133L698 133C714 133 722 141 722 156C722 169 711 179 698 179Z"></path><path id="MJX-93-NCM-S4-221A" d="M467-982L254 263L117-8C114-14 112-19 111-22C111-26 117-34 130-45L194 81L422-1250C459-1250 465-1250 471-1221L1020 1726C1020 1742 1012 1750 996 1750C983 1750 975 1739 971 1717Z"></path><path id="MJX-93-NCM-LO-2211" d="M1265-450L1389-124L1355-124C1336-174 1304-216 1258-250C1145-334 1000-356 791-356L200-356L700 232C707 239 710 246 710 251L244 894L781 894C970 894 1127 870 1230 804C1290 766 1332 719 1356 663L1389 663L1265 950L88 950C70 950 60 947 57 941C56 938 56 926 56 905L581 187L68-415C61-423 57-430 57-435C57-445 67-450 88-450Z"></path><path id="MJX-93-NCM-I-1D45B" d="M537 137C514 58 481 18 440 18C427 18 420 28 420 47C420 61 426 84 438 115C478 224 498 296 498 333C498 403 451 442 381 442C322 442 271 416 230 363C222 407 187 442 136 442C80 442 58 390 44 345C34 313 29 294 29 287C29 278 34 273 45 273C50 273 53 274 56 276C61 285 64 292 65 299C83 375 106 413 133 413C151 413 160 399 160 371C160 358 155 331 144 290L87 63C84 50 78 24 78 19C78-1 89-11 111-11C130-11 144-1 151 19C153 24 159 49 170 92L191 181L221 295C232 318 249 341 270 365C299 397 335 413 378 413C411 413 427 391 427 348C427 310 406 234 363 120C356 102 353 87 353 74C353 25 390-11 438-11C482-11 517 14 542 64C561 104 571 131 571 144C571 153 566 158 555 158C552 158 537 149 537 137Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="dist_{L2}\left( x-c,y-c \right) =\sqrt{\sum_{i}^{n} \left( (x_{i}-c_{i})-(y_{i}-c_{i}) \right)^{2}} =\sqrt{\sum_{i}^{n} \left( x_{i}-y_{i} \right)^{2}}"><g data-mml-node="mi" data-latex="d"><use data-c="1D451" xlink:href="#MJX-93-NCM-I-1D451"></use></g><g data-mml-node="mi" data-latex="i" transform="translate(520,0)"><use data-c="1D456" xlink:href="#MJX-93-NCM-I-1D456"></use></g><g data-mml-node="mi" data-latex="s" transform="translate(865,0)"><use data-c="1D460" xlink:href="#MJX-93-NCM-I-1D460"></use></g><g data-mml-node="msub" data-latex="t_{L2}" transform="translate(1334,0)"><g data-mml-node="mi" data-latex="t"><use data-c="1D461" xlink:href="#MJX-93-NCM-I-1D461"></use></g><g data-mml-node="TeXAtom" transform="translate(394,-150) scale(0.707)" data-latex="{L2}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="L"><use data-c="1D43F" xlink:href="#MJX-93-NCM-I-1D43F"></use></g><g data-mml-node="mn" data-latex="2" transform="translate(681,0)"><use data-c="32" xlink:href="#MJX-93-NCM-N-32"></use></g></g></g><g data-mml-node="mrow" data-latex-item="\left( x-c,y-c \right)" data-latex="\left( x-c,y-c \right)" transform="translate(2779.8,0)"><g data-mml-node="mo" data-latex-item="\left(" data-latex="\left("><use data-c="28" xlink:href="#MJX-93-NCM-N-28"></use></g><g data-mml-node="mi" data-latex="x" transform="translate(389,0)"><use data-c="1D465" xlink:href="#MJX-93-NCM-I-1D465"></use></g><g data-mml-node="mo" data-latex="-" transform="translate(1183.2,0)"><use data-c="2212" xlink:href="#MJX-93-NCM-N-2212"></use></g><g data-mml-node="mi" data-latex="c" transform="translate(2183.4,0)"><use data-c="1D450" xlink:href="#MJX-93-NCM-I-1D450"></use></g><g data-mml-node="mo" data-latex="," transform="translate(2616.4,0)"><use data-c="2C" xlink:href="#MJX-93-NCM-N-2C"></use></g><g data-mml-node="mi" data-latex="y" transform="translate(3061.1,0)"><use data-c="1D466" xlink:href="#MJX-93-NCM-I-1D466"></use></g><g data-mml-node="mo" data-latex="-" transform="translate(3773.3,0)"><use data-c="2212" xlink:href="#MJX-93-NCM-N-2212"></use></g><g data-mml-node="mi" data-latex="c" transform="translate(4773.6,0)"><use data-c="1D450" xlink:href="#MJX-93-NCM-I-1D450"></use></g><g data-mml-node="mo" data-latex-item="\right)" data-latex="\right)" transform="translate(5206.6,0)"><use data-c="29" xlink:href="#MJX-93-NCM-N-29"></use></g></g><g data-mml-node="mo" data-latex="=" transform="translate(8653.1,0)"><use data-c="3D" xlink:href="#MJX-93-NCM-N-3D"></use></g><g data-mml-node="msqrt" data-latex="\sqrt{\sum_{i}^{n} \left( (x_{i}-c_{i})-(y_{i}-c_{i}) \right)^{2}}" transform="translate(9708.9,0)"><g data-mml-node="mo" transform="translate(0,50.4)"><use data-c="221A" xlink:href="#MJX-93-NCM-S4-221A"></use></g><g transform="translate(1020,0)"><g data-mml-node="munderover" data-latex="\sum_{i}^{n}"><g data-mml-node="mo" data-latex="\sum"><use data-c="2211" xlink:href="#MJX-93-NCM-LO-2211"></use></g><g data-mml-node="TeXAtom" transform="translate(600,-1084.4) scale(0.707)" data-latex="{i}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="i"><use data-c="1D456" xlink:href="#MJX-93-NCM-I-1D456"></use></g></g><g data-mml-node="TeXAtom" transform="translate(509.9,1150) scale(0.707)" data-latex="{n}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="n"><use data-c="1D45B" xlink:href="#MJX-93-NCM-I-1D45B"></use></g></g></g><g data-mml-node="msup" data-latex="\left( (x_{i}-c_{i})-(y_{i}-c_{i}) \right)^{2}" transform="translate(1610.7,0)"><g data-mml-node="mrow" data-latex-item="\left( (x_{i}-c_{i})-(y_{i}-c_{i}) \right)" data-latex="\left( (x_{i}-c_{i})-(y_{i}-c_{i}) \right)"><g data-mml-node="mo" data-latex-item="\left(" data-latex="\left("><use data-c="28" xlink:href="#MJX-93-NCM-N-28"></use></g><g data-mml-node="mo" data-latex="(" transform="translate(389,0)"><use data-c="28" xlink:href="#MJX-93-NCM-N-28"></use></g><g data-mml-node="msub" data-latex="x_{i}" transform="translate(778,0)"><g data-mml-node="mi" data-latex="x"><use data-c="1D465" xlink:href="#MJX-93-NCM-I-1D465"></use></g><g data-mml-node="TeXAtom" transform="translate(605,-150) scale(0.707)" data-latex="{i}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="i"><use data-c="1D456" xlink:href="#MJX-93-NCM-I-1D456"></use></g></g></g><g data-mml-node="mo" data-latex="-" transform="translate(1899.2,0)"><use data-c="2212" xlink:href="#MJX-93-NCM-N-2212"></use></g><g data-mml-node="msub" data-latex="c_{i}" transform="translate(2899.4,0)"><g data-mml-node="mi" data-latex="c"><use data-c="1D450" xlink:href="#MJX-93-NCM-I-1D450"></use></g><g data-mml-node="TeXAtom" transform="translate(466,-150) scale(0.707)" data-latex="{i}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="i"><use data-c="1D456" xlink:href="#MJX-93-NCM-I-1D456"></use></g></g></g><g data-mml-node="mo" data-latex=")" transform="translate(3659.3,0)"><use data-c="29" xlink:href="#MJX-93-NCM-N-29"></use></g><g data-mml-node="mo" data-latex="-" transform="translate(4270.6,0)"><use data-c="2212" xlink:href="#MJX-93-NCM-N-2212"></use></g><g data-mml-node="mo" data-latex="(" transform="translate(5270.8,0)"><use data-c="28" xlink:href="#MJX-93-NCM-N-28"></use></g><g data-mml-node="msub" data-latex="y_{i}" transform="translate(5659.8,0)"><g data-mml-node="mi" data-latex="y"><use data-c="1D466" xlink:href="#MJX-93-NCM-I-1D466"></use></g><g data-mml-node="TeXAtom" transform="translate(523,-150) scale(0.707)" data-latex="{i}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="i"><use data-c="1D456" xlink:href="#MJX-93-NCM-I-1D456"></use></g></g></g><g data-mml-node="mo" data-latex="-" transform="translate(6699,0)"><use data-c="2212" xlink:href="#MJX-93-NCM-N-2212"></use></g><g data-mml-node="msub" data-latex="c_{i}" transform="translate(7699.2,0)"><g data-mml-node="mi" data-latex="c"><use data-c="1D450" xlink:href="#MJX-93-NCM-I-1D450"></use></g><g data-mml-node="TeXAtom" transform="translate(466,-150) scale(0.707)" data-latex="{i}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="i"><use data-c="1D456" xlink:href="#MJX-93-NCM-I-1D456"></use></g></g></g><g data-mml-node="mo" data-latex=")" transform="translate(8459.1,0)"><use data-c="29" xlink:href="#MJX-93-NCM-N-29"></use></g><g data-mml-node="mo" data-latex-item="\right)" data-latex="\right)" transform="translate(8848.1,0)"><use data-c="29" xlink:href="#MJX-93-NCM-N-29"></use></g></g><g data-mml-node="TeXAtom" transform="translate(9270.1,475.1) scale(0.707)" data-latex="{2}" data-mjx-texclass="ORD"><g data-mml-node="mn" data-latex="2"><use data-c="32" xlink:href="#MJX-93-NCM-N-32"></use></g></g></g></g><rect width="11284.4" height="60" x="1020" y="1740.4"></rect></g><g data-mml-node="mo" data-latex="=" transform="translate(22291,0)"><use data-c="3D" xlink:href="#MJX-93-NCM-N-3D"></use></g><g data-mml-node="msqrt" data-latex="\sqrt{\sum_{i}^{n} \left( x_{i}-y_{i} \right)^{2}}" transform="translate(23346.8,0)"><g data-mml-node="mo" transform="translate(0,50.4)"><use data-c="221A" xlink:href="#MJX-93-NCM-S4-221A"></use></g><g transform="translate(1020,0)"><g data-mml-node="munderover" data-latex="\sum_{i}^{n}"><g data-mml-node="mo" data-latex="\sum"><use data-c="2211" xlink:href="#MJX-93-NCM-LO-2211"></use></g><g data-mml-node="TeXAtom" transform="translate(600,-1084.4) scale(0.707)" data-latex="{i}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="i"><use data-c="1D456" xlink:href="#MJX-93-NCM-I-1D456"></use></g></g><g data-mml-node="TeXAtom" transform="translate(509.9,1150) scale(0.707)" data-latex="{n}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="n"><use data-c="1D45B" xlink:href="#MJX-93-NCM-I-1D45B"></use></g></g></g><g data-mml-node="msup" data-latex="\left( x_{i}-y_{i} \right)^{2}" transform="translate(1610.7,0)"><g data-mml-node="mrow" data-latex-item="\left( x_{i}-y_{i} \right)" data-latex="\left( x_{i}-y_{i} \right)"><g data-mml-node="mo" data-latex-item="\left(" data-latex="\left("><use data-c="28" xlink:href="#MJX-93-NCM-N-28"></use></g><g data-mml-node="msub" data-latex="x_{i}" transform="translate(389,0)"><g data-mml-node="mi" data-latex="x"><use data-c="1D465" xlink:href="#MJX-93-NCM-I-1D465"></use></g><g data-mml-node="TeXAtom" transform="translate(605,-150) scale(0.707)" data-latex="{i}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="i"><use data-c="1D456" xlink:href="#MJX-93-NCM-I-1D456"></use></g></g></g><g data-mml-node="mo" data-latex="-" transform="translate(1510.2,0)"><use data-c="2212" xlink:href="#MJX-93-NCM-N-2212"></use></g><g data-mml-node="msub" data-latex="y_{i}" transform="translate(2510.4,0)"><g data-mml-node="mi" data-latex="y"><use data-c="1D466" xlink:href="#MJX-93-NCM-I-1D466"></use></g><g data-mml-node="TeXAtom" transform="translate(523,-150) scale(0.707)" data-latex="{i}" data-mjx-texclass="ORD"><g data-mml-node="mi" data-latex="i"><use data-c="1D456" xlink:href="#MJX-93-NCM-I-1D456"></use></g></g></g><g data-mml-node="mo" data-latex-item="\right)" data-latex="\right)" transform="translate(3327.3,0)"><use data-c="29" xlink:href="#MJX-93-NCM-N-29"></use></g></g><g data-mml-node="TeXAtom" transform="translate(3749.3,475.1) scale(0.707)" data-latex="{2}" data-mjx-texclass="ORD"><g data-mml-node="mn" data-latex="2"><use data-c="32" xlink:href="#MJX-93-NCM-N-32"></use></g></g></g></g><rect width="5763.6" height="60" x="1020" y="1740.4"></rect></g></g></g></svg></mjx-container></p>
<p class="text-align-justify">质心部分被抵消掉了！</p>
<p class="text-align-justify">注意使用残差计算出来的距离不只是相对而言（比如距离的序）是相等的，并且确实是正确地计算出了向量之间的 L2 距离。</p>
<p class="text-align-justify">可能你之前就使用过这种等价关系，均值归一化（对向量减去均值）是一种常见的预处理技术。</p>
<p class="text-align-justify">不过目前为止说的都是单个分区内的计算。将不同分区内的向量做比较又会是什么情况呢？仍然管用，只要针对每个分区分别计算查询向量的残差即可。</p>
<p class="text-align-justify">下面这个图解中包含两个数据集分区。计算残差之后，两个分区的所有点都围绕在 0 点周围了。不过现在是有两个查询向量的残差 - 一个是与蓝色点集（分区 1）比较得到的，另一个是与绿色点集（分区 2）比较得到的。</p>
<img src='https://s2.loli.net/2025/08/06/xFhHNrOUvsSLoWe.png' title='residuals_two_partitions.png' alt='residuals_two_partitions.png' width='800'/>
<p class="text-align-justify">前面解释过查询向量和数据库向量之间的距离，使用原始向量计算和使用残差向量计算，结果是一样的，还记得吧？</p>
<p class="text-align-justify">很有意思，不过目前为止还是无用功 - 尚未改变结果的准确性也没有减少计算成本。现在将 PQ 重新放进来一起考虑，就会发现好处在哪了。</p>
<p class="text-align-justify">在训练乘积量化器之前，先计算数据集所有分区所有向量的残差向量。残差向量集合保持原有分区（不会合并在一起），不过现在所有残差向量都围绕着 0 点，相对紧凑地聚集在一起。我们抛弃掉原始的数据集向量，只存储残差向量集。</p>
<p class="text-align-justify">在所有这些残差向量之上训练习得一个乘积量化器，不再使用原始向量。那有什么不同之处吗？回想一下：乘积量化器的训练过程是先将向量分割成子向量，在每部分子向量之上进行 k-means 聚类，学习到一组原型/质心（或者叫“码本”）用于表征所有向量。使用对应的残差向量来替换原始向量，能够降低数据集中向量的多样性（the variety in the dataset）（论文中，将此描述为：相对于原始向量，残差向量“包含更小的能量（have less energy）”）。之前，聚类存在于空间的各个区域，现在聚类都围绕着 0 点，并且相互之间还存在部分重合。降低了数据集中向量的多样性，就可能使用更少的原型/质心（或者说“代码”）来有效地表征向量！或者，换个角度来说，PQ 中数量有限的代码现在更加准确了，因为这些代码所要描述的向量，相比之前，相互之间区别更小了（less distinct）。我们得到了更多的回报（more bang for our buck）！</p>
<p class="text-align-justify">不过，也是有代价的。回想一下：乘积量化器的魔力在于仅需要将查询向量分块与码本代码之间的部分距离计算出来存为一个相对比较小的表 - 剩下的操作就是查表和加法。</p>
<p class="text-align-justify">现在，使用残差向量，对于每个数据集分区而言，查询向量都是不同的 - 对于每个数据集分区，查询向量对应的残差向量都需要基于分区的质心重新计算。因此，对于待搜寻的每个分区，都必须单独计算一个距离表！</p>
<p class="text-align-justify">不过，这个取舍显然是值得的，实际应用中，IndexIVFPQ 索引的表现都很不错。</p>
<p class="text-align-justify">就是这样。虽然数据库向量都被各自的残差向量替代了，不过对于乘积量化器来说，没什么不同。</p>
<p class="text-align-justify">注意：数据集分区并不会考虑（factor in to）码本训练，我们仍然跨越分区使用所有数据集向量为每部分子向量习得一个码本。你也可以为每个数据集分区单独训练一个 PQ，不过 FAISS 库的作者不赞成这样做，因为分区的数量通常比较大，那么存储这些码本的内存开销会是一个问题。所以，跨分区在所有数据库向量之上训练习得一个 PQ 更好一些。</p>
    </article>
</div>


<div class="comment">
     <script src="https://giscus.app/client.js"
        data-repo="kitelife/kitelife.github.com"
        data-repo-id="MDEwOlJlcG9zaXRvcnk4NTg1Njcx"
        data-category="giscus"
        data-category-id="DIC_kwDOAIMBx84Ctgkx"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
      </script>
    </div>



    </div>
</div>
<footer class="site-footer">
    <div class="wrapper">
        <div class="footer-col-wrapper">
            <div class="footer-col footer-col-1">
                <ul class="social-media-list">
                    <li>
                        <a href="https://github.com/kitelife" target="_blank">
                            <span class="icon icon--github">
                                <svg viewBox="0 0 16 16">
                                    <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                                </svg>
                            </span>
                            <span class="username">kitelife</span>
                        </a>
                    </li>
                    <li>
                        <a href="https://maimai.cn/profile/detail?dstu=39580141" target="_blank">
                            <span class="icon icon--maimai">
                                <img src="https://maimai.cn/favicon.ico" width="16"/>
                            </span>
                            <span class="username">Xiayf</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="footer-col footer-col-2"></div>
            <div class="footer-col footer-col-3"></div>
            <div class="footer-col footer-col-4">
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank">
                    <img alt="Creative Commons License" src="https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg">
                </a>
            </div>
        </div>
    </div>
</footer>


<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>


</body>
</html>