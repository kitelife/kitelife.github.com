<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta property="og:title" content="BitPacking">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://bit.xiayf.cn/">
    <meta property="og:site_name" content="BitPacking">
    <meta property="og:description" content="精进，求诸己身">

    <title>BitPacking</title>
    <meta name="description" content="精进，求诸己身">
    <link rel="stylesheet" href="/static/main.css">
    <link rel="canonical" href="https://bit.xiayf.cn/">
    
    <link crossorigin="" rel="shortcut icon" type="image/x-icon" href="/assets/bits_small.ico">
    
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    
    <style>
@import url("https://fontsapi.zeoseven.com/7/main/result.css");
body {
    font-family: equity_text_a, "Zhuque Fangsong (technical preview)";
    font-weight: normal;
}
</style>
    
    
</head>

<body>
<header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">BitPacking</a>
        <nav class="site-nav">
            <a href="#" class="menu-icon">
                <svg viewBox="0 0 18 15">
                    <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
                    <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
                    <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
                </svg>
            </a>
            <div class="trigger">
                
                <a class="page-link" href="/pages/about.html">关于我</a>
                
                <a class="page-link" href="/pages/works.html">作品</a>
                
                <a class="page-link" href="/pages/linlang.html">琳琅</a>
                
                <a class="page-link" href="/rss.xml">RSS</a>
                
            </div>
        </nav>
    </div>
</header>
<div class="page-content">
    <div class="wrapper">
        
<div class="post">
    <header class="post-header">
        <h1 class="post-title">读码：LevelDB - ldb 数据文件格式</h1>
        <p class="post-meta">2024-11-13</p>
    </header>
    <article class="post-content">
        <h2>5、leveldb 数据文件格式 - ldb</h2>
<pre class="language-text"><code>&lt;beginning_of_file&gt;
[data block 1]
[data block 2]
...
[data block N]
[meta block 1]
...
[meta block K]
[metaindex block]
[index block]
[Footer]        (fixed size; starts at file_size - sizeof(Footer))
&lt;end_of_file&gt;</code></pre>
<p class="text-align-justify">leveldb 文件（文件后缀 <code>.ldb</code>）内容由 N 个 “data 块” 部分、 K 个 “meta 块” 部分、1个 “metaindex 块” 部分、1个 “index 块”部分、1个 “Footer” 部分依次构成。</p>
<img src='https://s2.loli.net/2025/08/06/vGZCySwcU8EgH94.png' title='' alt='' width='830'/>
<p class="text-align-justify">ldb 数据文件的加载解析流程：</p>
<ul><li>1、取文件末尾的 28 个字节，解析出(1) metaindex block 的 offset & size (2) index block 的 offset & size</li>
<li>2、根据 metaindex block 的 offset & size 解析出 “过滤策略名称” 和 meta block 的 offset & size
<ul><li>根据“过滤策略名称” 实例化过滤策略</li>
<li>对于 meta block 的解析，先解析出“第3部分” 和 “第4部分”的值，得到“第1部分”的长度，继而得到“第2️部分”的偏移位置和长度（也即 <code>filter_offsets_</code> 的内容）</li></ul></li>
<li>3、根据 index block 的 offset & size 解析出所有 data block 的“key 区间”、offset 和 size</li></ul>
<p class="text-align-justify">“点查”，对于 ldb 数据文件的检索流程为：</p>
<ul><li>1、使用 key，从最新版本中从小到大逐个 level 匹配其文件元数据</li>
<li>2、对目标 ldb 文件，使用 key 从 index block 中通过二分查找匹配到目标 data block 的 offset & size</li>
<li>3、根据目标 data block 的 offset 对 meta block 的 <code>filter_offsets_</code> 计算而后取到目标过滤数据块，交给过滤策略实例进行初步的匹配筛选</li>
<li>4、如果 3 中没有匹配到，则根据目标 data block 的 offset 计算取到 data block 的“重置位点序列”，继而对 data block 的“键值对序列”进行解析遍历匹配</li></ul>
<h3>5.1 “Footer”部分</h3>
<p class="text-align-justify">长度为固定值 <code>kEncodedLength</code>（<svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="49.817ex" height="2.034ex" role="img" focusable="false" viewBox="0 -694 22019 899" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-11-NCM-N-32" d="M237 666C186 666 143 648 106 612C69 576 50 534 50 483C50 449 75 424 106 424C136 424 161 450 161 480C161 513 137 536 105 536C102 536 100 536 98 535C117 584 161 627 224 627C306 627 352 556 352 470C352 403 318 331 250 255L62 43C49 28 50 29 50 0L421 0L450 180L417 180C409 129 402 100 396 91C391 86 361 84 306 84L139 84L236 179C304 243 390 312 419 365C439 400 449 435 449 470C449 588 357 666 237 666Z"></path><path id="MJX-11-NCM-N-2217" d="M404 372C397 372 390 370 385 366L267 279L282 425C285 445 269 462 250 462C231 462 215 445 218 425L233 279L115 366C110 370 103 372 96 372C78 372 63 357 63 339C63 325 70 315 83 309L217 250L83 191C70 185 63 175 63 161C63 143 78 128 96 128C103 128 110 130 115 134L233 221L218 75C215 55 231 39 250 39C269 39 285 55 282 75L267 221L385 134C390 130 397 128 404 128C415 128 424 133 431 142C446 162 435 183 417 191L283 250L417 309C430 315 437 325 437 339C437 357 422 372 404 372Z"></path><path id="MJX-11-NCM-I-1D435" d="M756 543C756 634 666 683 568 683L236 683C213 683 203 682 203 659C203 643 223 644 235 644C265 643 283 641 288 640C293 639 295 636 295 631C295 629 294 623 291 613L159 82C154 60 144 47 129 42C122 40 104 39 73 39C52 39 42 31 42 15C42 5 52 0 73 0L426 0C491 0 551 20 608 59C671 102 703 155 703 217C703 296 638 344 567 358C655 379 756 446 756 543M554 644C623 644 658 612 658 547C658 496 638 454 596 420C554 386 507 370 456 370L317 370L377 610C385 644 385 644 427 644M582 299C596 276 603 253 603 228C603 176 583 131 542 94C501 57 455 39 402 39L267 39C257 39 250 39 246 40C240 40 237 42 237 45C237 46 237 49 238 53C269 180 293 276 309 340L493 340C536 340 565 326 582 299Z"></path><path id="MJX-11-NCM-I-1D459" d="M173 632L49 119C46 105 44 93 44 84C44 31 83-11 136-11C185-11 220 41 241 145C241 154 236 159 225 159C217 159 211 152 208 138C188 59 165 19 138 19C121 19 113 33 113 60C113 75 115 91 119 107L258 679L258 683C255 690 249 694 242 694C210 694 136 685 124 684C109 682 102 674 102 659C102 650 111 645 130 645C147 645 173 645 173 632Z"></path><path id="MJX-11-NCM-I-1D45C" d="M308 442C239 442 176 412 122 353C68 294 41 229 41 159C41 63 106-11 202-11C272-11 334 19 388 78C442 137 469 201 469 272C469 369 405 442 308 442M389 310C389 287 384 255 374 213C353 130 319 73 272 42C248 26 225 18 203 18C149 18 121 65 121 122C121 180 155 288 178 324C216 383 259 413 307 413C361 413 389 367 389 310Z"></path><path id="MJX-11-NCM-I-1D450" d="M328 325C328 300 341 287 368 287C404 287 427 318 427 354C427 410 368 442 308 442C239 442 176 412 122 353C68 294 41 229 41 159C41 61 106-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 121 53 121 122C121 184 150 274 174 317C198 361 249 413 308 413C346 413 372 402 386 381C355 378 328 358 328 325Z"></path><path id="MJX-11-NCM-I-1D458" d="M409 353C409 327 423 314 450 314C485 314 508 345 508 379C508 418 476 445 437 445C392 445 344 415 291 356C250 311 217 282 190 269L291 679C289 688 287 694 274 694C242 694 166 685 154 684C139 682 132 675 132 660C132 650 141 645 159 645C178 645 204 646 204 632L59 43C56 32 55 25 55 21C55 0 66-11 87-11C104-11 117-3 124 12C129 21 147 92 179 226C231 221 286 196 286 146C286 131 279 101 279 91C279 34 316-11 373-11C431-11 470 41 490 145C490 154 485 159 475 159C466 159 460 152 457 138C435 59 408 19 375 19C357 19 348 33 348 61C348 77 360 131 360 147C360 204 314 239 221 253C244 269 270 292 298 322C326 352 346 371 359 382C386 404 412 415 435 415C445 415 453 413 459 409C432 404 409 379 409 353Z"></path><path id="MJX-11-NCM-I-1D43B" d="M881 668C881 678 875 683 863 683L736 680L609 683C593 683 586 674 586 659C586 652 589 647 594 646C604 645 612 644 617 644C648 643 665 641 670 640C675 639 678 636 678 631C677 628 676 622 674 613L615 375L321 375L379 602C384 623 393 636 406 641C413 643 430 644 458 644C485 644 496 644 496 668C496 678 490 683 478 683L351 680L223 683C207 683 200 674 200 659C200 652 203 647 209 646C219 645 227 644 232 644C263 643 281 641 286 640C291 639 293 636 293 631C293 629 292 623 289 613L156 82C151 60 141 47 126 42C119 40 101 39 70 39C48 39 39 37 39 15C39 5 45 0 57 0L183 3L246 2C257 2 299 0 310 0C326 0 334 8 334 24C334 34 323 39 302 39C262 39 242 43 242 52C242 52 243 55 245 68L312 336L605 336L538 68C535 53 523 43 503 40C498 39 481 39 452 39C433 39 424 31 424 15C424 5 430 0 442 0L568 3L631 2C642 2 683 0 696 0C712 0 720 8 720 24C720 34 709 39 688 39C647 39 627 43 627 52C627 52 628 55 630 68L764 602C769 623 778 636 791 641C797 643 814 644 843 644C869 644 881 644 881 668Z"></path><path id="MJX-11-NCM-I-1D44E" d="M498 144C498 153 493 158 482 158C474 158 468 151 465 137C445 58 421 18 394 18C377 18 368 32 368 60C368 73 372 97 381 132L438 357C443 376 445 387 445 392C445 412 434 422 412 422C391 422 377 410 370 387C349 424 319 442 281 442C216 442 159 409 109 343C63 281 40 217 40 150C40 63 91-11 175-11C218-11 260 12 300 58C311 20 345-11 392-11C461-11 482 70 498 144M341 374C350 353 355 339 355 330C355 326 354 321 353 314L304 122C301 111 294 99 285 87C248 41 212 18 177 18C138 18 118 48 118 107C118 131 124 167 136 215C157 300 187 357 224 388C244 405 263 413 282 413C309 413 329 400 341 374Z"></path><path id="MJX-11-NCM-I-1D45B" d="M537 137C514 58 481 18 440 18C427 18 420 28 420 47C420 61 426 84 438 115C478 224 498 296 498 333C498 403 451 442 381 442C322 442 271 416 230 363C222 407 187 442 136 442C80 442 58 390 44 345C34 313 29 294 29 287C29 278 34 273 45 273C50 273 53 274 56 276C61 285 64 292 65 299C83 375 106 413 133 413C151 413 160 399 160 371C160 358 155 331 144 290L87 63C84 50 78 24 78 19C78-1 89-11 111-11C130-11 144-1 151 19C153 24 159 49 170 92L191 181L221 295C232 318 249 341 270 365C299 397 335 413 378 413C411 413 427 391 427 348C427 310 406 234 363 120C356 102 353 87 353 74C353 25 390-11 438-11C482-11 517 14 542 64C561 104 571 131 571 144C571 153 566 158 555 158C552 158 537 149 537 137Z"></path><path id="MJX-11-NCM-I-1D451" d="M429 632L370 389C349 426 320 445 281 445C216 445 159 412 109 345C63 283 40 218 40 151C40 63 91-11 175-11C218-11 260 12 300 59C311 21 345-11 392-11C461-11 483 71 498 145C498 154 493 159 483 159C474 159 468 152 465 138C445 59 421 19 394 19C377 19 368 33 368 60C368 75 370 91 374 107L516 679L516 683C513 690 507 694 499 694C476 694 434 690 374 683C363 682 357 674 357 660C357 650 366 645 384 645C403 645 429 646 429 632M341 376C351 355 356 341 356 332C355 328 354 323 353 316L304 122C301 111 294 99 285 87C248 42 212 19 177 19C138 19 118 49 118 108C118 132 124 168 136 216C157 301 187 359 224 390C244 407 263 415 282 415C309 415 329 402 341 376Z"></path><path id="MJX-11-NCM-I-1D452" d="M124 129C124 153 129 186 139 227L188 227C253 227 303 235 339 250C372 264 394 284 405 309C412 326 415 342 415 355C415 410 363 442 307 442C268 442 229 432 190 412C113 372 46 281 46 171C46 69 105-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 124 72 124 129M375 355C375 289 311 256 182 256L147 256C166 322 194 366 232 387C262 404 287 413 307 413C343 413 375 391 375 355Z"></path><path id="MJX-11-NCM-N-3A" d="M192 375C192 405 169 431 139 431C109 431 86 405 86 375C86 345 109 319 139 319C169 319 192 345 192 375M192 56C192 86 169 112 139 112C109 112 86 86 86 56C86 26 109 0 139 0C169 0 192 26 192 56Z"></path><path id="MJX-11-NCM-I-1D440" d="M594 16C594 5 600 0 613 0L736 3C759 4 840 0 859 0C874 0 882 8 882 24C882 34 872 39 851 39C810 39 790 43 790 52C790 55 792 62 795 75L927 602C932 623 942 636 955 641C961 643 979 644 1008 644C1033 644 1044 645 1044 668C1044 678 1034 683 1013 683L882 683C853 683 853 681 840 662L484 108L408 657C404 682 402 683 373 683L237 683C215 683 204 682 204 660C204 649 215 644 236 644C256 644 297 647 297 631C297 629 296 623 293 613L167 110C158 72 135 49 100 42C75 39 42 43 42 16C42 5 48 0 60 0C78 0 141 3 159 3C178 3 242 0 261 0C276 0 283 8 283 24C283 33 276 38 261 39C219 39 198 52 198 78C198 82 199 89 202 100L332 621L415 26C418 9 424 0 434 0C442 0 450 7 459 20L848 627L712 82C706 60 696 47 681 42C675 40 656 39 625 39C604 39 594 37 594 16Z"></path><path id="MJX-11-NCM-I-1D465" d="M527 373C527 419 482 442 432 442C389 442 355 419 329 373C308 419 273 442 222 442C173 442 133 419 101 374C74 335 60 306 60 287C60 278 65 273 75 273C84 273 90 278 92 287C111 345 153 413 220 413C253 413 269 392 269 351C269 330 251 252 216 118C199 51 169 18 126 18C112 18 99 21 88 26C114 36 127 54 127 80C127 106 114 119 87 119C54 119 29 91 29 58C29 12 76-11 125-11C167-11 201 12 228 58C247 12 283-11 335-11C383-11 423 12 455 57C482 96 496 125 496 144C496 153 491 158 481 158C472 158 467 153 464 144C447 87 402 18 337 18C304 18 287 38 287 79C287 92 292 120 303 165L337 300C356 375 387 413 431 413C445 413 458 410 469 405C442 396 429 378 429 351C429 325 443 312 470 312C502 312 527 341 527 373Z"></path><path id="MJX-11-NCM-I-1D438" d="M199 656C199 646 210 641 231 641C271 641 291 637 291 628C291 625 289 618 286 605L156 82C151 60 141 47 126 42C119 40 101 39 70 39C48 39 38 37 38 16C38 5 49 0 70 0L583 0C607 0 609 2 617 19L657 109C684 171 703 217 714 248C712 257 709 263 698 263C691 263 685 258 681 249C656 190 632 145 608 113C568 59 509 39 415 39L270 39C260 39 253 39 249 40C243 40 240 42 240 45C240 47 242 54 245 67L311 334L406 334C453 334 478 328 483 315C485 310 486 303 486 293C486 280 484 264 479 245C477 240 476 236 476 233C476 223 482 218 493 218C502 218 508 226 512 241L568 473C568 483 563 488 552 488C544 488 538 481 535 467C525 428 512 403 495 391C478 379 450 373 409 373L321 373L379 606C387 640 387 641 429 641L568 641C619 641 654 636 673 626C701 611 715 581 715 536C715 519 714 501 711 484C711 482 711 479 710 475L710 466C710 455 715 450 725 450C735 450 741 459 743 478L763 649C766 677 759 680 732 680L233 680C210 680 199 679 199 656Z"></path><path id="MJX-11-NCM-I-1D43F" d="M520 667C520 678 513 683 500 683L354 680L223 683C208 684 200 676 200 659C200 652 203 647 209 646C218 645 226 644 231 644C262 643 279 641 284 640C289 639 292 636 292 631C292 629 291 623 288 613L156 82C150 60 140 47 125 42C119 40 101 39 70 39C49 39 39 31 39 15C39 5 49 0 70 0L527 0C552 0 554 0 561 19L639 233C642 240 643 245 643 248C643 258 638 263 627 263C617 263 612 254 607 240C588 191 570 154 555 131C518 75 455 39 363 39L270 39C259 39 252 39 249 40C242 40 239 42 239 45C239 47 241 54 244 67L377 601C383 624 396 637 415 642C421 643 442 644 478 644C506 644 520 644 520 667Z"></path><path id="MJX-11-NCM-I-1D454" d="M15-141C15-184 60-205 150-205C197-205 241-193 280-170C324-144 351-109 362-66L471 373C473 383 474 389 474 392C474 412 463 422 442 422C420 422 406 410 399 387C377 424 347 442 310 442C246 442 189 410 140 346C95 286 72 223 72 158C72 71 123-3 207-3C246-3 282 14 315 47L285-71C256-140 211-175 148-175C122-175 100-173 82-169C103-158 113-141 113-118C113-93 99-80 72-80C40-80 15-109 15-141M356 392C376 371 386 351 386 331C386 330 385 325 383 318L336 129C330 106 313 82 286 60C259 38 233 27 210 27C170 27 150 56 150 114C150 169 184 291 204 327C235 384 270 412 311 412C329 412 344 405 356 392Z"></path><path id="MJX-11-NCM-I-1D461" d="M330 419C330 428 320 433 299 433L218 433C244 537 257 591 257 595C257 616 246 626 225 626C202 626 188 613 182 587L145 433L56 433C34 433 23 432 23 411C23 400 33 395 54 395L135 395C86 200 62 97 62 84C62 28 100-11 156-11C194-11 227 6 256 41C280 70 297 98 308 125C312 136 314 142 314 145C314 154 309 159 299 159C291 159 285 154 281 143C247 60 206 19 157 19C140 19 131 33 131 60C131 75 133 91 137 107L208 395L297 395C323 395 330 397 330 419Z"></path><path id="MJX-11-NCM-I-210E" d="M512 138C489 59 457 19 415 19C402 19 395 28 395 47C395 62 401 85 413 116C453 223 473 296 473 335C473 406 427 445 356 445C303 445 257 423 218 380L291 679C289 688 287 694 274 694C241 694 168 685 155 684C140 682 132 675 132 660C132 650 141 645 159 645C180 645 203 646 205 632L59 43C56 32 55 25 55 21C55 0 66-11 87-11C107-11 121-1 128 18L168 182C180 231 189 268 196 293C199 300 207 314 220 334C256 388 300 415 353 415C386 415 402 393 402 350C402 309 382 236 342 130C333 107 329 89 329 74C329 26 365-11 413-11C457-11 492 14 517 65C536 105 546 132 546 145C546 154 541 159 530 159C527 159 512 150 512 138Z"></path><path id="MJX-11-NCM-N-2B" d="M698 274L413 274L413 559C413 575 405 583 389 583C373 583 365 575 365 559L365 274L80 274C64 274 56 266 56 250C56 234 64 226 80 226L365 226L365-59C365-75 373-83 389-83C405-83 413-75 413-59L413 226L698 226C714 226 722 234 722 250C722 263 711 274 698 274Z"></path><path id="MJX-11-NCM-N-38" d="M250 666C201 666 158 650 122 618C86 586 68 546 68 497C68 456 83 419 113 386C120 378 142 361 179 335C88 288 42 227 42 153C42 100 64 57 107 24C147-7 194-22 249-22C305-22 354-4 395 32C436 68 457 115 457 170C457 216 441 257 408 294C396 307 365 330 316 361C393 402 431 454 431 515C431 606 344 666 250 666M379 515C379 463 348 418 286 381L167 459C136 479 120 505 120 536C120 596 185 633 249 633C318 633 379 584 379 515M250 14C168 14 99 73 99 153C99 220 136 274 210 315L328 240C376 209 400 174 400 134C400 62 325 14 250 14Z"></path><path id="MJX-11-NCM-N-3D" d="M698 367L80 367C64 367 56 359 56 344C56 329 64 321 80 321L698 321C714 321 722 329 722 344C722 356 711 367 698 367M698 179L80 179C64 179 56 171 56 156C56 141 64 133 80 133L698 133C714 133 722 141 722 156C722 169 711 179 698 179Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="2 * BlockHandle::kMaxEncodedLength + 8 = 28"><g data-mml-node="mn" data-latex="2"><use data-c="32" xlink:href="#MJX-11-NCM-N-32"></use></g><g data-mml-node="mo" data-latex="*" transform="translate(722.2,0)"><use data-c="2217" xlink:href="#MJX-11-NCM-N-2217"></use></g><g data-mml-node="mi" data-latex="B" transform="translate(1444.4,0)"><use data-c="1D435" xlink:href="#MJX-11-NCM-I-1D435"></use></g><g data-mml-node="mi" data-latex="l" transform="translate(2203.4,0)"><use data-c="1D459" xlink:href="#MJX-11-NCM-I-1D459"></use></g><g data-mml-node="mi" data-latex="o" transform="translate(2501.4,0)"><use data-c="1D45C" xlink:href="#MJX-11-NCM-I-1D45C"></use></g><g data-mml-node="mi" data-latex="c" transform="translate(2986.4,0)"><use data-c="1D450" xlink:href="#MJX-11-NCM-I-1D450"></use></g><g data-mml-node="mi" data-latex="k" transform="translate(3419.4,0)"><use data-c="1D458" xlink:href="#MJX-11-NCM-I-1D458"></use></g><g data-mml-node="mi" data-latex="H" transform="translate(3940.4,0)"><use data-c="1D43B" xlink:href="#MJX-11-NCM-I-1D43B"></use></g><g data-mml-node="mi" data-latex="a" transform="translate(4821.4,0)"><use data-c="1D44E" xlink:href="#MJX-11-NCM-I-1D44E"></use></g><g data-mml-node="mi" data-latex="n" transform="translate(5350.4,0)"><use data-c="1D45B" xlink:href="#MJX-11-NCM-I-1D45B"></use></g><g data-mml-node="mi" data-latex="d" transform="translate(5950.4,0)"><use data-c="1D451" xlink:href="#MJX-11-NCM-I-1D451"></use></g><g data-mml-node="mi" data-latex="l" transform="translate(6470.4,0)"><use data-c="1D459" xlink:href="#MJX-11-NCM-I-1D459"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(6768.4,0)"><use data-c="1D452" xlink:href="#MJX-11-NCM-I-1D452"></use></g><g data-mml-node="mo" data-latex="::" transform="translate(7512.2,0)"><g data-mml-node="text"><use data-c="3A" xlink:href="#MJX-11-NCM-N-3A"></use></g><g data-mml-node="text" transform="translate(278,0)"><use data-c="3A" xlink:href="#MJX-11-NCM-N-3A"></use></g></g><g data-mml-node="mi" data-latex="k" transform="translate(8346,0)"><use data-c="1D458" xlink:href="#MJX-11-NCM-I-1D458"></use></g><g data-mml-node="mi" data-latex="M" transform="translate(8867,0)"><use data-c="1D440" xlink:href="#MJX-11-NCM-I-1D440"></use></g><g data-mml-node="mi" data-latex="a" transform="translate(9911,0)"><use data-c="1D44E" xlink:href="#MJX-11-NCM-I-1D44E"></use></g><g data-mml-node="mi" data-latex="x" transform="translate(10440,0)"><use data-c="1D465" xlink:href="#MJX-11-NCM-I-1D465"></use></g><g data-mml-node="mi" data-latex="E" transform="translate(11012,0)"><use data-c="1D438" xlink:href="#MJX-11-NCM-I-1D438"></use></g><g data-mml-node="mi" data-latex="n" transform="translate(11778,0)"><use data-c="1D45B" xlink:href="#MJX-11-NCM-I-1D45B"></use></g><g data-mml-node="mi" data-latex="c" transform="translate(12378,0)"><use data-c="1D450" xlink:href="#MJX-11-NCM-I-1D450"></use></g><g data-mml-node="mi" data-latex="o" transform="translate(12811,0)"><use data-c="1D45C" xlink:href="#MJX-11-NCM-I-1D45C"></use></g><g data-mml-node="mi" data-latex="d" transform="translate(13296,0)"><use data-c="1D451" xlink:href="#MJX-11-NCM-I-1D451"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(13816,0)"><use data-c="1D452" xlink:href="#MJX-11-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="d" transform="translate(14282,0)"><use data-c="1D451" xlink:href="#MJX-11-NCM-I-1D451"></use></g><g data-mml-node="mi" data-latex="L" transform="translate(14802,0)"><use data-c="1D43F" xlink:href="#MJX-11-NCM-I-1D43F"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(15483,0)"><use data-c="1D452" xlink:href="#MJX-11-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="n" transform="translate(15949,0)"><use data-c="1D45B" xlink:href="#MJX-11-NCM-I-1D45B"></use></g><g data-mml-node="mi" data-latex="g" transform="translate(16549,0)"><use data-c="1D454" xlink:href="#MJX-11-NCM-I-1D454"></use></g><g data-mml-node="mi" data-latex="t" transform="translate(17026,0)"><use data-c="1D461" xlink:href="#MJX-11-NCM-I-1D461"></use></g><g data-mml-node="mi" data-latex="h" transform="translate(17387,0)"><use data-c="210E" xlink:href="#MJX-11-NCM-I-210E"></use></g><g data-mml-node="mo" data-latex="+" transform="translate(18185.2,0)"><use data-c="2B" xlink:href="#MJX-11-NCM-N-2B"></use></g><g data-mml-node="mn" data-latex="8" transform="translate(19185.4,0)"><use data-c="38" xlink:href="#MJX-11-NCM-N-38"></use></g><g data-mml-node="mo" data-latex="=" transform="translate(19963.2,0)"><use data-c="3D" xlink:href="#MJX-11-NCM-N-3D"></use></g><g data-mml-node="mn" data-latex="8" transform="translate(21019,0)"><use data-c="32" xlink:href="#MJX-11-NCM-N-32"></use><use data-c="38" xlink:href="#MJX-11-NCM-N-38" transform="translate(500,0)"></use></g></g></g></svg>）</p>
<p class="text-align-justify">先后存入：</p>
<ul><li>1、“metaindex 块”在文件中的偏移位置 offset 和 块大小 size。</li>
<li>2、“index” 块在文件中的偏移位置 offset 和 块大小 size。</li>
<li>3、将“Footer”长度填充 到 <svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="45.92ex" height="2.034ex" role="img" focusable="false" viewBox="0 -694 20296.6 899" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-12-NCM-N-32" d="M237 666C186 666 143 648 106 612C69 576 50 534 50 483C50 449 75 424 106 424C136 424 161 450 161 480C161 513 137 536 105 536C102 536 100 536 98 535C117 584 161 627 224 627C306 627 352 556 352 470C352 403 318 331 250 255L62 43C49 28 50 29 50 0L421 0L450 180L417 180C409 129 402 100 396 91C391 86 361 84 306 84L139 84L236 179C304 243 390 312 419 365C439 400 449 435 449 470C449 588 357 666 237 666Z"></path><path id="MJX-12-NCM-N-2217" d="M404 372C397 372 390 370 385 366L267 279L282 425C285 445 269 462 250 462C231 462 215 445 218 425L233 279L115 366C110 370 103 372 96 372C78 372 63 357 63 339C63 325 70 315 83 309L217 250L83 191C70 185 63 175 63 161C63 143 78 128 96 128C103 128 110 130 115 134L233 221L218 75C215 55 231 39 250 39C269 39 285 55 282 75L267 221L385 134C390 130 397 128 404 128C415 128 424 133 431 142C446 162 435 183 417 191L283 250L417 309C430 315 437 325 437 339C437 357 422 372 404 372Z"></path><path id="MJX-12-NCM-I-1D435" d="M756 543C756 634 666 683 568 683L236 683C213 683 203 682 203 659C203 643 223 644 235 644C265 643 283 641 288 640C293 639 295 636 295 631C295 629 294 623 291 613L159 82C154 60 144 47 129 42C122 40 104 39 73 39C52 39 42 31 42 15C42 5 52 0 73 0L426 0C491 0 551 20 608 59C671 102 703 155 703 217C703 296 638 344 567 358C655 379 756 446 756 543M554 644C623 644 658 612 658 547C658 496 638 454 596 420C554 386 507 370 456 370L317 370L377 610C385 644 385 644 427 644M582 299C596 276 603 253 603 228C603 176 583 131 542 94C501 57 455 39 402 39L267 39C257 39 250 39 246 40C240 40 237 42 237 45C237 46 237 49 238 53C269 180 293 276 309 340L493 340C536 340 565 326 582 299Z"></path><path id="MJX-12-NCM-I-1D459" d="M173 632L49 119C46 105 44 93 44 84C44 31 83-11 136-11C185-11 220 41 241 145C241 154 236 159 225 159C217 159 211 152 208 138C188 59 165 19 138 19C121 19 113 33 113 60C113 75 115 91 119 107L258 679L258 683C255 690 249 694 242 694C210 694 136 685 124 684C109 682 102 674 102 659C102 650 111 645 130 645C147 645 173 645 173 632Z"></path><path id="MJX-12-NCM-I-1D45C" d="M308 442C239 442 176 412 122 353C68 294 41 229 41 159C41 63 106-11 202-11C272-11 334 19 388 78C442 137 469 201 469 272C469 369 405 442 308 442M389 310C389 287 384 255 374 213C353 130 319 73 272 42C248 26 225 18 203 18C149 18 121 65 121 122C121 180 155 288 178 324C216 383 259 413 307 413C361 413 389 367 389 310Z"></path><path id="MJX-12-NCM-I-1D450" d="M328 325C328 300 341 287 368 287C404 287 427 318 427 354C427 410 368 442 308 442C239 442 176 412 122 353C68 294 41 229 41 159C41 61 106-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 121 53 121 122C121 184 150 274 174 317C198 361 249 413 308 413C346 413 372 402 386 381C355 378 328 358 328 325Z"></path><path id="MJX-12-NCM-I-1D458" d="M409 353C409 327 423 314 450 314C485 314 508 345 508 379C508 418 476 445 437 445C392 445 344 415 291 356C250 311 217 282 190 269L291 679C289 688 287 694 274 694C242 694 166 685 154 684C139 682 132 675 132 660C132 650 141 645 159 645C178 645 204 646 204 632L59 43C56 32 55 25 55 21C55 0 66-11 87-11C104-11 117-3 124 12C129 21 147 92 179 226C231 221 286 196 286 146C286 131 279 101 279 91C279 34 316-11 373-11C431-11 470 41 490 145C490 154 485 159 475 159C466 159 460 152 457 138C435 59 408 19 375 19C357 19 348 33 348 61C348 77 360 131 360 147C360 204 314 239 221 253C244 269 270 292 298 322C326 352 346 371 359 382C386 404 412 415 435 415C445 415 453 413 459 409C432 404 409 379 409 353Z"></path><path id="MJX-12-NCM-I-1D43B" d="M881 668C881 678 875 683 863 683L736 680L609 683C593 683 586 674 586 659C586 652 589 647 594 646C604 645 612 644 617 644C648 643 665 641 670 640C675 639 678 636 678 631C677 628 676 622 674 613L615 375L321 375L379 602C384 623 393 636 406 641C413 643 430 644 458 644C485 644 496 644 496 668C496 678 490 683 478 683L351 680L223 683C207 683 200 674 200 659C200 652 203 647 209 646C219 645 227 644 232 644C263 643 281 641 286 640C291 639 293 636 293 631C293 629 292 623 289 613L156 82C151 60 141 47 126 42C119 40 101 39 70 39C48 39 39 37 39 15C39 5 45 0 57 0L183 3L246 2C257 2 299 0 310 0C326 0 334 8 334 24C334 34 323 39 302 39C262 39 242 43 242 52C242 52 243 55 245 68L312 336L605 336L538 68C535 53 523 43 503 40C498 39 481 39 452 39C433 39 424 31 424 15C424 5 430 0 442 0L568 3L631 2C642 2 683 0 696 0C712 0 720 8 720 24C720 34 709 39 688 39C647 39 627 43 627 52C627 52 628 55 630 68L764 602C769 623 778 636 791 641C797 643 814 644 843 644C869 644 881 644 881 668Z"></path><path id="MJX-12-NCM-I-1D44E" d="M498 144C498 153 493 158 482 158C474 158 468 151 465 137C445 58 421 18 394 18C377 18 368 32 368 60C368 73 372 97 381 132L438 357C443 376 445 387 445 392C445 412 434 422 412 422C391 422 377 410 370 387C349 424 319 442 281 442C216 442 159 409 109 343C63 281 40 217 40 150C40 63 91-11 175-11C218-11 260 12 300 58C311 20 345-11 392-11C461-11 482 70 498 144M341 374C350 353 355 339 355 330C355 326 354 321 353 314L304 122C301 111 294 99 285 87C248 41 212 18 177 18C138 18 118 48 118 107C118 131 124 167 136 215C157 300 187 357 224 388C244 405 263 413 282 413C309 413 329 400 341 374Z"></path><path id="MJX-12-NCM-I-1D45B" d="M537 137C514 58 481 18 440 18C427 18 420 28 420 47C420 61 426 84 438 115C478 224 498 296 498 333C498 403 451 442 381 442C322 442 271 416 230 363C222 407 187 442 136 442C80 442 58 390 44 345C34 313 29 294 29 287C29 278 34 273 45 273C50 273 53 274 56 276C61 285 64 292 65 299C83 375 106 413 133 413C151 413 160 399 160 371C160 358 155 331 144 290L87 63C84 50 78 24 78 19C78-1 89-11 111-11C130-11 144-1 151 19C153 24 159 49 170 92L191 181L221 295C232 318 249 341 270 365C299 397 335 413 378 413C411 413 427 391 427 348C427 310 406 234 363 120C356 102 353 87 353 74C353 25 390-11 438-11C482-11 517 14 542 64C561 104 571 131 571 144C571 153 566 158 555 158C552 158 537 149 537 137Z"></path><path id="MJX-12-NCM-I-1D451" d="M429 632L370 389C349 426 320 445 281 445C216 445 159 412 109 345C63 283 40 218 40 151C40 63 91-11 175-11C218-11 260 12 300 59C311 21 345-11 392-11C461-11 483 71 498 145C498 154 493 159 483 159C474 159 468 152 465 138C445 59 421 19 394 19C377 19 368 33 368 60C368 75 370 91 374 107L516 679L516 683C513 690 507 694 499 694C476 694 434 690 374 683C363 682 357 674 357 660C357 650 366 645 384 645C403 645 429 646 429 632M341 376C351 355 356 341 356 332C355 328 354 323 353 316L304 122C301 111 294 99 285 87C248 42 212 19 177 19C138 19 118 49 118 108C118 132 124 168 136 216C157 301 187 359 224 390C244 407 263 415 282 415C309 415 329 402 341 376Z"></path><path id="MJX-12-NCM-I-1D452" d="M124 129C124 153 129 186 139 227L188 227C253 227 303 235 339 250C372 264 394 284 405 309C412 326 415 342 415 355C415 410 363 442 307 442C268 442 229 432 190 412C113 372 46 281 46 171C46 69 105-11 204-11C257-11 304 2 345 27C379 48 404 69 420 90C427 99 430 106 430 109C430 120 425 126 414 126C409 126 404 122 398 114C365 70 324 42 277 30C246 22 223 18 206 18C149 18 124 72 124 129M375 355C375 289 311 256 182 256L147 256C166 322 194 366 232 387C262 404 287 413 307 413C343 413 375 391 375 355Z"></path><path id="MJX-12-NCM-N-3A" d="M192 375C192 405 169 431 139 431C109 431 86 405 86 375C86 345 109 319 139 319C169 319 192 345 192 375M192 56C192 86 169 112 139 112C109 112 86 86 86 56C86 26 109 0 139 0C169 0 192 26 192 56Z"></path><path id="MJX-12-NCM-I-1D440" d="M594 16C594 5 600 0 613 0L736 3C759 4 840 0 859 0C874 0 882 8 882 24C882 34 872 39 851 39C810 39 790 43 790 52C790 55 792 62 795 75L927 602C932 623 942 636 955 641C961 643 979 644 1008 644C1033 644 1044 645 1044 668C1044 678 1034 683 1013 683L882 683C853 683 853 681 840 662L484 108L408 657C404 682 402 683 373 683L237 683C215 683 204 682 204 660C204 649 215 644 236 644C256 644 297 647 297 631C297 629 296 623 293 613L167 110C158 72 135 49 100 42C75 39 42 43 42 16C42 5 48 0 60 0C78 0 141 3 159 3C178 3 242 0 261 0C276 0 283 8 283 24C283 33 276 38 261 39C219 39 198 52 198 78C198 82 199 89 202 100L332 621L415 26C418 9 424 0 434 0C442 0 450 7 459 20L848 627L712 82C706 60 696 47 681 42C675 40 656 39 625 39C604 39 594 37 594 16Z"></path><path id="MJX-12-NCM-I-1D465" d="M527 373C527 419 482 442 432 442C389 442 355 419 329 373C308 419 273 442 222 442C173 442 133 419 101 374C74 335 60 306 60 287C60 278 65 273 75 273C84 273 90 278 92 287C111 345 153 413 220 413C253 413 269 392 269 351C269 330 251 252 216 118C199 51 169 18 126 18C112 18 99 21 88 26C114 36 127 54 127 80C127 106 114 119 87 119C54 119 29 91 29 58C29 12 76-11 125-11C167-11 201 12 228 58C247 12 283-11 335-11C383-11 423 12 455 57C482 96 496 125 496 144C496 153 491 158 481 158C472 158 467 153 464 144C447 87 402 18 337 18C304 18 287 38 287 79C287 92 292 120 303 165L337 300C356 375 387 413 431 413C445 413 458 410 469 405C442 396 429 378 429 351C429 325 443 312 470 312C502 312 527 341 527 373Z"></path><path id="MJX-12-NCM-I-1D438" d="M199 656C199 646 210 641 231 641C271 641 291 637 291 628C291 625 289 618 286 605L156 82C151 60 141 47 126 42C119 40 101 39 70 39C48 39 38 37 38 16C38 5 49 0 70 0L583 0C607 0 609 2 617 19L657 109C684 171 703 217 714 248C712 257 709 263 698 263C691 263 685 258 681 249C656 190 632 145 608 113C568 59 509 39 415 39L270 39C260 39 253 39 249 40C243 40 240 42 240 45C240 47 242 54 245 67L311 334L406 334C453 334 478 328 483 315C485 310 486 303 486 293C486 280 484 264 479 245C477 240 476 236 476 233C476 223 482 218 493 218C502 218 508 226 512 241L568 473C568 483 563 488 552 488C544 488 538 481 535 467C525 428 512 403 495 391C478 379 450 373 409 373L321 373L379 606C387 640 387 641 429 641L568 641C619 641 654 636 673 626C701 611 715 581 715 536C715 519 714 501 711 484C711 482 711 479 710 475L710 466C710 455 715 450 725 450C735 450 741 459 743 478L763 649C766 677 759 680 732 680L233 680C210 680 199 679 199 656Z"></path><path id="MJX-12-NCM-I-1D43F" d="M520 667C520 678 513 683 500 683L354 680L223 683C208 684 200 676 200 659C200 652 203 647 209 646C218 645 226 644 231 644C262 643 279 641 284 640C289 639 292 636 292 631C292 629 291 623 288 613L156 82C150 60 140 47 125 42C119 40 101 39 70 39C49 39 39 31 39 15C39 5 49 0 70 0L527 0C552 0 554 0 561 19L639 233C642 240 643 245 643 248C643 258 638 263 627 263C617 263 612 254 607 240C588 191 570 154 555 131C518 75 455 39 363 39L270 39C259 39 252 39 249 40C242 40 239 42 239 45C239 47 241 54 244 67L377 601C383 624 396 637 415 642C421 643 442 644 478 644C506 644 520 644 520 667Z"></path><path id="MJX-12-NCM-I-1D454" d="M15-141C15-184 60-205 150-205C197-205 241-193 280-170C324-144 351-109 362-66L471 373C473 383 474 389 474 392C474 412 463 422 442 422C420 422 406 410 399 387C377 424 347 442 310 442C246 442 189 410 140 346C95 286 72 223 72 158C72 71 123-3 207-3C246-3 282 14 315 47L285-71C256-140 211-175 148-175C122-175 100-173 82-169C103-158 113-141 113-118C113-93 99-80 72-80C40-80 15-109 15-141M356 392C376 371 386 351 386 331C386 330 385 325 383 318L336 129C330 106 313 82 286 60C259 38 233 27 210 27C170 27 150 56 150 114C150 169 184 291 204 327C235 384 270 412 311 412C329 412 344 405 356 392Z"></path><path id="MJX-12-NCM-I-1D461" d="M330 419C330 428 320 433 299 433L218 433C244 537 257 591 257 595C257 616 246 626 225 626C202 626 188 613 182 587L145 433L56 433C34 433 23 432 23 411C23 400 33 395 54 395L135 395C86 200 62 97 62 84C62 28 100-11 156-11C194-11 227 6 256 41C280 70 297 98 308 125C312 136 314 142 314 145C314 154 309 159 299 159C291 159 285 154 281 143C247 60 206 19 157 19C140 19 131 33 131 60C131 75 133 91 137 107L208 395L297 395C323 395 330 397 330 419Z"></path><path id="MJX-12-NCM-I-210E" d="M512 138C489 59 457 19 415 19C402 19 395 28 395 47C395 62 401 85 413 116C453 223 473 296 473 335C473 406 427 445 356 445C303 445 257 423 218 380L291 679C289 688 287 694 274 694C241 694 168 685 155 684C140 682 132 675 132 660C132 650 141 645 159 645C180 645 203 646 205 632L59 43C56 32 55 25 55 21C55 0 66-11 87-11C107-11 121-1 128 18L168 182C180 231 189 268 196 293C199 300 207 314 220 334C256 388 300 415 353 415C386 415 402 393 402 350C402 309 382 236 342 130C333 107 329 89 329 74C329 26 365-11 413-11C457-11 492 14 517 65C536 105 546 132 546 145C546 154 541 159 530 159C527 159 512 150 512 138Z"></path><path id="MJX-12-NCM-N-3D" d="M698 367L80 367C64 367 56 359 56 344C56 329 64 321 80 321L698 321C714 321 722 329 722 344C722 356 711 367 698 367M698 179L80 179C64 179 56 171 56 156C56 141 64 133 80 133L698 133C714 133 722 141 722 156C722 169 711 179 698 179Z"></path><path id="MJX-12-NCM-N-30" d="M249-22C390-22 460 92 460 320C460 473 428 575 365 625C330 652 291 666 250 666C109 666 39 551 39 320C39 136 88-22 249-22M361 524C368 489 371 425 371 332C371 240 367 172 360 128C347 48 310 8 249 8C226 8 203 17 182 34C155 57 139 104 132 176C129 201 128 253 128 332C128 419 131 480 136 513C145 568 163 603 191 618C213 630 232 636 249 636C314 636 350 583 361 524Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="2 * BlockHandle::kMaxEncodedLength = 20"><g data-mml-node="mn" data-latex="2"><use data-c="32" xlink:href="#MJX-12-NCM-N-32"></use></g><g data-mml-node="mo" data-latex="*" transform="translate(722.2,0)"><use data-c="2217" xlink:href="#MJX-12-NCM-N-2217"></use></g><g data-mml-node="mi" data-latex="B" transform="translate(1444.4,0)"><use data-c="1D435" xlink:href="#MJX-12-NCM-I-1D435"></use></g><g data-mml-node="mi" data-latex="l" transform="translate(2203.4,0)"><use data-c="1D459" xlink:href="#MJX-12-NCM-I-1D459"></use></g><g data-mml-node="mi" data-latex="o" transform="translate(2501.4,0)"><use data-c="1D45C" xlink:href="#MJX-12-NCM-I-1D45C"></use></g><g data-mml-node="mi" data-latex="c" transform="translate(2986.4,0)"><use data-c="1D450" xlink:href="#MJX-12-NCM-I-1D450"></use></g><g data-mml-node="mi" data-latex="k" transform="translate(3419.4,0)"><use data-c="1D458" xlink:href="#MJX-12-NCM-I-1D458"></use></g><g data-mml-node="mi" data-latex="H" transform="translate(3940.4,0)"><use data-c="1D43B" xlink:href="#MJX-12-NCM-I-1D43B"></use></g><g data-mml-node="mi" data-latex="a" transform="translate(4821.4,0)"><use data-c="1D44E" xlink:href="#MJX-12-NCM-I-1D44E"></use></g><g data-mml-node="mi" data-latex="n" transform="translate(5350.4,0)"><use data-c="1D45B" xlink:href="#MJX-12-NCM-I-1D45B"></use></g><g data-mml-node="mi" data-latex="d" transform="translate(5950.4,0)"><use data-c="1D451" xlink:href="#MJX-12-NCM-I-1D451"></use></g><g data-mml-node="mi" data-latex="l" transform="translate(6470.4,0)"><use data-c="1D459" xlink:href="#MJX-12-NCM-I-1D459"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(6768.4,0)"><use data-c="1D452" xlink:href="#MJX-12-NCM-I-1D452"></use></g><g data-mml-node="mo" data-latex="::" transform="translate(7512.2,0)"><g data-mml-node="text"><use data-c="3A" xlink:href="#MJX-12-NCM-N-3A"></use></g><g data-mml-node="text" transform="translate(278,0)"><use data-c="3A" xlink:href="#MJX-12-NCM-N-3A"></use></g></g><g data-mml-node="mi" data-latex="k" transform="translate(8346,0)"><use data-c="1D458" xlink:href="#MJX-12-NCM-I-1D458"></use></g><g data-mml-node="mi" data-latex="M" transform="translate(8867,0)"><use data-c="1D440" xlink:href="#MJX-12-NCM-I-1D440"></use></g><g data-mml-node="mi" data-latex="a" transform="translate(9911,0)"><use data-c="1D44E" xlink:href="#MJX-12-NCM-I-1D44E"></use></g><g data-mml-node="mi" data-latex="x" transform="translate(10440,0)"><use data-c="1D465" xlink:href="#MJX-12-NCM-I-1D465"></use></g><g data-mml-node="mi" data-latex="E" transform="translate(11012,0)"><use data-c="1D438" xlink:href="#MJX-12-NCM-I-1D438"></use></g><g data-mml-node="mi" data-latex="n" transform="translate(11778,0)"><use data-c="1D45B" xlink:href="#MJX-12-NCM-I-1D45B"></use></g><g data-mml-node="mi" data-latex="c" transform="translate(12378,0)"><use data-c="1D450" xlink:href="#MJX-12-NCM-I-1D450"></use></g><g data-mml-node="mi" data-latex="o" transform="translate(12811,0)"><use data-c="1D45C" xlink:href="#MJX-12-NCM-I-1D45C"></use></g><g data-mml-node="mi" data-latex="d" transform="translate(13296,0)"><use data-c="1D451" xlink:href="#MJX-12-NCM-I-1D451"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(13816,0)"><use data-c="1D452" xlink:href="#MJX-12-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="d" transform="translate(14282,0)"><use data-c="1D451" xlink:href="#MJX-12-NCM-I-1D451"></use></g><g data-mml-node="mi" data-latex="L" transform="translate(14802,0)"><use data-c="1D43F" xlink:href="#MJX-12-NCM-I-1D43F"></use></g><g data-mml-node="mi" data-latex="e" transform="translate(15483,0)"><use data-c="1D452" xlink:href="#MJX-12-NCM-I-1D452"></use></g><g data-mml-node="mi" data-latex="n" transform="translate(15949,0)"><use data-c="1D45B" xlink:href="#MJX-12-NCM-I-1D45B"></use></g><g data-mml-node="mi" data-latex="g" transform="translate(16549,0)"><use data-c="1D454" xlink:href="#MJX-12-NCM-I-1D454"></use></g><g data-mml-node="mi" data-latex="t" transform="translate(17026,0)"><use data-c="1D461" xlink:href="#MJX-12-NCM-I-1D461"></use></g><g data-mml-node="mi" data-latex="h" transform="translate(17387,0)"><use data-c="210E" xlink:href="#MJX-12-NCM-I-210E"></use></g><g data-mml-node="mo" data-latex="=" transform="translate(18240.8,0)"><use data-c="3D" xlink:href="#MJX-12-NCM-N-3D"></use></g><g data-mml-node="mn" data-latex="0" transform="translate(19296.6,0)"><use data-c="32" xlink:href="#MJX-12-NCM-N-32"></use><use data-c="30" xlink:href="#MJX-12-NCM-N-30" transform="translate(500,0)"></use></g></g></g></svg> 长度。</li>
<li>4、以小端序写入一个64比特的魔法数。</li></ul>
<img src='https://s2.loli.net/2025/08/06/uDUmJwMT3oy2S5A.png' title='ldb-footer' alt='ldb-footer' width='600'/>
<h3>5.2 “块”的格式</h3>
<p class="text-align-justify">将键值写入块的内存缓冲区时，每连续 16 （默认值，可配置）个键会进行 delta 编码压缩：</p>
<ul><li>1、先计算当前键与前一次写入键的共同前缀长度</li>
<li>2、依次写入“键共同前缀长度”、“当前键去掉共同前缀后的长度”、“值的长度”、“当前键去掉共同前缀后的内容”、“值内容”</li></ul>
<p class="text-align-justify">如果连续“delta 编码压缩”的键数/写入次数达到阈值 16，则将当前内存缓冲区的大小记录到“重置位点列表”（<code>restarts_</code>）中。</p>
<p class="text-align-justify">将块的内存缓存区内容落到文件的流程：</p>
<ul><li>1、把<u>“重置位点列表”中的元素</u>依次逐个添加到缓冲区尾部。</li>
<li>2、将<u>“重置位点”数量</u>以固定32比特长度添加到缓冲区尾部。</li>
<li>3、将缓冲区内容整体做一次通用压缩（可配置 不压缩、snappy 压缩、zstd 压缩）。</li>
<li>4、将压缩后的字节序列写入文件后，再将 压缩类型(CompressionType，1字节) 和 “压缩后的字节序列 与 压缩类型” 的 crc32 校验码（4字节）写到文件的尾部。</li></ul>
<pre class="language-cpp"><code>enum CompressionType {  
  // NOTE: do not change the values of existing entries, as these are  
  // part of the persistent format on disk.
  kNoCompression = 0x0,  
  kSnappyCompression = 0x1,  
  kZstdCompression = 0x2,  
};</code></pre>
<img src='https://s2.loli.net/2025/08/06/YaFdPy6cN3bOAkU.png' title='ldb-block-encode' alt='ldb-block-encode' width='800'/>
<h3>5.3 “data 块”</h3>
<p class="text-align-justify">leveldb 文件中“data 块”数据是按照 key 有序存储的。同一个文件中，块与块之间有序，块之间 key 范围不会有重合，块内内容也是按 key 有序存储。</p>
<p class="text-align-justify">因为有序， 使用默认的 BytewiseComparator，delta 编码压缩效果通常会明显。</p>
<p class="text-align-justify">对于“data 块”，如果块的内存缓冲区内容大小（通用压缩前的原始内容大小+重置位点数组大小+重置位点数组长度）超过 4KB（可配置，配置项 <code>block_size</code>），就会将块的内存缓冲区作为一个“data 块”落到文件中。</p>
<pre class="language-cpp"><code>// Approximate size of user data packed per block.  Note that the  
// block size specified here corresponds to uncompressed data.  The  
// actual size of the unit read from disk may be smaller if  
// compression is enabled.  This parameter can be changed dynamically.  
size_t block_size = 4 * 1024;</code></pre>
<h3>5.4 “index 块”</h3>
<p class="text-align-justify">“index 块” 存储 “data 块” 的索引信息。</p>
<p class="text-align-justify">当一个“data 块”从内存缓存区落到文件后，将该“data 块”最后/最大的 key（经存储优化处理后） 作为 键（<u>大致含义-当前块中所有 key 都小于该键，下一个块中所有 key 都大于等于该键</u>），该“data 块”在文件中的偏移位置 offset 和 块大小 size 打包后作为值，写入“index 块”内存缓冲区。</p>
<p class="text-align-justify">当 leveldb 文件的所有“data 块”都写入文件后，会将“index 块”内存缓冲区内容也按照“块”格式写入文件。</p>
<p class="text-align-justify">Get key 检索时，</p>
<ul><li>1、先从 “Footer” 部分取出“index 块的” offer 和 size，</li>
<li>2、然后在“index 块”进行二分查找，找到目标“data 块”，</li>
<li>3、从目标“data 块”中解析出来重置位点数组，继续进行二分查找。</li></ul>
<h3>5.5 “meta 块” & “metaindex 块”</h3>
<pre class="language-cpp"><code>// A FilterBlockBuilder is used to construct all of the filters for a  
// particular Table.  It generates a single string which is stored as  
// a special block in the Table.  
//  
// The sequence of calls to FilterBlockBuilder must match the regexp:  
//      (StartBlock AddKey*)* Finish  
class FilterBlockBuilder {  
 public:  
  explicit FilterBlockBuilder(const FilterPolicy*);  
  
  void StartBlock(uint64_t block_offset);  
  void AddKey(const Slice&amp; key);  
  Slice Finish();  
  
 private:  
  void GenerateFilter();  
  
  const FilterPolicy* policy_;  

  std::string keys_;             // Flattened key contents  
  std::vector&lt;size_t&gt; start_;    // Starting index in keys_ of each key  

  std::string result_;           // Filter data computed so far  
  std::vector&lt;Slice&gt; tmp_keys_;  // policy_-&gt;CreateFilter() argument  
  std::vector&lt;uint32_t&gt; filter_offsets_;  
};

void FilterBlockBuilder::StartBlock(uint64_t block_offset) {  
  uint64_t filter_index = (block_offset / kFilterBase);  
  assert(filter_index &gt;= filter_offsets_.size());  
  while (filter_index &gt; filter_offsets_.size()) {  
    GenerateFilter();  
  }  
}

void FilterBlockBuilder::AddKey(const Slice&amp; key) {  
  Slice k = key;  
  start_.push_back(keys_.size());  
  keys_.append(k.data(), k.size());  
}</code></pre>
<p class="text-align-justify">目前的实现，如果 leveldb 文件中存在“meta 块”，应该也只会有一个，即<strong>过滤数据块</strong>。</p>
<p class="text-align-justify">如果 leveldb 数据库开启了检索时过滤策略（FilterPolicy），则对于写入“data 块”的每个 key，都会被记录到 filter 内存缓冲区（<code>FilterBlockBuilder</code>）中。</p>
<p class="text-align-justify">当一个“data 块”刷到文件后，就对 FilterBlockBuilder 中存入的 key 序列算一下“过滤数据”，拼接到 <code>result_</code> 后面，以及将最新计算的“过滤数据”在 <code>result_</code> 中的偏移位置存到 <code>filter_offets_</code> 向量中。</p>
<pre class="language-text"><code>准备处理第一个“data 块”时，
- FilterBlockBuilder 的 filter_offsets_ 为空数组 []， result_ 为空字符串 &quot;&quot;
- 当第一个“data 块”刷到数据文件后，准备处理第二个“data 块”，因&lt;u&gt;逻辑上&lt;/u&gt;约束每 2KB 数据算一次过滤数据
	- case-1：如果第一个“data 块”大小 &lt; 4KB（大概率是这样），那么 filter_index = 1，对这个“data 块”的所有 key 算一次过滤数据，result_ 长度为 a， filter_offset_ 将变成 [0],
	- case-2：如果第一个“data 块”大小 &gt;（=）4KB且&lt; 8KB，那么 filter_index = 2，对这个“data 块”的所有 key 算一次过滤数据，result_ 长度为 a&apos;，filter_offset_ 将变成 [0, a&apos;]
	- case-3：如果第一个“data 块”大小 &gt;（=）8KB且&lt; 16KB，那么 filter_index = 3，对这个“data 块”的所有 key 算一次过滤数据，result_ 长度为 a&apos;&apos;，filter_offset_ 将变成 [0, a&apos;&apos;, a&apos;&apos;]
- 如果第二个“data 块”为&lt;u&gt;最后一个&lt;/u&gt;，不管大小多少，刷到数据文件后，对第二个“data 块”的所有 key 算一次过滤数据，result_ 长度为 b
	- 对于 case-1，filter_offset_ 先填充为 [0, a]，最后会填充为 [0, a, b]
	- 对于 case-2，filter_offset_ 先填充为 [0, a&apos;, a&apos;]，最后会填充为 [0, a&apos;, a&apos;, b]
	- 对于 case-3，filter_offset_ 先填充为 [0, a&apos;&apos;, a&apos;&apos;, a&apos;&apos;]，最后会填充为 [0, a&apos;&apos;, a&apos;&apos;, a&apos;&apos;, b]
- 那么在过滤匹配时，
	- 对于第一个“data 块”，因其 offset 为 0，所以 filter_offset_ 的 0 &amp; 1 位置的值为区间从 result_ 中去对应的过滤数据
	- 对于第二个“data 块”，
		- case-1 时，其 offset &lt; 4KB，以 filter_offset_ 的 1 &amp; 2 位置的值为区间从 result_ 中去对应的过滤数据
		- case-2 时，其 offset 在 [4KB, 8KB) 区间，以 filter_offset_ 的 2 &amp; 3 位置的值为区间从 result_ 中去对应的过滤数据
		- case-3 时，其 offset 在 [8KB, 16KB) 区间，以 filter_offset_ 的 3 &amp; 4 位置的值为区间从 result_ 中去对应的过滤数据
- 所以 FilterBlockBuilder 的处理逻辑会对 filter_offset_ 做一些额外的填充，确保根据“data 块”在文件中的偏移位置 offset，能够正确地找到对应的 过滤数据块。</code></pre>
<p class="text-align-justify">当 leveldb 文件的所有“data 块”都写入文件后，</p>
<ul><li>1、将 <code>filter_offets_</code> 中的偏移位置数据逐个以 32 比特定长编码后拼接到 <code>result_</code> 后面，</li>
<li>2、接着将“还未拼接偏移位置数据时的 <code>result_</code> 长度”以 32 比特定长编码后拼接到 <code>result_</code> 后面，</li>
<li>3、然后将 kFilterBaseLg（=11）参数拼接到后面（占用1个字节），</li>
<li>4、最后将 <code>result_</code> 作为“meta 块”的原始数据<strong>不经压缩地</strong>写入文件中。（<u>这里有点特殊，和其他块不太一样，其他块都是键值对编码写入的</u>）</li></ul>
<img src='https://s2.loli.net/2025/08/06/3pdZIHsFlSvmCQA.png' title='ldb-filter-block' alt='ldb-filter-block' width='800'/>
<p class="text-align-justify">并将 过滤策略 名称拼接上前缀<code>filter.</code> 作为 键，将meta 块（“过滤数据块”）在文件中的偏移位置 offset 和块大小 size 编码后作为值，写入 metaindex 块中。</p>
<p class="text-align-justify">打开数据库时，</p>
<ul><li>1、先从 “Footer” 部分读取“metaindex 块”的偏移位置 offset 和 块大小 size</li>
<li>2、从“metaindex 块”中解析出使用的“过滤策略”名称，以及过滤数据，初始化过滤策略</li></ul>
<p class="text-align-justify">Get key 检索时，对 ldb 文件的“data 块”进行检索时，都先根据过滤策略做一下过滤，从而减少文件的磁盘读取次数。</p>
    </article>
</div>


<div class="comment">
     <script src="https://giscus.app/client.js"
        data-repo="kitelife/kitelife.github.com"
        data-repo-id="MDEwOlJlcG9zaXRvcnk4NTg1Njcx"
        data-category="giscus"
        data-category-id="DIC_kwDOAIMBx84Ctgkx"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
      </script>
    </div>



    </div>
</div>
<footer class="site-footer">
    <div class="wrapper">
        <div class="footer-col-wrapper">
            <div class="footer-col footer-col-1">
                <ul class="social-media-list">
                    <li>
                        <a href="https://github.com/kitelife" target="_blank">
                            <span class="icon icon--github">
                                <svg viewBox="0 0 16 16">
                                    <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                                </svg>
                            </span>
                            <span class="username">kitelife</span>
                        </a>
                    </li>
                    <li>
                        <a href="https://maimai.cn/profile/detail?dstu=39580141" target="_blank">
                            <span class="icon icon--maimai">
                                <img src="https://maimai.cn/favicon.ico" width="16"/>
                            </span>
                            <span class="username">Xiayf</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="footer-col footer-col-2"></div>
            <div class="footer-col footer-col-3"></div>
            <div class="footer-col footer-col-4">
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank">
                    <img alt="Creative Commons License" src="https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg">
                </a>
            </div>
        </div>
    </div>
</footer>


<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>


</body>
</html>