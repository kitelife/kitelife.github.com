<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="678.9855px" preserveAspectRatio="none" style="width:800px;height:678px;background:#FFFFFF;" version="1.1" viewBox="0 0 800 678" width="800.7246px" zoomAndPan="magnify"><defs><filter height="300%" id="fbte20mazj62e" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.4492753623188406"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="2.898550724637681" dy="2.898550724637681" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[cf7212f148c2a2f46c357ea31d18a0ad]
class Cache--><rect codeLine="4" fill="#FEFECE" filter="url(#fbte20mazj62e)" height="100" id="Cache" style="stroke:#A80036;stroke-width:1.0869565217391304;" width="305.0725" x="5.0725" y="293.4783"/><ellipse cx="138.587" cy="305.0725" fill="#B4A7E5" rx="7.971" ry="7.971" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><path d="M136.239,302.5139 L136.239,301.134 L140.9572,301.134 L140.9572,302.5139 L139.3809,302.5139 L139.3809,307.678 L140.9572,307.678 L140.9572,309.058 L136.239,309.058 L136.239,307.678 L137.8153,307.678 L137.8153,302.5139 Z " fill="#000000"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" font-style="italic" lengthAdjust="spacing" textLength="31.8841" x="153.442" y="308.8768">Cache</text><line style="stroke:#A80036;stroke-width:1.0869565217391304;" x1="5.7971" x2="309.4203" y1="316.6667" y2="316.6667"/><line style="stroke:#A80036;stroke-width:1.0869565217391304;" x1="5.7971" x2="309.4203" y1="322.4638" y2="322.4638"/><ellipse cx="13.0435" cy="330.4348" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="286.2319" x="19.5652" y="335.6884">virtual Handle* Insert(const Slice&amp; key, void* value, ...) = 0</text><ellipse cx="13.0435" cy="343.4783" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="221.0145" x="19.5652" y="348.7319">virtual Handle* Lookup(const Slice&amp; key) = 0</text><ellipse cx="13.0435" cy="356.5217" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="192.029" x="19.5652" y="361.7754">virtual void* Value(Handle* handle) = 0</text><ellipse cx="13.0435" cy="369.5652" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="197.1014" x="19.5652" y="374.8188">virtual void Release(Handle* handle) = 0</text><ellipse cx="13.0435" cy="382.6087" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="193.4783" x="19.5652" y="387.8623">virtual void Erase(const Slice&amp; key) = 0</text><!--MD5=[7321d795a6de0b901ade2f2ab05a1695]
class ShardedLRUCache--><rect codeLine="12" fill="#FEFECE" filter="url(#fbte20mazj62e)" height="152.1739" id="ShardedLRUCache" style="stroke:#A80036;stroke-width:1.0869565217391304;" width="252.8986" x="134.058" y="516.6667"/><ellipse cx="211.0507" cy="528.2609" fill="#ADD1B2" rx="7.971" ry="7.971" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><path d="M212.8025,532.0182 Q212.431,532.2092 212.0223,532.3048 Q211.6137,532.4003 211.1625,532.4003 Q209.5597,532.4003 208.7158,531.3441 Q207.8719,530.2879 207.8719,528.2924 Q207.8719,526.2915 208.7158,525.2353 Q209.5597,524.1791 211.1625,524.1791 Q211.6137,524.1791 212.0276,524.2747 Q212.4416,524.3702 212.8025,524.5613 L212.8025,526.3021 Q212.3992,525.9306 212.0197,525.7581 Q211.6402,525.5856 211.2368,525.5856 Q210.377,525.5856 209.9392,526.2676 Q209.5013,526.9496 209.5013,528.2924 Q209.5013,529.6298 209.9392,530.3118 Q210.377,530.9938 211.2368,530.9938 Q211.6402,530.9938 212.0197,530.8213 Q212.3992,530.6488 212.8025,530.2773 Z " fill="#000000"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="92.7536" x="225.9058" y="532.0652">ShardedLRUCache</text><line style="stroke:#A80036;stroke-width:1.0869565217391304;" x1="134.7826" x2="386.2319" y1="539.8551" y2="539.8551"/><rect fill="none" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="139.8551" y="545.6522"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="156.5217" x="148.5507" y="553.0797">LRUCache shard_[kNumShards]</text><rect fill="none" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="139.8551" y="558.6957"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="109.4203" x="148.5507" y="566.1232">port::Mutex id_mutex_</text><rect fill="none" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="139.8551" y="571.7391"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="81.8841" x="148.5507" y="579.1667">uint64_t last_id_</text><line style="stroke:#A80036;stroke-width:1.0869565217391304;" x1="134.7826" x2="386.2319" y1="584.7826" y2="584.7826"/><ellipse cx="142.029" cy="592.7536" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="212.3188" x="148.5507" y="598.0072">explicit ShardedLRUCache(size_t capacity)</text><ellipse cx="142.029" cy="605.7971" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="234.058" x="148.5507" y="611.0507">Handle* Insert(const Slice&amp; key, void* value, ...)</text><ellipse cx="142.029" cy="618.8406" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="212.3188" x="148.5507" y="624.0942">Handle* Lookup(const Slice&amp; key) override</text><ellipse cx="142.029" cy="631.8841" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="188.4058" x="148.5507" y="637.1377">void Release(Handle* handle) override</text><ellipse cx="142.029" cy="644.9275" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="184.7826" x="148.5507" y="650.1812">void Erase(const Slice&amp; key) override</text><ellipse cx="142.029" cy="657.971" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="183.3333" x="148.5507" y="663.2246">void* Value(Handle* handle) override</text><!--MD5=[efb1cb8eb6bb5f9c30e83dbb1b0004cc]
class LRUCache--><rect codeLine="25" fill="#FEFECE" filter="url(#fbte20mazj62e)" height="230.4348" id="LRUCache" style="stroke:#A80036;stroke-width:1.0869565217391304;" width="363.7681" x="335.1449" y="228.2609"/><ellipse cx="488.2246" cy="239.8551" fill="#ADD1B2" rx="7.971" ry="7.971" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><path d="M489.9764,243.6124 Q489.6049,243.8034 489.1962,243.899 Q488.7876,243.9945 488.3364,243.9945 Q486.7336,243.9945 485.8897,242.9383 Q485.0459,241.8821 485.0459,239.8866 Q485.0459,237.8857 485.8897,236.8295 Q486.7336,235.7733 488.3364,235.7733 Q488.7876,235.7733 489.2016,235.8689 Q489.6155,235.9644 489.9764,236.1555 L489.9764,237.8963 Q489.5731,237.5248 489.1936,237.3523 Q488.8141,237.1798 488.4108,237.1798 Q487.551,237.1798 487.1131,237.8618 Q486.6752,238.5438 486.6752,239.8866 Q486.6752,241.224 487.1131,241.906 Q487.551,242.588 488.4108,242.588 Q488.8141,242.588 489.1936,242.4155 Q489.5731,242.2431 489.9764,241.8715 Z " fill="#000000"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="51.4493" x="503.0797" y="243.6594">LRUCache</text><line style="stroke:#A80036;stroke-width:1.0869565217391304;" x1="335.8696" x2="698.1884" y1="251.4493" y2="251.4493"/><rect fill="none" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="340.942" y="257.2464"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="73.913" x="349.6377" y="264.6739">LRUHandle lru_</text><rect fill="none" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="340.942" y="270.2899"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="93.4783" x="349.6377" y="277.7174">LRUHandle in_use_</text><rect fill="none" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="340.942" y="283.3333"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="93.4783" x="349.6377" y="290.7609">HandleTable table_</text><line style="stroke:#A80036;stroke-width:1.0869565217391304;" x1="335.8696" x2="698.1884" y1="296.3768" y2="296.3768"/><ellipse cx="343.1159" cy="304.3478" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="166.6667" x="349.6377" y="309.6014">void SetCapacity(size_t capacity)</text><ellipse cx="343.1159" cy="317.3913" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="344.9275" x="349.6377" y="322.6449">Cache::Handle* Insert(const Slice&amp; key, uint32_t hash, void* value, ...)</text><ellipse cx="343.1159" cy="330.4348" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="279.7101" x="349.6377" y="335.6884">Cache::Handle* Lookup(const Slice&amp; key, uint32_t hash)</text><ellipse cx="343.1159" cy="343.4783" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="182.6087" x="349.6377" y="348.7319">void Release(Cache::Handle* handle)</text><ellipse cx="343.1159" cy="356.5217" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="214.4928" x="349.6377" y="361.7754">void Erase(const Slice&amp; key, uint32_t hash)</text><ellipse cx="343.1159" cy="369.5652" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="60.8696" x="349.6377" y="374.8188">void Prune()</text><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="0" x="352.5362" y="387.8623"/><rect fill="#F24D5C" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="340.942" y="393.4783"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="165.942" x="349.6377" y="400.9058">void LRU_Remove(LRUHandle* e)</text><rect fill="#F24D5C" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="340.942" y="406.5217"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="245.6522" x="349.6377" y="413.9493">void LRU_Append(LRUHandle* list, LRUHandle* e)</text><rect fill="#F24D5C" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="340.942" y="419.5652"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="116.6667" x="349.6377" y="426.9928">void Ref(LRUHandle* e)</text><rect fill="#F24D5C" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="340.942" y="432.6087"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="126.8116" x="349.6377" y="440.0362">void Unref(LRUHandle* e)</text><rect fill="#F24D5C" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="340.942" y="445.6522"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="157.2464" x="349.6377" y="453.0797">bool FinishErase(LRUHandle* e)</text><!--MD5=[f82e266a2cd8ccdb893f7fc26ae81a65]
class LRUHandle--><rect codeLine="44" fill="#FEFECE" filter="url(#fbte20mazj62e)" height="165.2174" id="LRUHandle" style="stroke:#A80036;stroke-width:1.0869565217391304;" width="130.4348" x="330.0725" y="5.0725"/><ellipse cx="365.3986" cy="16.6667" fill="#ADD1B2" rx="7.971" ry="7.971" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><path d="M367.1503,20.424 Q366.7788,20.615 366.3702,20.7106 Q365.9615,20.8061 365.5104,20.8061 Q363.9075,20.8061 363.0636,19.7499 Q362.2198,18.6937 362.2198,16.6982 Q362.2198,14.6973 363.0636,13.6411 Q363.9075,12.5849 365.5104,12.5849 Q365.9615,12.5849 366.3755,12.6805 Q366.7894,12.776 367.1503,12.9671 L367.1503,14.7079 Q366.747,14.3364 366.3675,14.1639 Q365.988,13.9914 365.5847,13.9914 Q364.7249,13.9914 364.287,14.6734 Q363.8491,15.3554 363.8491,16.6982 Q363.8491,18.0356 364.287,18.7176 Q364.7249,19.3996 365.5847,19.3996 Q365.988,19.3996 366.3675,19.2271 Q366.747,19.0546 367.1503,18.6831 Z " fill="#000000"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="53.6232" x="380.2536" y="20.471">LRUHandle</text><line style="stroke:#A80036;stroke-width:1.0869565217391304;" x1="330.7971" x2="459.7826" y1="28.2609" y2="28.2609"/><ellipse cx="338.0435" cy="36.2319" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;fill:none;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="55.0725" x="344.5652" y="41.4855">void* value</text><ellipse cx="338.0435" cy="49.2754" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;fill:none;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="111.5942" x="344.5652" y="54.529">LRUHandle* next_hash</text><ellipse cx="338.0435" cy="62.3188" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;fill:none;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="81.8841" x="344.5652" y="67.5725">LRUHandle* next</text><ellipse cx="338.0435" cy="75.3623" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;fill:none;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="83.3333" x="344.5652" y="80.6159">LRUHandle* prev</text><ellipse cx="338.0435" cy="88.4058" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;fill:none;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="84.7826" x="344.5652" y="93.6594">size_t key_length</text><ellipse cx="338.0435" cy="101.4493" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;fill:none;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="68.8406" x="344.5652" y="106.7029">bool in_cache</text><ellipse cx="338.0435" cy="114.4928" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;fill:none;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="61.5942" x="344.5652" y="119.7464">uint32_t refs</text><ellipse cx="338.0435" cy="127.5362" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;fill:none;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="67.3913" x="344.5652" y="132.7899">uint32_t hash</text><ellipse cx="338.0435" cy="140.5797" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;fill:none;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="78.9855" x="344.5652" y="145.8333">char key_data[1]</text><line style="stroke:#A80036;stroke-width:1.0869565217391304;" x1="330.7971" x2="459.7826" y1="151.4493" y2="151.4493"/><ellipse cx="338.0435" cy="159.4203" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="52.1739" x="344.5652" y="164.6739">Slice key()</text><!--MD5=[b38786ec0e33c79a4dbc7fbf32943c44]
class HandleTable--><rect codeLine="57" fill="#FEFECE" filter="url(#fbte20mazj62e)" height="139.1304" id="HandleTable" style="stroke:#A80036;stroke-width:1.0869565217391304;" width="305.0725" x="485.5072" y="18.1159"/><ellipse cx="604.529" cy="29.7101" fill="#ADD1B2" rx="7.971" ry="7.971" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><path d="M606.2808,33.4674 Q605.9093,33.6585 605.5006,33.754 Q605.0919,33.8496 604.6408,33.8496 Q603.038,33.8496 602.1941,32.7934 Q601.3502,31.7372 601.3502,29.7416 Q601.3502,27.7407 602.1941,26.6846 Q603.038,25.6284 604.6408,25.6284 Q605.0919,25.6284 605.5059,25.7239 Q605.9199,25.8195 606.2808,26.0105 L606.2808,27.7514 Q605.8774,27.3798 605.4979,27.2073 Q605.1185,27.0349 604.7151,27.0349 Q603.8553,27.0349 603.4174,27.7169 Q602.9796,28.3989 602.9796,29.7416 Q602.9796,31.0791 603.4174,31.7611 Q603.8553,32.4431 604.7151,32.4431 Q605.1185,32.4431 605.4979,32.2706 Q605.8774,32.0981 606.2808,31.7266 Z " fill="#000000"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="60.8696" x="619.3841" y="33.5145">HandleTable</text><line style="stroke:#A80036;stroke-width:1.0869565217391304;" x1="486.2319" x2="789.8551" y1="41.3043" y2="41.3043"/><rect fill="none" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="491.3043" y="47.1014"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="79.7101" x="500" y="54.529">uint32_t length_</text><rect fill="none" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="491.3043" y="60.1449"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="77.5362" x="500" y="67.5725">uint32_t elems_</text><rect fill="none" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="491.3043" y="73.1884"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="86.2319" x="500" y="80.6159">LRUHandle** list_</text><line style="stroke:#A80036;stroke-width:1.0869565217391304;" x1="486.2319" x2="789.8551" y1="86.2319" y2="86.2319"/><ellipse cx="493.4783" cy="94.2029" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="261.5942" x="500" y="99.4565">LRUHandle* Lookup(const Slice&amp; key, uint32_t hash)</text><ellipse cx="493.4783" cy="107.2464" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="165.2174" x="500" y="112.5">LRUHandle* Insert(LRUHandle* h)</text><ellipse cx="493.4783" cy="120.2899" fill="#84BE84" rx="2.1739" ry="2.1739" style="stroke:#038048;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="264.4928" x="500" y="125.5435">LRUHandle* Remove(const Slice&amp; key, uint32_t hash)</text><rect fill="#F24D5C" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="491.3043" y="131.1594"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="286.2319" x="500" y="138.587">LRUHandle** FindPointer(const Slice&amp; key, uint32_t hash)</text><rect fill="#F24D5C" height="4.3478" style="stroke:#C82930;stroke-width:0.7246376811594203;" width="4.3478" x="491.3043" y="144.2029"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="64.4928" x="500" y="151.6304">void Resize()</text><!--MD5=[2a8d265d83dfe8250818898780f04a9b]
reverse link Cache to ShardedLRUCache--><path codeLine="69" d="M184.1594,408.1449 C197.8913,441.2174 214.7391,481.8043 229.1159,516.4275 " fill="none" id="Cache-backto-ShardedLRUCache" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><polygon fill="none" points="179.4783,410.1014,178.6014,394.7681,188.8478,406.2101,179.4783,410.1014" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="21.7391" x="219" y="491.4855">实现</text><!--MD5=[bea0b489ad4221683574100f1647557d]
reverse link LRUHandle to LRUCache--><path codeLine="70" d="M439.1087,179.9638 C446.5652,195.529 454.3913,211.8768 462.087,227.9565 " fill="none" id="LRUHandle-backto-LRUCache" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><polygon fill="#A80036" points="435.1232,171.6232,434.386,176.7964,438.8777,179.4665,439.6149,174.2934,435.1232,171.6232" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="21.7391" x="449.5942" y="203.0797">关联</text><!--MD5=[4b071393e28d0addd7a3f66a21a0c35c]
reverse link HandleTable to LRUCache--><path codeLine="71" d="M600.6884,166.9203 C591.4855,186.2681 581.4348,207.3841 571.6014,228.058 " fill="none" id="HandleTable-backto-LRUCache" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><polygon fill="#A80036" points="604.6667,158.5652,600.1815,161.2464,600.9315,166.4178,605.4166,163.7366,604.6667,158.5652" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="21.7391" x="589.1014" y="203.0797">关联</text><!--MD5=[2b85e52f1a88bd0f91255ef2ac035348]
reverse link LRUCache to ShardedLRUCache--><path codeLine="72" d="M390.6014,466.3478 C372.9565,483.3913 355.2681,500.4783 338.8696,516.3261 " fill="none" id="LRUCache-backto-ShardedLRUCache" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><polygon fill="#A80036" points="397.3696,459.8116,392.2296,460.7527,391.1213,465.8592,396.2613,464.9182,397.3696,459.8116" style="stroke:#A80036;stroke-width:0.7246376811594203;"/><text fill="#000000" font-family="Albert Sans" font-size="10.8696" lengthAdjust="spacing" textLength="21.7391" x="374.1377" y="491.4855">关联</text><!--MD5=[1ad313346c53a523e540fa9458e2eb53]
@startuml
skinparam defaultFontName "Albert Sans"
skinparam defaultFontSize 15
scale max 800 width
interface Cache {
+ virtual Handle* Insert(const Slice& key, void* value, ...) = 0
+ virtual Handle* Lookup(const Slice& key) = 0
+ virtual void* Value(Handle* handle) = 0
+ virtual void Release(Handle* handle) = 0
+ virtual void Erase(const Slice& key) = 0
}

class ShardedLRUCache {
- LRUCache shard_[kNumShards]
- port::Mutex id_mutex_
- uint64_t last_id_

+ explicit ShardedLRUCache(size_t capacity)
+ Handle* Insert(const Slice& key, void* value, ...)
+ Handle* Lookup(const Slice& key) override
+ void Release(Handle* handle) override
+ void Erase(const Slice& key) override
+ void* Value(Handle* handle) override
}

class LRUCache {
+ void SetCapacity(size_t capacity)
+ Cache::Handle* Insert(const Slice& key, uint32_t hash, void* value, ...)
+ Cache::Handle* Lookup(const Slice& key, uint32_t hash)
+ void Release(Cache::Handle* handle)
+ void Erase(const Slice& key, uint32_t hash)
+ void Prune()

- void LRU_Remove(LRUHandle* e)
- void LRU_Append(LRUHandle* list, LRUHandle* e)
- void Ref(LRUHandle* e)
- void Unref(LRUHandle* e)
- bool FinishErase(LRUHandle* e)

- LRUHandle lru_
- LRUHandle in_use_
- HandleTable table_
}

class LRUHandle {
+ void* value
+ LRUHandle* next_hash
+ LRUHandle* next
+ LRUHandle* prev
+ size_t key_length
+ bool in_cache
+ uint32_t refs
+ uint32_t hash
+ char key_data[1]
+ Slice key()
}

class HandleTable {
+ LRUHandle* Lookup(const Slice& key, uint32_t hash)
+ LRUHandle* Insert(LRUHandle* h)
+ LRUHandle* Remove(const Slice& key, uint32_t hash)

- uint32_t length_
- uint32_t elems_
- LRUHandle** list_
- LRUHandle** FindPointer(const Slice& key, uint32_t hash)
- void Resize()
}

Cache <|- - ShardedLRUCache: 实现
LRUHandle *- - LRUCache: 关联
HandleTable *- - LRUCache: 关联
LRUCache *- - ShardedLRUCache: 关联
@enduml

PlantUML version 1.2021.12(Wed Oct 06 00:01:58 CST 2021)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg>